``` mermaid
sequenceDiagram
  participant S as ControlServer
  participant W as WebApp
  participant C as ChromeRuntime
  participant E as ExtensionSW
  participant D as ChromeDebugger

  S-->>W: command_stream(SSE_or_WS)
  W->>C: sendMessage(extensionId,ExternalRequest)
  C->>E: onMessageExternal
  E->>D: debugger.attach/sendCommand/detach
  E-->>W: ExternalResponse(ok_or_error)
  E->>S: http_post(telemetry_or_result)
```

``` mermaid
flowchart TB
  subgraph Server[Server Side]
    Orchestrator["Orchestrator (LLM + ç¼–æ’)"]
    SSE["SSE /control/stream"]
    Callback["POST /control/callback"]
    EventSink["POST /control/events"]
  end

  subgraph WebApp[WebApp Bridge]
    Page["webapp.ts + iframe"]
    ES["EventSource"]
  end

  subgraph Extension[Extension Side]
    BG["background.js"]
    CDP["chrome.debugger"]
    EventEmitter["onEvent dispatcher"]
  end

  Orchestrator --> SSE --> ES --> Page
  Page -->|"sendMessage"| BG
  BG --> CDP
  CDP -->|"onEvent"| EventEmitter
  EventEmitter -->|"POST /control/events"| EventSink
  BG -->|"POST /control/callback"| Callback
```

## è½åœ°è®°å½•

- `docs/data-flow/2026-01-05-webapp-bridge-è½åœ°è®°å½•.md`
- `docs/data-flow/2026-01-05-control-run-å¤šæ­¥ç¼–æ’éªŒè¯.md`

## éªŒè¯æ–‡æ¡£

| Phase | æ–‡æ¡£ | çŠ¶æ€ |
|-------|------|------|
| Phase 0 | `verification/phase0-oopif-result.md` | âœ… OOPIF å¯æ“ä½œ |
| Phase 1 | `verification/phase1-tier1-cdp-coverage.md` | ğŸ“ å¾…éªŒè¯ |
| Phase 2 | `verification/phase2-event-subscription.md` | âœ… å®ç°å®Œæˆ |
| Phase 3 | `verification/phase3-session-multiplexer.md` | âœ… å®ç°å®Œæˆ |
| Phase 4 | `verification/phase4-frame-oopif.md` | âœ… ç”± Phase 0 è¦†ç›– |
| Phase 5 | `verification/phase5-stability-wait.md` | âœ… å®ç°å®Œæˆ |
| Phase 6 | `verification/phase6-stagehand-integration.md` | ğŸ“ å¾…éªŒè¯ |

## å…³é”®ç»“è®º

**OOPIF (è·¨åŸŸ iframe) å®Œå…¨å¯æ“ä½œ** - é€šè¿‡ `chrome.debugger` + `Target.setAutoAttach(flatten)` å¯ä»¥ï¼š
1. æ£€æµ‹è·¨åŸŸ iframe å¹¶è·å–å­ sessionId
2. åœ¨å­ session ä¸­æ‰§è¡Œä»»æ„ CDP å‘½ä»¤
3. è·å– iframe å†…çš„ DOM/JS æ‰§è¡Œç»“æœ

è¿™æ„å‘³ç€ Stagehand çš„ Frame/OOPIF ç©¿é€é€»è¾‘å¯åœ¨æ‰©å±•ä¾§å®Œæ•´å¤ç°ã€‚