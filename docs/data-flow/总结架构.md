``` mermaid
sequenceDiagram
  participant S as ControlServer
  participant W as WebApp
  participant C as ChromeRuntime
  participant E as ExtensionSW
  participant D as ChromeDebugger

  S-->>W: command_stream(SSE_or_WS)
  W->>C: sendMessage(extensionId,ExternalRequest)
  C->>E: onMessageExternal
  E->>D: debugger.attach/sendCommand/detach
  E-->>W: ExternalResponse(ok_or_error)
  E->>S: http_post(telemetry_or_result)
```

``` mermaid
flowchart TB
  subgraph Server[Server Side]
    Orchestrator["Orchestrator (LLM + 编排)"]
    SSE["SSE /control/stream"]
    Callback["POST /control/callback"]
    EventSink["POST /control/events"]
  end

  subgraph WebApp[WebApp Bridge]
    Page["webapp.ts + iframe"]
    ES["EventSource"]
  end

  subgraph Extension[Extension Side]
    BG["background.js"]
    CDP["chrome.debugger"]
    EventEmitter["onEvent dispatcher"]
  end

  Orchestrator --> SSE --> ES --> Page
  Page -->|"sendMessage"| BG
  BG --> CDP
  CDP -->|"onEvent"| EventEmitter
  EventEmitter -->|"POST /control/events"| EventSink
  BG -->|"POST /control/callback"| Callback
```

## 落地记录

- `docs/data-flow/2026-01-05-webapp-bridge-落地记录.md`
- `docs/data-flow/2026-01-05-control-run-多步编排验证.md`