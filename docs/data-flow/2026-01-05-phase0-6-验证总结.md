# 2026-01-05 Phase 0-6 éªŒè¯æ€»ç»“

## æ¦‚è¿°

æœ¬æ¬¡éªŒè¯çš„ç›®æ ‡æ˜¯è¯æ˜ï¼š**Stagehand çš„å¤§å¤šæ•°åŠŸèƒ½ï¼ˆé™¤ä¸‹è½½æ§åˆ¶ï¼‰å¯é€šè¿‡ Chrome æ‰©å±• + `chrome.debugger` å®ç°**ã€‚

## éªŒè¯ç»“æœæ€»è§ˆ

| Phase | ç›®æ ‡ | çŠ¶æ€ | å…³é”®ç»“è®º |
|-------|------|------|----------|
| **Phase 0** | OOPIF è°ƒè¯•èƒ½åŠ› | âœ… **å·²éªŒè¯** | è·¨åŸŸ iframe å®Œå…¨å¯æ“ä½œ |
| Phase 1 | CDP æ–¹æ³•è¦†ç›– | ğŸ“ åŸºç¡€è®¾æ–½å°±ç»ª | webapp å·²æœ‰ Round 1-7 æŒ‰é’® |
| Phase 2 | äº‹ä»¶è®¢é˜… | âœ… å®ç°å®Œæˆ | `chrome.debugger.onEvent` å›ä¼ åˆ°æœåŠ¡ç«¯ |
| Phase 3 | sessionId è·¯ç”± | âœ… å®ç°å®Œæˆ | å­ session è‡ªåŠ¨æ³¨å†Œä¸è·¯ç”± |
| Phase 4 | Frame/OOPIF ç©¿é€ | âœ… **å·²éªŒè¯** | ç”± Phase 0 ç»“æœè¦†ç›– |
| Phase 5 | ç­‰å¾…æœºåˆ¶ | âœ… å®ç°å®Œæˆ | `waitForLoad/DomReady/NetworkIdle` |
| Phase 6 | Stagehand é›†æˆ | ğŸ“ åŸºç¡€è®¾æ–½å°±ç»ª | DriverAdapter + act/extract API |

---

## ğŸ‰ æ ¸å¿ƒçªç ´ï¼šOOPIF å®Œå…¨å¯æ“ä½œ

### æµ‹è¯•åœºæ™¯

```html
<!-- ä¸»é¡µé¢ï¼šlocalhost:3000/control/webapp -->
<iframe src="https://example.com"></iframe>  <!-- è·¨åŸŸ iframe -->
```

### éªŒè¯æµç¨‹

1. `Target.setAutoAttach({ flatten: true, keepAttached: true })`
2. æ”¶åˆ° `Target.attachedToTarget` äº‹ä»¶ï¼Œè·å–å­ `sessionId`
3. ç”¨å­ `sessionId` å‘é€ `Runtime.evaluate({ expression: 'document.title' })`
4. **æˆåŠŸè¿”å›** `"Example Domain"`

### éªŒè¯æ—¥å¿—

```json
{
  "method": "Runtime.evaluate",
  "sessionId": "0F0F5C1D0A33B10BACDBD41ABC29E3DE",
  "response": {
    "result": {
      "type": "string",
      "value": "Example Domain"
    }
  }
}
```

### æ„ä¹‰

| èƒ½åŠ› | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æ£€æµ‹è·¨åŸŸ iframe | âœ… | `Target.attachedToTarget` |
| è·å–å­ session ID | âœ… | è‡ªåŠ¨æ³¨å†Œåˆ° sessionRegistry |
| åœ¨ OOPIF ä¸­æ‰§è¡Œå‘½ä»¤ | âœ… | `sessionId` è·¯ç”± |
| è·å– iframe å†… DOM | âœ… | ä»»æ„ CDP å‘½ä»¤ |

**ç»“è®º**ï¼šStagehand çš„ Frame/OOPIF ç©¿é€é€»è¾‘å¯åœ¨æ‰©å±•ä¾§å®Œæ•´å¤ç°ï¼Œ**æ— éœ€é™çº§ç­–ç•¥**ã€‚

---

## æ–°å¢æ–‡ä»¶æ¸…å•

### æœåŠ¡ç«¯ (`server/`)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `routes/control/events.post.ts` | CDP äº‹ä»¶æ¥æ”¶ |
| `routes/control/events.get.ts` | CDP äº‹ä»¶æŸ¥è¯¢ |
| `routes/control/sessions.get.ts` | Session æŸ¥è¯¢ |
| `routes/control/wait.post.ts` | ç­‰å¾… API |
| `routes/control/act.post.ts` | Act API |
| `routes/control/extract.post.ts` | Extract API |
| `utils/control/sessionRegistry.ts` | Session æ³¨å†Œè¡¨ |
| `utils/control/waitHelpers.ts` | ç­‰å¾…å·¥å…·å‡½æ•° |
| `utils/control/driverAdapter.ts` | DriverAdapter ç±» |

### æ‰©å±•ä¾§ (`extension/`)

| æ–‡ä»¶ | å¢å¼ºå†…å®¹ |
|------|----------|
| `background.js` | Session Registry + onEvent å›ä¼  + sessionId è·¯ç”± + keepAttached |

### éªŒè¯æ–‡æ¡£ (`verification/`)

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `phase0-oopif-result.md` | OOPIF éªŒè¯ç»“æœ âœ… |
| `phase1-tier1-cdp-coverage.md` | CDP æ–¹æ³•è¦†ç›–éªŒè¯ |
| `phase2-event-subscription.md` | äº‹ä»¶è®¢é˜…éªŒè¯ |
| `phase3-session-multiplexer.md` | Session è·¯ç”±éªŒè¯ |
| `phase4-frame-oopif.md` | Frame/OOPIF éªŒè¯ |
| `phase5-stability-wait.md` | ç­‰å¾…æœºåˆ¶éªŒè¯ |
| `phase6-stagehand-integration.md` | Stagehand é›†æˆéªŒè¯ |

---

## API ç«¯ç‚¹æ€»è§ˆ

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/control/stream` | GET (SSE) | å‘½ä»¤æµè®¢é˜… |
| `/control/enqueue` | POST | å•å‘½ä»¤ä¸‹å‘ |
| `/control/enqueue-batch` | POST | æ‰¹é‡å‘½ä»¤ä¸‹å‘ |
| `/control/run` | POST | å¤šæ­¥ç¼–æ’æ‰§è¡Œ |
| `/control/callback` | POST | æ‰©å±•å›ä¼ æ¥æ”¶ |
| `/control/events` | GET/POST | CDP äº‹ä»¶æŸ¥è¯¢/æ¥æ”¶ |
| `/control/sessions` | GET | Session æŸ¥è¯¢ |
| `/control/wait` | POST | ç­‰å¾…æ¡ä»¶ |
| `/control/act` | POST | Act æ“ä½œ |
| `/control/extract` | POST | Extract æ“ä½œ |
| `/control/webapp` | GET | ä¸­è½¬é¡µ |

---

## æ¶æ„å›¾

```mermaid
flowchart TB
  subgraph Server[Server Side]
    Orchestrator["Orchestrator (LLM + ç¼–æ’)"]
    SSE["SSE /control/stream"]
    Callback["POST /control/callback"]
    EventSink["POST /control/events"]
    SessionReg["Session Registry"]
    WaitHelpers["Wait Helpers"]
    DriverAdapter["DriverAdapter"]
  end

  subgraph WebApp[WebApp Bridge]
    Page["webapp.ts"]
    ES["EventSource"]
  end

  subgraph Extension[Extension Side]
    BG["background.js"]
    CDP["chrome.debugger"]
    ExtSessionReg["Session Registry (æ‰©å±•ä¾§)"]
  end

  subgraph Target[Target Page]
    MainFrame["Main Frame"]
    IFrame["OOPIF (è·¨åŸŸ iframe)"]
  end

  Orchestrator --> SSE --> ES --> Page
  Page -->|"sendMessage"| BG
  BG --> CDP
  CDP --> MainFrame
  CDP -->|"sessionId è·¯ç”±"| IFrame
  CDP -->|"onEvent"| BG
  BG -->|"POST /control/events"| EventSink
  EventSink --> SessionReg
  BG -->|"POST /control/callback"| Callback
  DriverAdapter --> Orchestrator
  WaitHelpers --> EventSink
```

---

## ä¸‹ä¸€æ­¥å»ºè®®

### å·²å®Œæˆ âœ…

1. ~~OOPIF éªŒè¯~~ â†’ å®Œå…¨å¯æ“ä½œ
2. ~~åŸºç¡€è®¾æ–½æ­å»º~~ â†’ äº‹ä»¶æµã€Session è·¯ç”±ã€ç­‰å¾…æœºåˆ¶
3. ~~DriverAdapter~~ â†’ Stagehand é£æ ¼æ¥å£

### æ¨èç»§ç»­

1. **æ‰¹é‡ CDP éªŒè¯**ï¼ˆå¯é€‰ï¼‰
   - ä½¿ç”¨ webapp çš„ Round 1-7 æŒ‰é’®é€ä¸ªéªŒè¯
   - å¡«å†™ `verification/phase1-tier1-cdp-coverage.md`

2. **LLM é›†æˆ**ï¼ˆæ¨èï¼‰
   - ç§»æ¤ Stagehand çš„ `observeHandler` è·å–é¡µé¢å¯äº¤äº’å…ƒç´ 
   - ç§»æ¤ Stagehand çš„ `actHandler` å®ç° LLM é©±åŠ¨çš„å…ƒç´ å®šä½

3. **å®Œæ•´ Stagehand é€‚é…**
   - åŸºäº DriverAdapter å®ç° Stagehand å…¼å®¹å±‚
   - å¤ç”¨ Stagehand çš„ç¼“å­˜æœºåˆ¶ï¼ˆActCache/AgentCacheï¼‰

---

## æµ‹è¯•æ–¹å¼

### å¿«é€ŸéªŒè¯ OOPIF

1. `pnpm dev` å¯åŠ¨æœåŠ¡
2. åŠ è½½æ‰©å±• (`extension/` ç›®å½•)
3. æ‰“å¼€ `http://localhost:3000/control/webapp`
4. å¡«å†™ extensionIdï¼ŒåŠ è½½ iframe (`https://example.com`)
5. ç‚¹å‡» "Test OOPIF Session (å®Œæ•´æµç¨‹)"
6. è§‚å¯ŸæœåŠ¡ç«¯æ—¥å¿—

### éªŒè¯ act/extract API

```bash
# Extract æµ‹è¯•
curl -X POST http://localhost:3000/control/extract \
  -H "Content-Type: application/json" \
  -d '{"extensionId":"xxx","mode":"expression","expression":"document.title"}'

# Act æµ‹è¯•
curl -X POST http://localhost:3000/control/act \
  -H "Content-Type: application/json" \
  -d '{"extensionId":"xxx","action":"click","x":100,"y":200}'
```

