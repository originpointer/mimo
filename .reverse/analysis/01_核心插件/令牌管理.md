# 令牌管理系统分析

## 文件信息

**文件路径**: `/sources/0.0.47_0/token.js`
**文件大小**: 3.4KB
**压缩状态**: 单行压缩（可读）

## 概述

`token.js` 提供扩展的存储和认证管理功能，包括：
1. 响应式存储抽象层（支持 local/session/sync）
2. 浏览器设置管理
3. 开发分支标志
4. 认证令牌存储
5. 跨上下文实时同步

## 存储枚举

```javascript
var StorageEnum;
(function(StorageEnum) {
  StorageEnum["Local"] = "local"        // chrome.storage.local
  StorageEnum["Session"] = "session"    // chrome.storage.session
  StorageEnum["Sync"] = "sync"          // chrome.storage.sync
})(StorageEnum || {})
```

## 存储访问级别

```javascript
var AccessLevel;
(function(AccessLevel) {
  AccessLevel["ExtensionPagesOnly"] = "TRUSTED_CONTEXTS"
  AccessLevel["ExtensionPagesAndContentScripts"] = "TRUSTED_AND_UNTRUSTED_CONTEXTS"
})(AccessLevel || {})
```

**说明**:
- `ExtensionPagesOnly`: 仅扩展页面可访问（background、popup）
- `ExtensionPagesAndContentScripts`: 包括 content scripts

> **注意 (2026-01-29)**: 原分析中包含 "sidepanel"，但经验证 sidepanel 不存在。实际的 UI 位于 `manus.im` 网站，通过 ManusAppBridge 与扩展通信。详见 [sidepanel实现方式发现报告.md](../../09_重要发现/sidepanel实现方式发现报告.md)。

## 核心函数: createStorage

```javascript
function createStorage(key, defaultValue, options) {
  const storageEnum = options?.storageEnum ?? StorageEnum.Local
  const liveUpdate = options?.liveUpdate ?? false
  const serialize = options?.serialization?.serialize ?? (v => v)
  const deserialize = options?.serialization?.deserialize ?? (v => v)

  let initialized = false
  let currentValue = null
  let listeners = []

  // 获取当前值
  async function get() {
    const data = await chrome.storage[storageEnum].get([key])
    return deserialize(data[key]) ?? defaultValue
  }

  // 设置新值
  async function set(updater) {
    const newValue = await updater(currentValue)
    await chrome.storage[storageEnum].set({
      [key]: serialize(newValue)
    })
    notifyListeners()
  }

  // 获取快照
  function getSnapshot() {
    return currentValue
  }

  // 订阅变更
  function subscribe(listener) {
    listeners = [...listeners, listener]
    return () => {
      listeners = listeners.filter(l => l !== listener)
    }
  }

  // 通知所有监听器
  function notifyListeners() {
    listeners.forEach(fn => fn())
  }

  // 跨上下文同步
  async function handleStorageChange(changes, areaName) {
    if (areaName !== storageEnum) return
    if (changes[key] === undefined) return

    const newValue = deserialize(changes[key].newValue)
    if (currentValue === newValue) return  // 值未变化

    const oldValue = currentValue
    currentValue = await updater(newValue, currentValue)

    logger.info(`[Storage:${key}] onChanged: synced from other context`, {
      old: oldValue,
      new: currentValue
    })
    notifyListeners()
  }

  // 启用实时更新
  if (liveUpdate) {
    chrome.storage.onChanged.addListener(handleStorageChange)
    logger.debug(`[Storage:${key}] liveUpdate enabled`)
  }

  // 初始化
  get().then(value => {
    if (!initialized) {
      currentValue = value
      initialized = true
      logger.info(`[Storage:${key}] initialized`, { value })
      notifyListeners()
    }
  })

  return { get, set, getSnapshot, subscribe }
}
```

## 浏览器设置管理

### 设置结构

```javascript
const ADJECTIVES = [
  "Swift", "Bright", "Quick", "Smart", "Cosmic", "Quantum",
  "Radiant", "Nova", "Stellar", "Aurora", "Turbo", "Lightning",
  "Mighty", "Noble", "Mystic", "Crimson", "Silver", "Golden",
  "Thunder", "Crystal"
]

const NOUNS = [
  "Fox", "Eagle", "Falcon", "Phoenix", "Dragon", "Voyager",
  "Explorer", "Navigator", "Ranger", "Seeker", "Hawk",
  "Wolf", "Tiger", "Panther", "Comet", "Meteor", "Titan",
  "Shadow", "Spirit", "Hunter"
]

function generateBrowserName() {
  const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)]
  const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)]
  return `${adj}-${noun}`  // 例如: "Swift-Fox", "Quantum-Dragon"
}

const DEFAULT_BROWSER_SETTINGS = {
  browserName: generateBrowserName(),    // 随机生成的浏览器名称
  allowCrossBrowser: false,              // 是否允许跨浏览器操作
  skipAuthorization: false               // 是否跳过授权
}
```

### 存储 API

```javascript
const STORAGE_KEY = "manus_extension_browser_settings"
const storage = createStorage(STORAGE_KEY, DEFAULT_BROWSER_SETTINGS, {
  storageEnum: StorageEnum.Local,
  liveUpdate: true
})

export const BrowserSettings = {
  ...storage,
  getBrowserSettings() {
    return storage.getSnapshot() ?? DEFAULT_BROWSER_SETTINGS
  },
  async setBrowserSettings(settings) {
    await storage.set(settings)
  },
  async updateBrowserSettings(updates) {
    const current = storage.getSnapshot() ?? DEFAULT_BROWSER_SETTINGS
    await storage.set({ ...current, ...updates })
  },
  subscribeBrowserSettings(callback) {
    return storage.subscribe(callback)
  }
}
```

## 开发分支管理

```javascript
const DEV_BRANCH_KEY = "manus_extension_dev_branch"
const storage = createStorage(DEV_BRANCH_KEY, null, {
  storageEnum: StorageEnum.Local,
  liveUpdate: true
})

export const DevBranch = {
  ...storage,
  getDevBranch() {
    return storage.getSnapshot()
  },
  async setDevBranch(value) {
    await storage.set(value)
  },
  subscribeDevBranch(callback) {
    return storage.subscribe(callback)
  }
}
```

**用途**: 存储开发分支标志，用于启用实验性功能。

## 认证令牌管理

```javascript
const TOKEN_KEY = "manus_extension_token"
const storage = createStorage(TOKEN_KEY, null, {
  storageEnum: StorageEnum.Local,
  liveUpdate: true
})

export const Token = {
  ...storage,
  getToken() {
    return storage.getSnapshot()
  },
  async setToken(value) {
    await storage.set(value)
  },
  subscribeToken(callback) {
    return storage.subscribe(callback)
  }
}
```

## 版本信息

```javascript
function getExtensionVersion() {
  return chrome.runtime.getManifest().version
}

function getBuildTime() {
  return chrome.runtime.getManifest().custom_meta?.buildTime
}
```

## 数据流图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Chrome Storage (Local)                       │
├─────────────────────────────────────────────────────────────────┤
│  manus_extension_browser_settings  │  manus_extension_token    │
│  manus_extension_dev_branch        │                           │
└───────────────┬─────────────────────────────────┬───────────────┘
                │ onChanged 事件                  │
                │                                 │
    ┌───────────▼──────────┐          ┌──────────▼──────────┐
    │  Background Worker   │          │  manus.im 页面       │
    │  (AuthHelper)        │◄────────►│  (通过 ManusAppBridge)│
    │                      │ 实时同步  │                     │
    └──────────────────────┘          └─────────────────────┘
                │
                │ chrome.storage API
                ▼
    ┌──────────────────────┐
    │   Content Script     │
    │   (如启用访问)       │
    └──────────────────────┘
```

## 关键发现

1. **响应式设计**: 使用订阅模式，存储变更自动通知所有上下文
2. **实时同步**: `liveUpdate` 选项启用后，跨上下文变更自动同步
3. **类型安全**: 支持自定义序列化/反序列化函数
4. **随机命名**: 浏览器名称由随机形容词+名词组成（40×20 = 800 种组合）

## 安全考虑

1. **存储位置**: 使用 `chrome.storage.local`，仅扩展上下文可访问
2. **令牌隔离**: Content Script 默认无法直接访问令牌
3. **访问控制**: Session storage 可限制为仅扩展页面

## 依赖关系

```
token.js
    ├── 导入 sendMessage.js (用于日志)
    └── 被 background.ts.js 导入
        ├── AuthHelper (令牌同步)
        └── SessionManager (设置读取)
```

## 使用示例

```javascript
// 读取浏览器设置
const settings = await BrowserSettings.getBrowserSettings()
console.log(settings.browserName)  // "Swift-Fox"

// 更新设置
await BrowserSettings.updateBrowserSettings({
  allowCrossBrowser: true
})

// 订阅令牌变更
const unsubscribe = Token.subscribeToken((token) => {
  console.log('Token changed:', token)
})

// 设置新令牌
await Token.setToken('new-session-token')

// 取消订阅
unsubscribe()
```
