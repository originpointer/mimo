# 消息传递机制分析

## 文件信息

**文件路径**: `/sources/0.0.47_0/sendMessage.js`
**文件大小**: 2.7KB
**压缩状态**: 单行压缩（可读）

## 概述

`sendMessage.js` 是扩展的核心消息传递基础设施，提供：
1. 环境配置管理（本地/开发/生产）
2. 基于 Promise 的消息发送
3. 消息广播（fire-and-forget）
4. 跨标签页消息传递
5. 日志和性能监控

## 环境配置

### 环境类型

```javascript
const ENV_CONFIG = {
  local: {
    socketEndpoint: "http://localhost:4000",
    webAppDomain: "https://vida.butterfly-effect.dev",
    onboardingUrl: "https://vida.butterfly-effect.dev/my-browser",
    loginUrl: "https://vida.butterfly-effect.dev/login?redirectUrl=...",
    appUrl: "https://vida.butterfly-effect.dev/app",
    startTaskUrl: ".../my-browser?step=new-task",
    securityUrl: ".../my-browser?step=security",
    tutorialUrl: ".../my-browser?step=usage",
    settingsUrl: ".../my-browser?step=settings",
    feedbackUrl: ".../feedback?issueType=CONNECTOR&..."
  },
  dev: {
    socketEndpoint: "wss://vida.butterfly-effect.dev",
    webAppDomain: "https://manus.im"
  },
  prod: {
    socketEndpoint: "wss://api.manus.im",
    webAppDomain: "https://manus.im"
  }
}
```

### 环境检测

```javascript
class Environment {
  getEnv() {
    return "prod"  // 硬编码为生产环境
  }

  isDev() {
    // 仅当 env === "dev" 或 "local" 时返回 true
  }

  isProd() {
    // 当 env === "prod" 时返回 true
  }
}
```

## 核心功能

### 1. 随机 ID 生成

```javascript
function generateRequestId() {
  const CHARS = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
  const ID_LENGTH = 22

  // 使用 crypto.getRandomValues 生成安全的随机 ID
  // 返回如: "aB3xY7zQ9pL2mN4oP6rS8"
}
```

**用途**: 为每条消息生成唯一的请求 ID，用于追踪和调试。

### 2. 日志系统

```javascript
const LOG_PREFIX = "[ManusOperator]"
const LOG_LEVELS = { debug: 10, info: 20, warn: 30, error: 40 }

function Logger(prefix) {
  return {
    debug: (msg, ...args) => { /* 仅开发模式 */ },
    info: (msg, ...args) => { /* 始终输出 */ },
    warn: (msg, ...args) => { /* 始终输出 */ },
    error: (msg, ...args) => { /* 始终输出 */ }
  }
}

const logger = Logger()
```

**特性**:
- 开发模式输出 debug 日志
- 生产模式仅输出 info 及以上级别
- 统一的日志前缀 `[ManusOperator]`

### 3. 消息发送 (Promise-based)

```javascript
async function sendMessage(message, options) {
  const requestId = generateRequestId()
  const messageType = getMessageType(message)
  const startTime = Date.now()

  return new Promise((resolve, reject) => {
    chrome.runtime.sendMessage(message, (response) => {
      if (chrome.runtime.lastError) {
        reject(new Error(chrome.runtime.lastError.message))
        return
      }

      const duration = Date.now() - startTime

      // 慢消息警告 (阈值: 1000ms)
      if (duration > options.slowThreshold) {
        logger.warn(`[Performance] Slow message: ${messageType} took ${duration}ms`)
      }

      resolve(response)
    })
  })
}
```

**配置选项**:
```javascript
{
  silent: false,           // 是否静默模式
  slowThreshold: 1000,     // 慢消息阈值（毫秒）
  logLevel: "debug"        // 日志级别
}
```

### 4. 消息广播 (Fire-and-Forget)

```javascript
function broadcastMessage(message, options) {
  chrome.runtime.sendMessage(message, () => {
    // 忽略连接错误（接收端可能不存在）
    if (chrome.runtime.lastError) {
      const error = chrome.runtime.lastError.message
      if (!error.includes("Could not establish connection") &&
          !error.includes("Receiving end does not exist")) {
        logger.warn(`Broadcast failed:`, error)
      }
    }
  })
}
```

**用途**: 不需要响应的消息，如状态更新、事件通知。

### 5. 跨标签页消息

```javascript
async function sendTabMessage(tabId, message, options) {
  const enhancedMessage = {
    ...message,
    messageTimestamp: Date.now()  // 添加时间戳
  }

  return new Promise((resolve, reject) => {
    chrome.tabs.sendMessage(tabId, enhancedMessage, (response) => {
      if (chrome.runtime.lastError) {
        reject(new Error(chrome.runtime.lastError.message))
        return
      }
      resolve(response)
    })
  })
}
```

**用途**: 后台工作器向特定标签页的 content script 发送消息。

## 消息类型提取

```javascript
function getMessageType(message) {
  if (message && typeof message === 'object' && 'type' in message) {
    return String(message.type)
  }
  return 'unknown'
}
```

## 消息流程图

> **重要说明 (2026-01-28 更新)**: 原分析中显示 "Sidepanel" 但经验证，**实际的 UI 位于 `manus.im` 网站**，通过 `ManusAppBridge` 与扩展通信。详见 [sidepanel实现方式发现报告.md](../../09_重要发现/sidepanel实现方式发现报告.md)。

```
┌──────────────────┐     window.postMessage      ┌──────────────────┐
│  Manus.im (Web)  │ ──────────────────────────> │ ManusAppBridge   │
│   (React UI)     │ <────────────────────────── │  (Content Script)│
└──────────────────┘      postMessage/response   └────────┬─────────┘
                                                              │
                                                              │ chrome.runtime
                                                              │ sendMessage
                                                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Background Worker                           │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │
│  │ManusAppHandler│  │ContentHandler │  │SessionManager │          │
│  └───────────────┘  └───────────────┘  └───────────────┘          │
└───────────────────────────────────────┬─────────────────────────────┘
                                        │
                                        │ chrome.tabs.sendMessage
                                        ▼
                              ┌──────────────────┐
                              │   Content Script │  注入到所有网页
                              │   (通用)          │  处理 DOM 交互
                              └──────────────────┘
```

## 导出的 API

| 导出名称 | 原始名称 | 用途 |
|---------|---------|------|
| `g` | `generateRequestId` | 生成 22 位随机 ID |
| `e` | `Environment` | 环境配置单例 |
| `c` | `Logger` | 日志系统 |
| `l` | `logger` | 全局日志实例 |
| `s` | `sendMessage` | 发送消息（Promise） |
| `a` | `sendTabMessage` | 发送标签页消息 |
| `b` | `broadcastMessage` | 广播消息（无响应） |

## 关键发现

1. **环境硬编码**: 当前版本硬编码为 `prod` 环境，无法通过代码切换
2. **性能监控**: 内置慢消息检测（1000ms 阈值）
3. **错误处理**: 广播消息自动忽略连接错误
4. **时间戳**: 跨标签页消息自动添加 `messageTimestamp`

## 安全考虑

1. **随机 ID**: 使用 `crypto.getRandomValues` 生成安全的请求 ID
2. **日志过滤**: 生产环境不输出 debug 日志，避免泄露敏感信息
3. **错误消息**: 错误处理会过滤掉预期的连接错误

## 依赖关系

```
sendMessage.js (核心)
    ↑
    ├── 被 token.js 导入 (用于日志)
    ├── 被 chromeAsync.js 导入 (用于环境检测)
    ├── 被 manus.js 导入 (用于环境参数)
    └── 被 background.ts.js 导入 (消息发送)
```
