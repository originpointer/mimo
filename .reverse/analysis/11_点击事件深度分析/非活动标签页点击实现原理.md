# Manus 非活动标签页点击实现原理

**分析日期**: 2026-01-29
**更新版本**: 0.0.47
**研究状态**: ✅ 确认

---

## 概述

通过精细的事件监听和日志分析，确认 Manus **无需切换标签页**即可在非活动标签页触发 `isTrusted: true` 的点击事件。

---

## 关键证据

### 完整事件时间线

```
时间轴                事件类型              状态
─────────────────────────────────────────────────────────
03:13:58.706         focus                页面获得焦点
03:13:58.709         blur                 页面失去焦点
03:13:58.710         visibilitychange     visibilityState=hidden
                     ↓
                     [间隔约 31 秒]
                     用户在 manus.im 页面操作
                     ↓
03:14:30.019         focus                页面获得焦点
03:14:30.019         click                点击事件触发
                     visibilityState      仍为 hidden（未触发 visibilitychange）
```

### 关键发现

| 观察 | 预期（如果切换标签页） | 实际日志 | 结论 |
|------|---------------------|----------|------|
| `visibilityState` | 应变为 `visible` | 始终为 `hidden` | ✗ 未切换标签页 |
| `visibilitychange` 事件 | 应该触发 | **全程未触发** | ✗ 未切换标签页 |
| `focus` 事件 | 会触发 | 触发了 | ✓ `window.focus()` |
| `document.hasFocus()` | `true` | `true` | ✓ 文档获得焦点 |
| `isTrusted` | `true` | `true` | ✓ CDP 注入 |

---

## 实现原理

### 正确的实现流程

```
┌─────────────────────────────────────────────────────────────┐
│          Manus 非活动标签页点击实现（无需切换标签页）         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  用户视角：                                                  │
│  ┌───────────────────────────────────────────┐              │
│  │ manus.im 页面始终显示，目标标签页从未激活   │              │
│  └───────────────────────────────────────────┘              │
│                                                             │
│  实际发生：                                                  │
│                                                             │
│  1. manus.im 发送操作指令                                    │
│     ↓                                                       │
│  2. Service Worker 接收指令                                  │
│     ↓                                                       │
│  3. Content Script 调用 window.focus()                      │
│     → 触发 focus 事件                                        │
│     → document.hasFocus() = true                            │
│     → 但标签页未激活，visibilityState 仍为 hidden            │
│     ↓                                                       │
│  4. chrome.debugger.sendCommand(                            │
│       "Input.dispatchMouseEvent", ...)                      │
│     → CDP 直接向非活动标签页发送鼠标事件                      │
│     → 无需激活标签页                                         │
│     → 目标页面触发 onClick                                   │
│     ↓                                                       │
│  5. 操作完成，manus.im 保持在前台                            │
│                                                             │
│  总耗时：~5-10ms（无需标签页切换）                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 技术细节

#### 1. `window.focus()` 的特性

```javascript
// 在 Content Script 中调用
window.focus();

// 结果：
// - ✅ 触发 window 的 focus 事件
// - ✅ document.hasFocus() 返回 true
// - ✅ 元素可以获得焦点并成为 activeElement
// - ❌ 但不会激活标签页（不会触发 visibilitychange）
// - ❌ visibilityState 保持 hidden
```

#### 2. CDP 向非活动标签页发送事件

Chrome DevTools Protocol 的 `Input.dispatchMouseEvent` 命令可以直接向非活动标签页发送鼠标事件，无需激活标签页。

```javascript
// 在 Background Worker 中
await chrome.debugger.sendCommand(
  { tabId: targetTabId },
  "Input.dispatchMouseEvent",
  {
    type: "mousePressed",
    x: elementCoordinates.x,
    y: elementCoordinates.y,
    button: "left",
    clickCount: 1
  }
);

// 此命令可以在目标标签页非活动的情况下执行
```

---

## 为什么 `screenY` 递增？

### 观察数据

| 点击次数 | screenY | 增量 |
|---------|---------|------|
| 1 | 502 | - |
| 2 | 986 | +484 |
| 3 | 1470 | +484 |
| 4 | 1954 | +484 |
| 5 | 2438 | +484 |

### 可能的解释

1. **CDP 内部状态跟踪**: Chrome DevTools Protocol 可能维护一个内部坐标状态，每次调用 `Input.dispatchMouseEvent` 时更新
2. **模拟鼠标移动**: Manus 可能模拟鼠标在屏幕上"移动"到下一个点击位置，即使实际标签页未切换
3. **多显示器坐标计算**: 如果使用多显示器，CDP 可能计算跨显示器的坐标偏移

### 为什么 `screenX` 保持负数 (-755)？

- `screenX` 的负数表明这是一个程序化生成的坐标
- 由于标签页未真正激活，屏幕 X 坐标从未正确初始化
- 每次点击都使用相同的预设值

---

## 与之前分析的区别

| 方面 | 之前分析（错误） | 实际实现（正确） |
|------|----------------|----------------|
| 标签页切换 | 需要 `chrome.tabs.update()` | **不需要** |
| 操作时间 | ~20-50ms | **~5-10ms** |
| visibilityState | 快速切换来不及更新 | **始终保持 hidden** |
| visibilitychange | 应该触发但未捕捉到 | **完全不触发** |
| 核心技术 | 标签页切换 + CDP | **window.focus() + CDP** |

---

## 检测方案更新

### 高置信度检测（不变）

```typescript
// 检测 Manus 特有标记 - 仍然最可靠
if (element.hasAttribute('data-manus_clickable') ||
    element.hasAttribute('data-manus_click_id')) {
  return { isAutomation: true, confidence: 'high' };
}
```

### 中等置信度检测（更新）

```typescript
// 新增检测：visibilityState 保持 hidden 的非活动标签页点击
if (document.visibilityState === 'hidden' &&
    document.hasFocus() &&
    (document.activeElement === element || element.contains(document.activeElement)) &&
    event.isTrusted) {
  return {
    isAutomation: true,
    confidence: 'high',  // 提升置信度
    reason: '非活动标签页产生可信点击事件（CDP特征）'
  };
}

// 负数 screenX + 可信事件
if (event.screenX < 0 && event.isTrusted) {
  return {
    isAutomation: true,
    confidence: 'medium',
    reason: 'screenX 为负数且事件可信'
  };
}
```

---

## 防御建议

### 1. 检测非活动标签页操作

```typescript
const handleButtonClick = (e: React.MouseEvent<HTMLButtonElement>) => {
  // 检测在隐藏标签页中的点击
  if (document.visibilityState === 'hidden' && e.isTrusted) {
    console.warn('检测到可疑操作：非活动标签页中的可信事件');
    // 可能是 CDP 注入
    e.preventDefault();
    return;
  }

  // 其他检测...
};
```

### 2. 监听页面状态变化

```typescript
// 记录页面状态历史
const pageStateHistory: Array<{
  timestamp: number;
  visibilityState: DocumentVisibilityState;
  hasFocus: boolean;
}> = [];

setInterval(() => {
  pageStateHistory.push({
    timestamp: Date.now(),
    visibilityState: document.visibilityState,
    hasFocus: document.hasFocus()
  });
}, 100);

// 在点击事件中检查
const handleButtonClick = (e: React.MouseEvent<HTMLButtonElement>) => {
  const recentStates = pageStateHistory.slice(-5);
  const wasHidden = recentStates.every(s => s.visibilityState === 'hidden');

  if (wasHidden && e.isTrusted) {
    console.warn('检测到可疑操作：页面持续隐藏期间发生可信点击');
  }
};
```

---

## 总结

1. **Manus 不需要切换标签页** - 通过 `window.focus()` 和 CDP 直接在非活动标签页操作
2. **更快的操作速度** - 无标签页切换开销，仅需 ~5-10ms
3. **更隐蔽的操作** - 用户完全察觉不到，`visibilityState` 从不变化
4. **检测特征更明显** - `visibilityState: hidden` + `document.hasFocus(): true` + `isTrusted: true` 的组合在正常情况下不可能出现

---

**相关文档**:
- [主分析报告](../manus-automation-analysis.md)
- [指令传递流程](../10_指令传递流程/指令传递流程分析.md)
