# 权限审计与安全分析

## 文件信息

**Manifest 版本**: V3
**权限审查日期**: 2026-01-28
**扩展版本**: 0.0.47

## Manifest 权限

### 核心权限

```json
{
  "permissions": [
    "tabs",          // 标签页管理
    "tabGroups",     // 标签页分组
    "storage",       // 本地存储
    "debugger",      // Chrome DevTools Protocol
    "cookies",       // Cookie 访问
    "scripting"      // 动态脚本注入
  ],
  "host_permissions": ["<all_urls>"]
}
```

### 权限详细分析

| 权限 | 风险级别 | 用途 | 潜在风险 |
|------|---------|------|---------|
| `tabs` | 中 | 读取标签页信息、更新标签页 | 可访问所有标签页 URL 和标题 |
| `tabGroups` | 低 | 管理标签页组 | 仅影响标签页组织 |
| `storage` | 低 | 存储设置和令牌 | 本地数据访问 |
| `debugger` | **高** | 截图、DOM 操作、页面控制 | 完全控制页面内容和行为 |
| `cookies` | 中 | 读取 manus.im Cookie | 可读取任意域的 Cookie |
| `scripting` | **高** | 注入 Content Script | 可在任意页面执行代码 |
| `<all_urls>` | **高** | 所有网站访问 | 无限制访问所有网页 |

## 风险评估

### 高风险权限

#### 1. debugger 权限

**用途**:
- 使用 Chrome DevTools Protocol (CDP)
- 截取页面截图
- 获取页面布局指标
- 执行 JavaScript 代码

**潜在风险**:
```javascript
// 可以做的事情：
- 读取任意页面的完整 DOM
- 修改页面内容和样式
- 拦截网络请求
- 访问 iframe 内容
- 绕过 CSP (Content Security Policy)
```

**缓解措施**:
- CDP 会话仅在任务执行期间附加
- 60 秒不活跃自动分离
- 所有 CDP 操作记录日志
- 用户可通过状态栏随时停止任务

#### 2. scripting 权限

**用途**:
- 注入 content.ts.js 到所有页面
- 动态注入辅助脚本

**潜在风险**:
```javascript
// 可以做的事情：
- 在任意页面执行任意代码
- 修改页面表单内容
- 窃取用户输入
- 劫持点击事件
```

**缓解措施**:
- Content Script 代码固定（非动态加载）
- 使用类型守卫验证消息来源
- PostMessage 验证域名

#### 3. <all_urls> 主机权限

**用途**:
- 在所有网站注入 Content Script
- 访问所有网站的资源

**潜在风险**:
- 无限制的网站访问
- 可能访问敏感数据

**缓解措施**:
- Content Script 仅处理扩展自己的消息
- 用户可见的视觉反馈（蓝色边框 + 状态栏）
- 用户可随时停止任务

## 数据传输分析

### WebSocket 端点

| 环境 | 端点 | 用途 |
|------|------|------|
| 生产 | `wss://api.manus.im` | 主要 WebSocket 连接 |
| 开发 | `wss://vida.butterfly-effect.dev` | 开发环境 |
| 本地 | `ws://localhost:4000` | 本地开发 |

### HTTP 端点

| 端点 | 用途 |
|------|------|
| `https://manus.im/my-browser` | 扩展设置页面 |
| `https://manus.im/login` | 登录页面 |
| `https://manus.im/app` | 主应用 |
| `https://manus.im/feedback` | 反馈页面 |

### 传输的数据

1. **页面截图**: Base64 编码的图片数据
2. **DOM 内容**: 提取的页面文本内容
3. **交互事件**: 用户点击、输入等操作
4. **标签页信息**: URL、标题、状态
5. **会话数据**: 任务状态、进度信息

### 加密

```javascript
// WebSocket 使用 wss:// (TLS 加密)
wss://api.manus.im

// HTTP API 使用 HTTPS
https://manus.im

// 传输层安全
- TLS 1.2+
- 证书验证
- HSTS (可能)
```

## 认证流程

### Cookie 认证

```
┌─────────────────────────────────────────────────────────────────────┐
│                        用户登录流程                                  │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│              1. 用户在 manus.im 登录                                │
│              2. 后端设置 session_id Cookie                          │
│              - HttpOnly: true (JS 无法访问)                         │
│              - Secure: true (仅 HTTPS)                              │
│              - SameSite: Lax/Strict                                 │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│              3. chrome.cookies.onChanged 事件                       │
│              4. AuthHelper 检测到 Cookie 变更                       │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│              5. Cookie 值同步到 chrome.storage.local                │
│              - 键: manus_extension_token                           │
│              - 值: session_id 的值                                  │
│              - 防抖: 500ms                                          │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│              6. WebSocket 连接时发送令牌                            │
│              7. API 请求时发送令牌                                  │
└─────────────────────────────────────────────────────────────────────┘
```

### 令牌存储

| 属性 | 值 |
|------|-----|
| 存储位置 | `chrome.storage.local` |
| 键名 | `manus_extension_token` |
| 类型 | 字符串 |
| 加密 | ❌ 无（明文） |
| 访问权限 | 扩展上下文（Background, manus.im 页面通过 ManusAppBridge） |
| Content Script 访问 | ❌ 无直接访问 |
| 网页访问 | ❌ 无 |

### 令牌生命周期

1. **创建**: 用户登录时由 Manus 后端创建
2. **同步**: Cookie 变更时同步到扩展存储
3. **使用**: WebSocket 和 API 请求时作为认证
4. **过期**: 由后端控制（Cookie 过期时间）
5. **删除**: 用户登出时 Cookie 被删除

## 域名验证

### ManusAppBridge 验证

```javascript
function isManusAppOrigin(origin) {
  const { webAppDomain } = Environment.getEnvParams()

  // 1. 检查主域名
  if (origin === webAppDomain) return true

  // 2. 开发模式：允许本地主机
  if (Environment.isDev()) {
    try {
      const url = new URL(origin)
      const isLocalhost =
        url.hostname === "localhost" ||
        url.hostname === "127.0.0.1" ||
        url.hostname === "::1"

      if (url.protocol === "http:" && isLocalhost) {
        return true
      }
    } catch {
      return false
    }
  }

  return false
}
```

### PostMessage 验证

```javascript
window.addEventListener("message", async (event) => {
  // 1. 拒绝 iframe 消息
  if (event.source !== window) return

  // 2. 验证域名
  if (!isManusAppOrigin(event.origin)) {
    console.warn("Untrusted origin:", event.origin)
    return
  }

  // 3. 验证消息来源
  if (event.data?.source !== "manus-app") return

  // 处理消息...
})
```

## 潜在安全风险

### 1. 令牌明文存储

**风险**: chrome.storage.local 可被用户或其他扩展访问（在有权限的情况下）

**缓解**:
- Content Script 无法访问
- 令牌存储在隔离的扩展命名空间

### 2. debugger 权限过于强大

**风险**: 理论上可访问页面所有内容

**缓解**:
- 仅在任务执行期间附加调试器
- 提供可见的视觉反馈
- 用户可随时停止

### 3. WebSocket 连接可被中间人攻击

**风险**: 如果 TLS 配置不当，可能被拦截

**缓解**:
- 使用 wss:// (强制 TLS)
- 证书验证

### 4. 开发模式允许 localhost

**风险**: 如果用户在开发模式运行，可能允许伪造的本地连接

**缓解**:
- 生产模式硬编码为 "prod"
- localhost 仅在开发环境

## 隐私考虑

### 收集的数据

1. **页面 URL**: 用于任务跟踪
2. **页面标题**: 用于标签页管理
3. **页面截图**: 发送到 AI 分析
4. **页面文本内容**: 提取的 Markdown
5. **交互元素**: 按钮、链接等
6. **用户操作**: 点击、输入等

### 不收集的数据

1. **密码**: 不读取密码字段
2. **Cookie**: 不发送完整 Cookie（仅同步 session_id）
3. **历史记录**: 不访问浏览器历史
4. **下载文件**: 不访问下载内容

### 数据去向

| 数据类型 | 存储位置 | 是否发送到服务器 |
|---------|---------|----------------|
| 令牌 | chrome.storage.local | ❌ 仅用作认证 |
| 截图 | 内存（临时） | ✅ 发送到 Manus API |
| 页面内容 | 内存（临时） | ✅ 发送到 Manus API |
| 浏览器设置 | chrome.storage.local | ❌ 本地存储 |

## 合规性

### GDPR 考虑

- ✅ 用户明确授权安装扩展
- ✅ 用户可随时卸载
- ⚠️ 需要隐私政策说明数据收集

### CCPA 考虑

- ✅ 用户可选择不使用
- ✅ 用户可删除扩展数据（卸载）

## 建议改进

1. **令牌加密**: 考虑使用 chrome.crypto API 加密存储令牌
2. **权限最小化**: 评估是否可以减少某些权限的使用范围
3. **审计日志**: 记录所有敏感操作的审计日志
4. **隐私政策**: 提供清晰的隐私政策说明数据收集和使用
5. **用户控制**: 提供更细粒度的用户控制选项

## 总结

**整体安全评级**: ⚠️ 中等风险

**主要风险**:
1. debugger 权限过于强大
2. 令牌明文存储
3. 广泛的主机权限

**缓解措施**:
1. 用户可见的视觉反馈
2. 随时可停止的任务
3. 域名验证和类型守卫
4. 详细的日志记录

**建议**:
- 扩展适用于自愿使用、明确授权的场景
- 不适合在敏感环境（如银行、医疗）使用
- 用户应了解扩展的功能和权限
