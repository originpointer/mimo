# åå°å·¥ä½œå™¨æ¶æ„åˆ†æ

## æ–‡ä»¶ä¿¡æ¯

**æ–‡ä»¶è·¯å¾„**: `/sources/0.0.47_0/background.ts.js`
**æ–‡ä»¶å¤§å°**: 163KBï¼ˆå‹ç¼©åï¼‰
**ç¾åŒ–å**: 6813 è¡Œ
**ç±»å‹**: TypeScript ç¼–è¯‘ä¸º JavaScript (ES6 æ¨¡å—)

## æ¦‚è¿°

`background.ts.js` æ˜¯æ‰©å±•çš„ Service Workerï¼Œä½œä¸ºæ ¸å¿ƒåè°ƒå™¨å¤„ç†æ‰€æœ‰æ‰©å±•é€»è¾‘ã€‚å®ƒåè°ƒä»¥ä¸‹ç»„ä»¶ï¼š
- è®¤è¯ç®¡ç†ï¼ˆCookie åŒæ­¥ï¼‰
- Chrome DevTools Protocol (CDP) å®¢æˆ·ç«¯
- ä¼šè¯ç®¡ç†
- æ ‡ç­¾é¡µå’Œæ ‡ç­¾é¡µç»„ç®¡ç†
- ä¸ Manus åº”ç”¨ã€Content Script å’Œ UI çš„æ¶ˆæ¯å¤„ç†

## ä¸»è¦ç±»æ¶æ„

```
background.ts.js
â”œâ”€â”€ AuthHelper (mn)              - Cookie è®¤è¯åŒæ­¥
â”œâ”€â”€ CdpClient (å‡½æ•°é›†åˆ)         - Chrome DevTools Protocol
â”œâ”€â”€ ContentHandler (Bn)          - Content Script æ¶ˆæ¯
â”œâ”€â”€ ManusAppHandler (Fn)         - Manus åº”ç”¨æ¶ˆæ¯
â”œâ”€â”€ PopupHandler (Re)            - Popup UI æ¶ˆæ¯
â”œâ”€â”€ SessionManager (Vn)          - ä»»åŠ¡ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
â”œâ”€â”€ TabManager (Yn)              - æ ‡ç­¾é¡µç»„ç®¡ç†
â”œâ”€â”€ WebSocketClient (ms)         - WebSocket è¿æ¥
â”œâ”€â”€ ScenarioRunner (bs)          - è‡ªåŠ¨åŒ–åœºæ™¯æ‰§è¡Œ
â”œâ”€â”€ ElementHelper (U)            - DOM å…ƒç´ è¾…åŠ©
â”œâ”€â”€ ActionExecutor (Es)          - æµè§ˆå™¨æ“ä½œæ‰§è¡Œ
â””â”€â”€ ... (æ›´å¤šè¾…åŠ©ç±»)
```

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. AuthHelper (è®¤è¯åŠ©æ‰‹)

**ç±»å**: `mn` (å‹ç¼©å)
**è¡Œå·**: 59-195

**èŒè´£**:
- ç›‘å¬ manus.im åŸŸåçš„ Cookie å˜åŒ–
- å°† Cookie åŒæ­¥åˆ° chrome.storage.local
- ç®¡ç†æµè§ˆå™¨è®¾ç½®

**å…³é”®æ–¹æ³•**:
```javascript
class AuthHelper {
  constructor() {
    this.cleanupWatcher = null
    this.debounceTimers = new Map
  }

  async initialize() {
    // 1. ç¡®ä¿æµè§ˆå™¨è®¾ç½®å­˜åœ¨
    const settings = BrowserSettings.getBrowserSettings()
    if (!settings?.browserName) {
      await BrowserSettings.setBrowserSettings(DEFAULT_SETTINGS)
    }

    // 2. è¯»å–å½“å‰ Cookie
    const cookies = await this.getManusAppCookies()

    // 3. åŒæ­¥åˆ°å­˜å‚¨
    if (cookies.token) await Token.setToken(cookies.token)
    if (cookies.devBranch) await DevBranch.setDevBranch(cookies.devBranch)
  }

  startWatcher() {
    // ç›‘å¬ chrome.cookies.onChanged
    // åŸŸåéªŒè¯
    // 500ms é˜²æŠ–åŒæ­¥
  }
}
```

**ç›‘å¬çš„ Cookie**:
| Cookie åç§° | ç”¨é€” | å­˜å‚¨é”® |
|------------|------|--------|
| `session_id` | è®¤è¯ä»¤ç‰Œ | `manus_extension_token` |
| `devBranch` | å¼€å‘åˆ†æ”¯æ ‡å¿— | `manus_extension_dev_branch` |

### 2. CdpClient (Chrome DevTools Protocol å®¢æˆ·ç«¯)

**å‡½æ•°é›†åˆ**: è¡Œå· 197-600+

**å¸¸é‡**:
```javascript
const CDP_VERSION = "1.3"
const SESSION_TIMEOUT = 60000  // 60 ç§’ä¸æ´»è·ƒè¶…æ—¶
const DEFAULT_WIDTH = 1920
const DEFAULT_HEIGHT = 1080
```

**æ ¸å¿ƒåŠŸèƒ½**:

#### ä¼šè¯ç®¡ç†
```javascript
// æŒä¹…åŒ– CDP ä¼šè¯ç¼“å­˜
const cdpSessions = new Map()  // tabId -> { target, session, viewport, lastUsed }

// è·å–æˆ–åˆ›å»º CDP ä¼šè¯
async function getOrCreateSession(tabId) {
  let session = cdpSessions.get(tabId)

  if (session) {
    session.lastUsed = Date.now()
    resetDetachTimer(tabId, session)
    return session
  }

  // åˆ›å»ºæ–°ä¼šè¯
  const target = await attachDebugger(tabId)
  const session = createCDPSession(target)
  await session.send("Page.enable")
  const viewport = await initViewport(session)

  session = { target, session, viewport, lastUsed: Date.now() }
  cdpSessions.set(tabId, session)

  return session
}
```

#### æˆªå›¾åŠŸèƒ½
```javascript
async function captureScreenshot(cdpSession, viewport, options) {
  const {
    format = "png",
    quality,
    useOriginalResolution = false
  } = options

  // è·å–é¡µé¢å¸ƒå±€æŒ‡æ ‡
  const metrics = await cdpSession.send("Page.getLayoutMetrics")

  // è®¡ç®—è£å‰ªåŒºåŸŸ
  const clip = {
    x: visualViewport.pageX,
    y: visualViewport.pageY,
    width: Math.min(cssWidth, contentWidth),
    height: Math.min(cssHeight, contentHeight),
    scale: 1 / devicePixelRatio
  }

  // æ•è·æˆªå›¾
  const { data } = await cdpSession.send("Page.captureScreenshot", {
    format,
    quality,
    fromSurface: true,
    clip
  })

  // å¯é€‰ï¼šè°ƒæ•´å›¾ç‰‡å¤§å°
  if (!useOriginalResolution) {
    return await resizeImage(data, clip.width, clip.height)
  }

  return { dataUrl: `data:image/${format};base64,${data}` }
}
```

#### é‡è¯•æœºåˆ¶
```javascript
async function executeWithRetry(tabId, handler, options) {
  let session = await getOrCreateSession(tabId)
  const MAX_RETRIES = 2

  for (let attempt = 0; attempt <= MAX_RETRIES; attempt++) {
    try {
      const viewport = options?.refreshViewport
        ? await refreshViewport(session.session, session.viewport)
        : session.viewport

      return await handler(session.session, viewport)
    } catch (error) {
      // æ¸…ç†å¹¶é‡è¯•
      await detachSession(session.target)
      cdpSessions.delete(tabId)

      if (attempt > MAX_RETRIES) throw error

      // ç­‰å¾…åé‡è¯•
      await sleep(isDebuggingError(error) ? 1000 : 500)
      session = await getOrCreateSession(tabId)
    }
  }
}
```

### 3. SessionManager (ä¼šè¯ç®¡ç†å™¨)

**ç±»å**: `Vn`
**è¡Œå·**: 1034-1116

**èŒè´£**:
- ç®¡ç†ä»»åŠ¡ä¼šè¯ç”Ÿå‘½å‘¨æœŸ
- å…³è”ä¼šè¯ä¸æ ‡ç­¾é¡µ/æ ‡ç­¾é¡µç»„
- å¤„ç†ä¼šè¯çŠ¶æ€ï¼ˆrunning, stopped, takeover, errorï¼‰

**ä¼šè¯çŠ¶æ€**:
```javascript
{
  sessionId: string,           // ä¼šè¯ ID
  tabId: number,               // ä¸»æ ‡ç­¾é¡µ ID
  groupId?: number,            // æ ‡ç­¾é¡µç»„ ID
  windowId: number,            // çª—å£ ID
  status: "stopped" | "running" | "takeover" | "error",
  taskName?: string,           // ä»»åŠ¡åç§°
  animationInterval?: number,  // emoji åŠ¨ç”»å®šæ—¶å™¨
  queue: Promise<>,            // æ“ä½œé˜Ÿåˆ—
  disposed: boolean            // æ˜¯å¦å·²é‡Šæ”¾
}
```

**å…³é”®æ–¹æ³•**:
```javascript
class SessionManager {
  // åˆ›å»ºæ–°ä¼šè¯
  async startSession(tabId, options) {
    const sessionId = generateId()

    // åˆ›å»ºæ ‡ç­¾é¡µç»„
    const groupId = await TabManager.createTaskGroup(tabId, options.taskName)

    // åˆå§‹åŒ–ä¼šè¯
    const session = {
      sessionId,
      tabId,
      groupId,
      windowId: (await chrome.tabs.get(tabId)).windowId,
      status: "running",
      taskName: options.taskName,
      queue: Promise.resolve(),
      disposed: false
    }

    this.sessions.set(sessionId, session)

    // å¼€å§‹ emoji åŠ¨ç”»
    TabManager.startTaskOngoingAnimation(session, options.taskName)

    return session
  }

  // åœæ­¢ä¼šè¯
  async stopSession(sessionId) {
    const session = this.sessions.get(sessionId)
    if (!session) return

    // åœæ­¢åŠ¨ç”»
    if (session.animationInterval) {
      clearInterval(session.animationInterval)
    }

    // æ›´æ–°æ ‡ç­¾é¡µç»„æ ‡é¢˜
    await TabManager.markTaskCompleted(session)

    // ç§»é™¤ä¼šè¯
    this.sessions.delete(sessionId)
    session.disposed = true
  }
}
```

### 4. TabManager (æ ‡ç­¾é¡µç®¡ç†å™¨)

**ç±»å**: `Yn`
**è¡Œå·**: 1117-1460

**èŒè´£**:
- ç®¡ç†æ ‡ç­¾é¡µç»„
- å¤„ç†ä»»åŠ¡åŠ¨ç”»
- æ ‡ç­¾é¡µç”Ÿå‘½å‘¨æœŸç®¡ç†

**Emoji åŠ¨ç”»**:
```javascript
const EMOJIS = [
  "ğŸ‘†","ğŸ–ï¸","ğŸ‘‹","ğŸ‘","ğŸ––","ğŸ«°","âœŒ","ğŸ¤š","ğŸ¤Ÿ","ğŸ‘‰","ğŸ¤","ğŸ‘‡","â˜","ğŸ¤™","ğŸ‘ˆ","âœŠ","ğŸ¤˜"
]
const ANIMATION_INTERVAL = 1000  // 1 ç§’

startTaskOngoingAnimation(session, taskName) {
  let index = 0
  const animate = async () => {
    const emoji = EMOJIS[index]
    await TabManager.updateTitle(session, `${emoji} ${taskName}`)
    index = (index + 1) % EMOJIS.length
  }

  animate()  // ç«‹å³æ‰§è¡Œ
  session.animationInterval = setInterval(animate, ANIMATION_INTERVAL)
}
```

**æ ‡ç­¾é¡µç»„æ“ä½œ**:
```javascript
async function createTaskGroup(tabId, taskName) {
  // æ£€æŸ¥æ˜¯å¦æ”¯æŒæ ‡ç­¾é¡µç»„
  if (!chrome.tabGroups) {
    return null
  }

  // åˆ›å»ºç»„
  const groupId = await chrome.tabs.group({
    tabIds: [tabId]
  })

  // è®¾ç½®æ ‡é¢˜å’Œé¢œè‰²
  await chrome.tabGroups.update(groupId, {
    title: `ğŸ‘† ${taskName}`,
    color: "blue"
  })

  return groupId
}

markTaskCompleted(session) {
  const title = `âœ… ${session.taskName || 'Task'}`
  if (session.groupId) {
    await chrome.tabGroups.update(session.groupId, { title })
  } else {
    await chrome.tabs.update(session.tabId, { title })
  }
}
```

### 5. ContentHandler (Content Script æ¶ˆæ¯å¤„ç†å™¨)

**ç±»å**: `Bn`
**è¡Œå·**: 554-602

**å¤„ç†çš„æ¶ˆæ¯ç±»å‹**:
```javascript
switch (message.type) {
  case "content/heartbeat":
    // å¿ƒè·³æ£€æµ‹
  case "content/get-session-state":
    // è·å–å½“å‰ä¼šè¯çŠ¶æ€
  case "extension/stop-task":
    // åœæ­¢å½“å‰ä»»åŠ¡
  case "extension/unauthorize-task":
    // ç”¨æˆ·æ¥ç®¡
  case "extension/resume-task":
    // æ¢å¤ä»»åŠ¡
}
```

### 6. ManusAppHandler (Manus åº”ç”¨æ¶ˆæ¯å¤„ç†å™¨)

**ç±»å**: `Fn`
**è¡Œå·**: 604-716

**å¤„ç†çš„æ¶ˆæ¯ç±»å‹**:
```javascript
switch (message.type) {
  case "my-browser/ping":
    // è¿æ¥æ£€æµ‹
  case "my-browser/switch-to-tab":
    // åˆ‡æ¢åˆ°æŒ‡å®šæ ‡ç­¾é¡µ
  case "my-browser/set-browser-settings":
    // æ›´æ–°æµè§ˆå™¨è®¾ç½®
}
```

### 7. PopupHandler (Popup UI æ¶ˆæ¯å¤„ç†å™¨)

**ç±»å**: `Re`
**è¡Œå·**: 718-1032

**å¤„ç†çš„æ¶ˆæ¯ç±»å‹**:
```javascript
switch (message.type) {
  case "popup/get-tab-status":
    // è¿”å›å½“å‰æ ‡ç­¾çŠ¶æ€
  case "extension/unauthorize-task":
    // åœæ­¢ä»»åŠ¡æŒ‰é’®
}
```

## æ¶ˆæ¯ç±»å‹æ±‡æ€»

> **é‡è¦è¯´æ˜ (2026-01-28 æ›´æ–°)**: åŸåˆ†æä¸­è®¤ä¸ºå­˜åœ¨ "sidepanel" æ¶ˆæ¯æ¥æºï¼Œä½†ç»éªŒè¯ï¼Œ**"sidepanel" æ¶ˆæ¯æ¥æºæœªè¢«å®é™…ä½¿ç”¨**ã€‚å®é™…çš„ UI ç•Œé¢ä½äº `manus.im` ç½‘ç«™ï¼Œé€šè¿‡ `"manus-app"` æ¶ˆæ¯æ¥æºä¸æ‰©å±•é€šä¿¡ã€‚è¯¦è§ [sidepanelå®ç°æ–¹å¼å‘ç°æŠ¥å‘Š.md](../09_é‡è¦å‘ç°/sidepanelå®ç°æ–¹å¼å‘ç°æŠ¥å‘Š.md)ã€‚

### æ¥è‡ª Manus App (manus.im)
| æ¶ˆæ¯ç±»å‹ | ç”¨é€” |
|---------|------|
| `session/start` | å¼€å§‹æ–°ä¼šè¯ |
| `session/stop` | åœæ­¢ä¼šè¯ |
| `automation/run-scenario` | è¿è¡Œè‡ªåŠ¨åŒ–åœºæ™¯ |
| `automation/stop-scenario` | åœæ­¢åœºæ™¯ |
| `automation/activate` | æ¿€æ´»è‡ªåŠ¨åŒ– |
| `automation/trigger-browser-action` | è§¦å‘æµè§ˆå™¨æ“ä½œ |
| `my-browser/ping` | è¿æ¥æ£€æµ‹ |
| `my-browser/switch-to-tab` | åˆ‡æ¢æ ‡ç­¾é¡µ |
| `my-browser/set-browser-settings` | è®¾ç½®æ›´æ–° |

### æ¥è‡ª Content Script
| æ¶ˆæ¯ç±»å‹ | ç”¨é€” |
|---------|------|
| `content/heartbeat` | å¿ƒè·³æ£€æµ‹ |
| `content/get-session-state` | è·å–ä¼šè¯çŠ¶æ€ |
| `automation/event-log` | äº‹ä»¶æ—¥å¿— |
| `automation/progress` | è¿›åº¦æ›´æ–° |
| `automation/summary` | æ“ä½œæ‘˜è¦ |

### å‘é€åˆ° Content Script
| æ¶ˆæ¯ç±»å‹ | ç”¨é€” |
|---------|------|
| `automation/click` | ç‚¹å‡»å…ƒç´  |
| `automation/type` | è¾“å…¥æ–‡æœ¬ |
| `automation/scroll` | æ»šåŠ¨é¡µé¢ |
| `automation/screenshot` | è·å–æˆªå›¾ |
| `page/check-ready` | æ£€æŸ¥é¡µé¢å°±ç»ª |
| `page/event-block` | äº‹ä»¶é˜»å¡ |

## å¯¼å…¥ä¾èµ–

```javascript
// æ ¸å¿ƒæ’ä»¶
import { Logger, Environment, sendMessage } from "./sendMessage.js"
import { createStorage, BrowserSettings, Token } from "./token.js"
import { isManusAppOrigin } from "./manus.js"
import {
  createTab,
  updateTab,
  getTab,
  groupTabs,
  updateTabGroup,
  getPageDimensions
} from "./chromeAsync.js"
import {
  // isSidepanelMessage,  // âŒ æœªè¢«ä½¿ç”¨
  isContentMessage,
  isManusAppMessage,
  isPopupMessage
} from "./typeGuards.js"

// å·¥å…·å‡½æ•°
import {
  sleep,
  generateId,
  debounce,
  retry
} from "./helper.js"
```

## æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     window.postMessage    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Manus.im (Web)  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ ManusAppBridgeâ”‚
â”‚   (React UI)     â”‚    (ManusAppBridge)     â”‚   (Content)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                                  â”‚ chrome.runtime
                                                  â”‚ sendMessage
                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Background Worker                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  AuthHelper   â”‚  â”‚ SessionMgr    â”‚  â”‚  CdpClient    â”‚       â”‚
â”‚  â”‚  (CookieåŒæ­¥) â”‚  â”‚  (ä¼šè¯ç®¡ç†)   â”‚  â”‚  (æˆªå›¾/è°ƒè¯•)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
            chrome.tabs.sendMessage   â”‚
            chrome.debugger.sendCommandâ”‚
                                â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ Content Scriptâ”‚
                      â”‚  (æ³¨å…¥é¡µé¢)   â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®å‘ç°

1. **MobX çŠ¶æ€ç®¡ç†**: SessionManager ä½¿ç”¨ MobX è£…é¥°å™¨è¿›è¡Œå“åº”å¼çŠ¶æ€ç®¡ç†
2. **CDP æŒä¹…åŒ–**: CDP ä¼šè¯ç¼“å­˜ 60 ç§’ï¼Œé¿å…é¢‘ç¹é™„åŠ /åˆ†ç¦»è°ƒè¯•å™¨
3. **é‡è¯•æœºåˆ¶**: CDP æ“ä½œå¤±è´¥åè‡ªåŠ¨é‡è¯•æœ€å¤š 3 æ¬¡
4. **é˜²æŠ–åŒæ­¥**: Cookie å˜æ›´ä½¿ç”¨ 500ms é˜²æŠ–ï¼Œé¿å…è¿‡åº¦å†™å…¥
5. **é˜Ÿåˆ—ç³»ç»Ÿ**: æ¯ä¸ªä¼šè¯æœ‰æ“ä½œé˜Ÿåˆ—ï¼Œç¡®ä¿æ“ä½œé¡ºåºæ‰§è¡Œ
6. **Emoji åŠ¨ç”»**: ä»»åŠ¡è¿›è¡Œæ—¶æ˜¾ç¤ºåŠ¨æ€ emojiï¼Œå®Œæˆåæ˜¾ç¤º âœ…

## æ€§èƒ½ç‰¹æ€§

1. **æ…¢æŸ¥è¯¢è­¦å‘Š**: æ¶ˆæ¯å¤„ç†è¶…è¿‡ 1000ms è®°å½•è­¦å‘Š
2. **ä¼šè¯è¶…æ—¶**: CDP ä¼šè¯ 60 ç§’ä¸æ´»è·ƒè‡ªåŠ¨åˆ†ç¦»
3. **å¹¶å‘é™åˆ¶**: åŒä¸€æ ‡ç­¾é¡µçš„ CDP æ“ä½œä¸²è¡ŒåŒ–
4. **ç¼“å­˜ç­–ç•¥**: Viewport ä¿¡æ¯ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
