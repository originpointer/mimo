# 消息类型分类

## 概述

本文档列出了 Manus AI Browser Extension 中所有使用的消息类型。消息是扩展各组件之间通信的主要方式。

> **重要说明 (2026-01-28 更新)**: 原分析中认为存在 "sidepanel" 消息来源，但经验证，**"sidepanel" 消息来源未被实际使用**。实际的 UI 界面位于 `manus.im` 网站，通过 `"manus-app"` 消息来源与扩展通信。详见 [sidepanel实现方式发现报告.md](../09_重要发现/sidepanel实现方式发现报告.md)。

## 消息结构

```javascript
{
  source: "content" | "popup" | "background" | "manus-app",
  type: string,              // 消息类型
  data?: any,                // 可选数据载荷
  requestId?: string,        // 可选请求 ID
  messageTimestamp?: number  // 可选时间戳
}
```

## 消息源 (Source)

| Source | 发送者 | 描述 |
|--------|--------|------|
| ~~`sidepanel`~~ | ~~侧边栏 UI~~ | ❌ 未被使用 (历史遗留标识符) |
| `manus-app` | Manus Web App | ✅ https://manus.im 网页应用 (主用户界面) |
| `content` | Content Script | 注入所有网页，处理 DOM 交互 |
| `popup` | Popup UI | 点击扩展图标的弹出窗口 |
| `background` | Service Worker | 后台服务工作器 |

## 消息类型汇总

### 会话管理 (Session Management)

#### 来自 Manus App (manus.im)

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `session/start` | `{ tabId, taskName, options }` | 开始新任务会话 |
| `session/stop` | `{ sessionId }` | 停止会话 |
| `session/status` | `{ sessionId }` | 获取会话状态 |

#### 响应消息

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `session/started` | `{ sessionId, tabId, groupId }` | 会话创建成功 |
| `session/stopped` | `{ sessionId }` | 会话已停止 |
| `session/status` | `{ sessionId, status, taskName }` | 会话状态更新 |

### 自动化操作 (Automation)

#### 来自 Manus App (manus.im)

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `automation/run-scenario` | `{ scenario, sessionId }` | 运行自动化场景 |
| `automation/stop-scenario` | `{ scenarioId }` | 停止场景 |
| `automation/activate` | `{ sessionId }` | 激活自动化模式 |
| `automation/trigger-browser-action` | `{ action, params }` | 触发浏览器操作 |

#### 来自 Content Script

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `automation/event-log` | `{ event, data }` | 事件日志 |
| `automation/progress` | `{ progress, total }` | 进度更新 |
| `automation/summary` | `{ summary }` | 操作摘要 |
| `automation/result` | `{ ok, data, error }` | 操作结果 |

### 浏览器操作 (Browser Actions)

#### 发送到 Content Script

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `automation/click` | `{ strategy, selector/index/coordinates, options }` | 点击元素 |
| `automation/type` | `{ target, text, options }` | 输入文本 |
| `automation/scroll` | `{ target, direction, amount }` | 滚动页面 |
| `automation/screenshot` | `{ options }` | 获取截图 |
| `automation/press_key` | `{ key, modifiers }` | 按键 |
| `automation/move_mouse` | `{ x, y }` | 移动鼠标 |

#### 操作策略 (Element Strategies)

| 策略 | 描述 | 示例 |
|------|------|------|
| `bySelector` | 使用 CSS/XPath 选择器 | `{ strategy: "bySelector", selector: "button.submit" }` |
| `byIndex` | 使用预分配的索引 | `{ strategy: "byIndex", index: 42 }` |
| `byCoordinates` | 使用视口坐标 | `{ strategy: "byCoordinates", x: 100, y: 200 }` |

### 页面交互 (Page Interaction)

#### 发送到 Content Script

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `page/check-ready` | `{ }` | 检查页面是否就绪 |
| `page/event-block` | `{ enabled, events }` | 阻塞/解阻塞事件 |
| `page/toggle-page-effect` | `{ effect, enabled }` | 切换页面效果 |

#### 来自 Content Script

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `content/heartbeat` | `{ }` | 心跳检测 |
| `content/get-session-state` | `{ }` | 获取当前会话状态 |
| `page/ready-state` | `{ ready, reason }` | 页面就绪状态 |
| `page/dom-content-loaded` | `{ }` | DOM 内容加载完成 |

### 用户干预 (User Intervention)

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `extension/stop-task` | `{ sessionId }` | 停止任务 |
| `extension/unauthorize-task` | `{ sessionId, summary }` | 用户接管任务 |
| `extension/resume-task` | `{ sessionId, summary }` | 用户释放后恢复任务 |

### Manus 应用通信 (My Browser)

#### 来自 Manus App

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `my-browser/ping` | `{ }` | 连接检测 |
| `my-browser/switch-to-tab` | `{ tabId }` | 切换到指定标签页 |
| `my-browser/set-browser-settings` | `{ settings }` | 更新浏览器设置 |

#### 发送到 Manus App

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `extension/ready` | `{ browserId, settings }` | 扩展就绪 |
| `extension/take-over-summary` | `{ sessionId, summary }` | 任务接管摘要 |
| `extension_stop_session` | `{ sessionId, reason }` | 会话停止通知 |
| `extension/tab-status-update` | `{ tabId, status }` | 标签页状态更新 |

### Popup UI

#### 来自 Popup

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `popup/get-tab-status` | `{ }` | 获取当前标签状态 |

#### 响应

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `popup/tab-status-update` | `{ sessionId, status, taskName }` | 标签状态更新 |

### WebSocket 通信

#### 发送到 WebSocket 服务器

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `browser_action` | `{ action, params, sessionId }` | 浏览器操作请求 |
| `session_status` | `{ sessionId, status }` | 会话状态更新 |
| `my_browser_extension_connected` | `{ browserId, version }` | 扩展连接通知 |

#### 来自 WebSocket 服务器

| 消息类型 | 数据 | 描述 |
|---------|------|------|
| `browser_action` | `{ action, params, actionId }` | 执行浏览器操作 |
| `session_status` | `{ status, message }` | 服务器会话状态 |
| `ping` | `{ }` | 心跳检测 |
| `error` | `{ error, code }` | 错误通知 |

## 消息流示例

### 会话启动流程

```
Manus.im (Web UI)           Background                Content/CDP
    │                            │                         │
    │ my-browser/start-session   │                         │
    ├───────────────────────────>│                         │
    │                            │ createTab()             │
    │                            │ groupTabs()            │
    │                            │ attachDebugger()       │
    │                            ├────────────────────────>│
    │                            │ Page.enable            │
    │                            │<────────────────────────┤
    │                            │                         │
    │ extension/session/started  │                         │
    │<───────────────────────────┤                         │
    │                            │                         │
    │ automation/run-scenario    │                         │
    ├───────────────────────────>│                         │
    │                            │ page/check-ready       │
    │                            ├────────────────────────>│
    │                            │<────────────────────────┤
    │                            │ page/ready-state       │
    │                            │ automation/click       │
    │                            ├────────────────────────>│
    │                            │<────────────────────────┤
    │ automation/progress        │                         │
    │<───────────────────────────┤                         │
```

### 用户接管流程

```
Manus App                   Background                 TabManager
    │                            │                         │
    │ 用户点击页面               │                         │
    │                            │                         │
    │ extension/unauthorize-task │                         │
    ├───────────────────────────>│                         │
    │                            │ stop animation          │
    │                            ├────────────────────────>│
    │                            │ mark "User Takeover"    │
    │                            │                         │
    │ extension/take-over-summary│                         │
    │<───────────────────────────┤                         │
    │                            │                         │
    │ extension/resume-task      │                         │
    ├───────────────────────────>│                         │
    │                            │ resume animation        │
    │                            ├────────────────────────>│
```

## 消息优先级

| 优先级 | 消息类型 | 原因 |
|--------|---------|------|
| 高 | `extension/stop-task` | 用户主动停止 |
| 高 | `extension/unauthorize-task` | 用户干预 |
| 高 | `automation/screenshot` | 视觉反馈 |
| 中 | `automation/click` | 交互操作 |
| 中 | `automation/type` | 交互操作 |
| 低 | `content/heartbeat` | 后台维护 |
| 低 | `automation/progress` | 状态更新 |

## 错误处理

### 错误消息格式

```javascript
{
  source: "background",
  type: "error",              // 或在响应中
  error: {
    message: string,
    code?: string,
    stack?: string
  },
  requestId?: string
}
```

### 常见错误码

| 错误码 | 描述 | 处理方式 |
|--------|------|---------|
| `SESSION_NOT_FOUND` | 会话不存在 | 提示用户重新开始 |
| `ELEMENT_NOT_FOUND` | 元素未找到 | 重试或跳过 |
| `CDP_DETACHED` | 调试器分离 | 重新附加调试器 |
| `TAB_CLOSED` | 标签页已关闭 | 清理会话 |
| `UNAUTHORIZED` | 用户未授权 | 重定向到登录页 |

## 类型守卫

```javascript
// sendMessage.js 导出的类型守卫
import {
  // isSidepanelMessage,  // ❌ 未被使用
  isContentMessage,
  isManusAppMessage,
  isPopupMessage,
  isBackgroundMessage
} from "./typeGuards.js"

// 使用示例
chrome.runtime.onMessage.addListener((message) => {
  if (isManusAppMessage(message)) {
    // TypeScript 知道 message.source === "manus-app"
    switch (message.type) {
      case "my-browser/ping":
        // ...
        break
      case "my-browser/switch-to-tab":
        // ...
        break
    }
  }
})
```
