# Manus AI 浏览器扩展逆向工程分析总结报告

## 项目信息

| 属性 | 值 |
|------|-----|
| **扩展名称** | Manus AI Browser Operator |
| **版本** | 0.0.47 |
| **构建日期** | 2026-01-21 21:07:38 |
| **类型** | Chrome 扩展 (Manifest V3) |
| **总大小** | 888KB |
| **分析日期** | 2026-01-28 |

## 执行摘要

Manus AI Browser Extension 是一个 Chrome 浏览器扩展，通过 AI Agent 集成实现浏览器自动化。扩展注入到所有网页，能够模拟用户交互（点击、输入、滚动）、捕获截图、提取页面内容，并通过 WebSocket 与 Manus AI 后端通信。

> **重要说明 (2026-01-28 更新)**: 原分析中关于 "sidepanel" 的描述有误。扩展**没有使用 Chrome 原生 sidePanel API**。实际的 UI 界面位于 `manus.im` 网站上，通过 `ManusAppBridge` 与扩展通信。详见 [sidepanel实现方式发现报告.md](../../09_重要发现/sidepanel实现方式发现报告.md)。

**核心功能**:
1. 浏览器自动化（点击、输入、滚动、截图）
2. AI 驱动的任务执行
3. 会话和标签页组管理
4. 与 Manus Web App (manus.im) 的双向通信

## 架构概览

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Manus AI 扩展架构                            │
└─────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────┐         ┌──────────────────┐
    │   https://manus.im   │         │   任意网页        │
    │                      │         │                  │
    │  ┌────────────────┐  │         │  ┌────────────┐  │
    │  │   React UI     │  │         │  │ Content     │  │
    │  │   (任务控制)    │  │         │  │ Script      │  │
    │  └────────┬───────┘  │         │  │ (DOM交互)   │  │
    └───────────┼──────────┘         └───┼────────────┘  │
                │                      │                 │
                │ window.postMessage   │ chrome.tabs     │
                │ (ManusAppBridge)     │ sendMessage     │
                │                      │                 │
                ▼                      ▼                 ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                  Background Worker                           │
    │  ┌───────────────┐  ┌───────────────┐  ┌─────────────┐     │
    │  │ManusAppHandler│  │ContentHandler │  │SessionManager│    │
    │  │(处理网站消息)  │  │(处理页面消息)  │  │ (会话管理)   │     │
    │  └───────────────┘  └───────────────┘  └─────────────┘     │
    │  ┌───────────────┐  ┌───────────────┐  ┌─────────────┐     │
    │  │  AuthHelper   │  │  CdpClient    │  │  TabManager  │     │
    │  │  (Cookie同步) │  │  (截图/调试)  │  │ (标签管理)   │     │
    │  └───────────────┘  └───────────────┘  └─────────────┘     │
    └───────────────────────────────┬──────────────────────────────┘
                                    │
                     chrome.debugger.sendCommand
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │ Chrome DevTools Protocol      │
                    │  - Page.captureScreenshot     │
                    │  - Runtime.evaluate           │
                    │  - DOM manipulation           │
                    └───────────────────────────────┘
```

## 文件结构

### 主要文件

| 文件 | 大小 | 描述 | 压缩状态 |
|------|------|------|---------|
| `background.ts.js` | 163KB | Service Worker | ✅ 压缩 |
| `content.ts.js` | 120KB | Content Script | ✅ 压缩 |
| `sidepanel.html.js` | 184KB | ❌ 未使用 (早期遗留文件) |
| `ManusAppBridge.ts.js` | ~5KB | Web App 桥接 | ✅ 压缩 |
| `eye.js` | 141KB | UI 组件库 | ✅ 打包 |
| `helper.js` | 78KB | 工具函数 | ✅ 压缩 |
| `sendMessage.js` | 2.7KB | 消息传递 | ✅ 可读 |
| `token.js` | 3.4KB | 存储管理 | ✅ 可读 |
| `chromeAsync.js` | 2.7KB | Chrome API 封装 | ✅ 可读 |
| `manus.js` | 293B | 域名验证 | ✅ 可读 |
| `typeGuards.js` | 266B | 类型守卫 | ✅ 可读 |

### 模块划分

```
项目/
├── 核心插件 (5 个文件)
│   ├── sendMessage.js       - 消息传递基础设施
│   ├── token.js             - 存储和认证管理
│   ├── chromeAsync.js       - Chrome API Promise 封装
│   ├── manus.js             - Manus 域名验证
│   └── typeGuards.js        - 消息类型守卫
│
├── 后台工作器 (1 个主文件)
│   └── background.ts.js      - Service Worker (163KB)
│       ├── AuthHelper          - Cookie 认证同步
│       ├── CdpClient           - Chrome DevTools Protocol
│       ├── SessionManager      - 任务会话生命周期
│       ├── TabManager          - 标签页组管理
│       ├── ContentHandler      - Content Script 消息
│       ├── ManusAppHandler     - Manus 应用消息
│       ├── PopupHandler        - Popup UI 消息
│       └── ScenarioRunner      - 自动化场景执行
│
├── 内容脚本 (2 个主文件)
│   ├── content.ts.js        - Content Script (120KB)
│   │   ├── DOM 分析             - 元素选择和可见性
│   │   ├── 交互处理             - 点击/输入/滚动
│   │   ├── 页面准备             - 提取页面内容
│   │   └── 视觉反馈             - 蓝色效果和状态栏
│   └── ManusAppBridge.ts.js - Web App 桥接
│       └── 注入到 manus.im 页面，处理 window.postMessage
│
└── UI 组件 (2 个文件)
    ├── popup.html.js        - React 弹窗 (9.3KB)
    └── eye.js               - UI 组件库 (141KB)

    注意: sidepanel.html.js (184KB) 存在但未被使用，是早期遗留文件。实际 UI 在 manus.im 网站上。
```

## 关键发现

### 1. 认证机制

**方式**: Cookie 同步 + 存储令牌

```
用户登录 (manus.im)
    ↓
后端设置 session_id Cookie
    ↓
chrome.cookies.onChanged 触发
    ↓
AuthHelper 检测变更
    ↓
500ms 防抖后同步到 chrome.storage.local
    ↓
所有扩展上下文通过 liveUpdate 获取令牌
```

**关键点**:
- Cookie 本身是 HttpOnly（JS 无法访问）
- 扩展通过 chrome.cookies API 读取
- 令牌明文存储在 chrome.storage.local
- Content Script 无法直接访问令牌

### 2. 会话管理

**生命周期**:
```
pending → running → stopped
              ↓
         takeover (用户接管)
              ↓
         running (恢复)
```

**状态**:
- `stopped`: 会话未启动或已停止
- `running`: 任务正在执行
- `takeover`: 用户已接管控制
- `error`: 发生错误

**关联**:
- 每个会话关联一个或多个标签页
- 标签页组织在一个标签页组中
- 标签页标题显示任务状态（emoji 动画）

### 3. Chrome DevTools Protocol (CDP)

**用途**:
1. **截图**: 使用 `Page.captureScreenshot`
2. **布局指标**: 使用 `Page.getLayoutMetrics`
3. **代码执行**: 使用 `Runtime.evaluate`
4. **页面控制**: 使用 `Emulation.*` 命令

**会话管理**:
- CDP 会话缓存 60 秒
- 自动重试机制（最多 3 次）
- 不活跃时自动分离调试器

### 4. 消息系统

**消息类型**: 50+ 种

| 类别 | 数量 | 示例 |
|------|------|------|
| 会话管理 | 8 | `session/start`, `session/stop` |
| 自动化操作 | 12 | `automation/click`, `automation/type` |
| 页面交互 | 6 | `page/check-ready`, `page/event-block` |
| 用户干预 | 3 | `extension/stop-task` |
| Manus 应用 | 3 | `my-browser/ping` |

**消息流**:
```
manus.im → ManusAppBridge → Background: "session/start"
Background → CDP: attachDebugger
Background → Content: "page/check-ready"
Content → Background: "page/ready-state"
Background → ManusAppBridge → manus.im: "session/started"
```

### 5. 元素定位策略

| 策略 | 描述 | 示例 |
|------|------|------|
| `bySelector` | CSS/XPath 选择器 | `"button.submit"` |
| `byIndex` | 预分配的数字索引 | `42` |
| `byCoordinates` | 视口坐标 | `{ x: 100, y: 200 }` |

### 6. 视觉反馈

**蓝色效果遮罩**:
- 四个边缘的蓝色渐变
- 内阴影效果
- 在任务执行时显示

**状态栏**:
- 底部居中显示
- 显示当前任务状态
- 提供"停止任务"按钮

**标签页动画**:
- 进行中: 动态 emoji (👆🖐️👋👍...)
- 完成: ✅

## 技术栈

| 技术 | 用途 |
|------|------|
| **构建工具** | Vite |
| **源语言** | TypeScript |
| **UI 框架** | React 19 |
| **状态管理** | MobX |
| **样式** | CSS Variables + Tailwind CSS |
| **图标** | Lucide React |
| **浏览器 API** | Chrome Extension API V3 |
| **调试协议** | Chrome DevTools Protocol 1.3 |

## 依赖关系

```
background.ts.js (核心)
├── sendMessage.js (消息传递)
├── token.js (存储)
├── chromeAsync.js (Chrome API)
├── manus.js (域名验证)
├── typeGuards.js (类型守卫)
└── helper.js (工具)

content.ts.js
├── sendMessage.js
└── typeGuards.js

ManusAppBridge.ts.js
├── sendMessage.js
├── manus.js (域名验证)
└── typeGuards.js
```

> **说明 (2026-01-29)**: `sidepanel.html.js` 文件存在但未被使用。实际的 UI 位于 `manus.im` 网站，通过 `ManusAppBridge` (注入到 manus.im 的 Content Script) 与扩展通信。

## 网络通信

### WebSocket

```
生产环境: wss://api.manus.im
开发环境: wss://vida.butterfly-effect.dev
本地开发: ws://localhost:4000
```

### HTTP API

```
https://manus.im/my-browser  - 扩展设置
https://manus.im/login      - 登录
https://manus.im/app        - 主应用
```

### 传输数据

1. **截图**: Base64 编码
2. **页面内容**: Markdown 格式
3. **事件**: JSON 格式
4. **状态**: JSON 格式

## 安全评估

### 权限风险: ⚠️ 中等

| 权限 | 风险 | 用途 |
|------|------|------|
| `debugger` | 高 | 截图、DOM 操作 |
| `scripting` | 高 | 注入脚本 |
| `<all_urls>` | 高 | 所有网站访问 |
| `cookies` | 中 | 读取认证 Cookie |

### 数据隐私

**收集的数据**:
- ✅ 页面 URL 和标题
- ✅ 页面截图
- ✅ 页面文本内容
- ✅ 用户交互（点击、输入）

**不收集的数据**:
- ❌ 密码字段
- ❌ 完整 Cookie
- ❌ 浏览器历史
- ❌ 下载文件

### 建议

1. **用户知情**: 确保用户了解扩展功能
2. **可见反馈**: 所有操作都有视觉反馈
3. **随时可停**: 用户可随时停止任务
4. **最小权限**: 考虑减少权限范围

## 分析产物

### 完成的文档

```
analysis/
├── 00_概述/
│   ├── 总结报告.md          ✅ 本文档
│   ├── 消息类型分类.md      ✅ 50+ 消息类型
│   └── manifest分析.md      ⏳ 待完成
│
├── 01_核心插件/
│   ├── 消息传递机制.md      ✅ sendMessage.js
│   ├── 令牌管理.md          ✅ token.js
│   ├── Chrome异步封装.md    ✅ chromeAsync.js
│   ├── Manus集成.md         ✅ manus.js
│   └── 类型守卫.md          ✅ typeGuards.js
│
├── 02_后台工作器/
│   ├── 架构分析.md          ✅ 整体架构
│   └── 认证助手.md          ✅ AuthHelper
│
├── 03_内容脚本/
│   └── 注入策略.md          ✅ content.ts.js
│
├── 05_安全分析/
│   └── 权限审计.md          ✅ 安全评估
│
└── 07_提取工具/
    ├── 端点提取结果.html   ✅ LinkFinder
    └── 密钥提取结果.html   ✅ SecretFinder
```

## 结论

Manus AI Browser Extension 是一个功能完善的浏览器自动化工具，通过以下核心机制实现：

1. **消息驱动架构**: 所有组件通过消息通信
2. **CDP 集成**: 使用 Chrome DevTools Protocol 进行高级控制
3. **Cookie 认证**: 与 Manus Web App 共享认证状态
4. **响应式状态**: MobX 实现跨上下文状态同步
5. **用户控制**: 提供随时可停的视觉反馈

**适用场景**:
- ✅ 重复性网页操作自动化
- ✅ 数据抓取和分析
- ✅ 浏览器测试
- ✅ 个人工作流自动化

**不适用场景**:
- ❌ 敏感环境（银行、医疗）
- ❌ 需要完全离线的场景
- ❌ 对隐私要求极高的场景

---

**分析完成时间**: 2026-01-28
**分析工具**:
- js-beautify (代码美化)
- LinkFinder (端点提取)
- SecretFinder (密钥查找)
- 手动代码审查
