``` mermaid
sequenceDiagram
  participant S as ControlServer
  participant W as WebApp
  participant C as ChromeRuntime
  participant E as ExtensionSW
  participant D as ChromeDebugger

  S-->>W: command_stream(SSE_or_WS)
  W->>C: sendMessage(extensionId,ExternalRequest)
  C->>E: onMessageExternal
  E->>D: debugger.attach/sendCommand/detach
  E-->>W: ExternalResponse(ok_or_error)
  E->>S: http_post(telemetry_or_result)
```

``` mermaid
flowchart TB
  subgraph Server[Server Side]
    Orchestrator["Orchestrator (LLM + ç¼–æ’)"]
    SSE["SSE /control/stream"]
    Callback["POST /control/callback"]
    EventSink["POST /control/events"]
  end

  subgraph WebApp[WebApp Bridge]
    Page["webapp.ts + iframe"]
    ES["EventSource"]
  end

  subgraph Extension[Extension Side]
    BG["background.js"]
    CDP["chrome.debugger"]
    EventEmitter["onEvent dispatcher"]
  end

  Orchestrator --> SSE --> ES --> Page
  Page -->|"sendMessage"| BG
  BG --> CDP
  CDP -->|"onEvent"| EventEmitter
  EventEmitter -->|"POST /control/events"| EventSink
  BG -->|"POST /control/callback"| Callback
```

## è½åœ°è®°å½•

- `docs/data-flow/2026-01-05-webapp-bridge-è½åœ°è®°å½•.md`
- `docs/data-flow/2026-01-05-control-run-å¤šæ­¥ç¼–æ’éªŒè¯.md`

## éªŒè¯æ–‡æ¡£

| Phase | æ–‡æ¡£ | çŠ¶æ€ |
|-------|------|------|
| Phase 0 | `verification/phase0-oopif-result.md` | âœ… OOPIF å¯æ“ä½œ |
| Phase 1 | `verification/phase1-tier1-cdp-coverage.md` | âœ… **91% è¦†ç›– + ä¾èµ–é“¾ 100%** |
| Phase 2 | `verification/phase2-event-subscription.md` | âœ… å®ç°å®Œæˆ |
| Phase 3 | `verification/phase3-session-multiplexer.md` | âœ… å®ç°å®Œæˆ |
| Phase 4 | `verification/phase4-frame-oopif.md` | âœ… ç”± Phase 0 è¦†ç›– |
| Phase 5 | `verification/phase5-stability-wait.md` | âœ… å®ç°å®Œæˆ |
| Phase 6 | `verification/phase6-stagehand-integration.md` | ğŸ“ å¾…éªŒè¯ |

## å…³é”®ç»“è®º

### 1. OOPIF å®Œå…¨å¯æ“ä½œ

é€šè¿‡ `chrome.debugger` + `Target.setAutoAttach(flatten)` å¯ä»¥ï¼š
1. æ£€æµ‹è·¨åŸŸ iframe å¹¶è·å–å­ sessionId
2. åœ¨å­ session ä¸­æ‰§è¡Œä»»æ„ CDP å‘½ä»¤
3. è·å– iframe å†…çš„ DOM/JS æ‰§è¡Œç»“æœ

### 2. CDP æ–¹æ³•å…¨è¦†ç›–éªŒè¯é€šè¿‡

| éªŒè¯é¡¹ | ç»“æœ |
|--------|------|
| åŸºç¡€ Round 1-7 | 20/22 (91%) |
| DOM ä¾èµ–é“¾ | 7/7 âœ… |
| Runtime ä¾èµ–é“¾ | 4/4 âœ… |
| Page æ“ä½œ | 4/4 âœ… |
| Overlay é«˜äº® | 7/7 âœ… |

**Stagehand æ ¸å¿ƒåŠŸèƒ½æ‰€éœ€çš„å…¨éƒ¨ CDP æ–¹æ³•å·²éªŒè¯é€šè¿‡**ã€‚

### 3. keepAttached æœºåˆ¶

è§£å†³äº† nodeId/objectId åœ¨ä¸²è¡Œè°ƒç”¨ä¸­å¤±æ•ˆçš„é—®é¢˜ï¼Œæ”¯æŒå¤æ‚çš„å¤šæ­¥æ“ä½œé“¾ã€‚