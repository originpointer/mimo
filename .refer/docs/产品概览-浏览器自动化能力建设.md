# 产品概览：浏览器自动化能力建设

> 最后更新：2026-01-12

---

## 一句话描述

**让 AI 像人一样操作浏览器**：通过 Chrome 扩展 + 服务端 LLM，实现企业级的智能浏览器自动化。

---

## 任务目标

将开源项目 **Stagehand** 的 AI 浏览器自动化能力，迁移到 **Chrome 扩展**环境，使其能够：

1. **在员工本地运行**（桌面/CLI/扩展）
2. **由服务端远程控制**（安全、可审计）
3. **支持 LLM 驱动的智能操作**（自然语言指令）

---

## 当前进度

```
██████░░░░░░░░░░░░░░░░  30% PoC + 最小闭环验证（进行中）
```

### 阶段划分

| 阶段 | 占比 | 状态 | 说明 |
|------|------|------|------|
| **1. 技术可行性验证** | 10% | 🔄 进行中 | 服务器控制面 + 验证页体系已较完整；**执行端扩展 CDP Driver 仍缺**（当前依赖外部扩展） |
| 2. Extension 完整开发 | 20% | 🔄 进行中 | 已有 MV3 Plasmo 工程 + 页面加载状态监听 PoC；**CDP 执行器/消息协议落地未在此仓库完成** |
| 3. WebApp/控制台开发 | 15% | 🔄 进行中 | 已有 `/control/webapp` 中转页 + `/control/verify/*` 工具页；控制台 UI/任务管理未产品化 |
| 4. Stagehand 核心移植 | 30% | 🔄 进行中 | 已落地 DriverAdapter + run 编排 + snapshot/observe/extract/act(2) 最小实现 + nanobrowser highlight |
| 5. LLM 集成 | 15% | 🔄 进行中 | 已接入 OpenAI-Compat 的 planner（`/control/plan`）；提示词/执行串联仍需完善 |
| 6. 产品化 | 10% | 🔄 进行中 | 已开工：策略评估、审计落盘、任务锁/缓存；稳定性/测试/UX 仍缺口较大 |

### 当前阶段详情（技术可行性验证）

| 验证项 | 内容 | 结论 |
|--------|------|------|
| ✅ 通信链路 | Server(`/control/stream`) → WebApp(`/control/webapp`) → Extension（`chrome.runtime.sendMessage` 外部消息） | **链路/协议已实现**（执行端 driver 仍需对齐） |
| ✅ OOPIF | Target auto-attach + 子 session 路由（`/control/sessions`）+ 验证流程（`/control/webapp` 内置 OOPIF 测试） | **服务端/验证侧已就绪**（依赖扩展上报 Target 事件） |
| ✅ CDP 覆盖 | Phase1 批量验证按钮（Round1-7）+ 串行依赖链（DOM/Runtime/Page/Overlay） | **验证工具已具备**（覆盖率数据需定期重新统计） |
| ✅ 事件回传 | `/control/events`（POST 接收、GET 查询/过滤、可清空）+ 服务端 eventStore | **服务端已实现**（扩展侧 onEvent 上报尚未在此仓库落地） |
| ✅ 会话管理 | sessionRegistry + `/control/sessions`（summary/tab/url/type 查询） | **服务端已实现**（依赖 Target.* 事件流） |
| ✅ DOM/快照 | `/control/snapshot` + snapshot 模块（HybridSnapshot、XPath 工具） | 可用（为“定位/提取/圈定映射”提供基础） |
| ✅ 元素圈定 | `/control/highlight` + `/control/highlight/clear` + `/control/verify/highlight` | 可用（返回 `highlightIndex → elementId` 映射） |
| ⏳ 提示词优化 | 解决 LLM 提示词过量问题 | 待调研（MetaGPT 等） |

**本阶段目标**：证明技术路线可行，**不是**实现完整功能。

### 待调研方向

| 方向 | 问题 | 参考 |
|------|------|------|
| 提示词过量 | 工具/上下文信息过多导致 token 消耗大 | MetaGPT 的工具处理机制 |

---

## 完成后获得的能力

### 核心能力

| 能力 | 说明 | 应用场景 |
|------|------|----------|
| **自然语言操作** | "点击登录按钮" → AI 自动定位并点击 | 流程自动化 |
| **跨域穿透** | 操作嵌套的第三方 iframe | 复杂网页交互 |
| **智能等待** | 自动等待页面加载/网络空闲 | 稳定性保障 |
| **数据提取** | AI 理解页面结构并提取信息 | 数据采集 |

### 技术指标

- **CDP 覆盖率**：91%（核心方法 100%）
- **响应延迟**：< 100ms（本地）
- **支持环境**：Chrome 120+

---

## 涉及项目介绍

### Stagehand（参考实现）

> **AI 驱动的浏览器自动化框架**

- 来源：开源项目
- 特点：LLM + CDP 直连浏览器
- 我们复用：分层架构、缓存机制、Handler 设计

### Nanobrowser（参考实现）

> **Chrome 扩展形式的浏览器自动化**

- 来源：开源项目
- 特点：MV3 扩展、多 Agent 协作
- 我们复用：chrome.debugger 使用模式、事件管理

### mimo（本项目）

> **融合 Stagehand + Nanobrowser 的企业级方案**

- 目标：内部工具 / 企业自动化
- 架构：Server（LLM 编排）→ WebApp（中转）→ Extension（执行）

---

## 架构简图

```
┌─────────────┐      SSE       ┌─────────────┐   sendMessage   ┌─────────────┐
│   Server    │ ─────────────► │   WebApp    │ ───────────────► │  Extension  │
│  (LLM+编排)  │ ◄───────────── │   (中转页)   │ ◄─────────────── │  (执行CDP)  │
└─────────────┘    HTTP POST   └─────────────┘    Response      └──────┬──────┘
                                                                       │
                                                                       ▼
                                                                ┌─────────────┐
                                                                │   浏览器    │
                                                                │  (目标页面)  │
                                                                └─────────────┘
```

---

## 下一步

### 阶段 2：Extension 完整开发

| 模块 | 当前状态 | 待完成 |
|------|----------|--------|
| background（MV3/Plasmo） | ✅ 已有：页面加载状态管理/上报（PageStateManager） | **补齐 CDP Driver**（`chrome.debugger` 执行、回调、事件上报、externally_connectable） |
| content script | ✅ 已有：页面状态检测（Observer + SPA/iframe 检测） | 与 CDP Driver 的协作（统一 tab/session 生命周期） |
| Popup UI | 模板页 | 状态显示、连接管理、调试入口（sessions/events/trace） |
| Options 页面 | 无 | 配置项、服务端地址、企业分发策略（固定 extensionId） |
| 权限管理 | PoC 未完整 | MV3 权限清单、按需申请、企业策略文档 |
| 错误处理 | 服务端已有部分 | 扩展侧重试/降级/用户提示；端到端超时与幂等 |

### 阶段 3：WebApp/控制台开发

| 模块 | 当前状态 | 待完成 |
|------|----------|--------|
| `/control/webapp` | ✅ 已实现：SSE → 扩展外部消息转发 + 一组验证按钮 | 从“验证页”升级为控制台（更好的任务视图/鉴权/错误提示） |
| `/control/verify/*` | ✅ 已实现：phase2~10 验证页集合 | 整理成“验收用例库”（输入/输出标准化、截图/产物导出） |
| 任务管理 | 无 | 任务列表、状态监控、重放（replay/export） |
| 日志查看 | 服务端已有 callback 日志 | 可视化日志面板（events/sessions/audit） |
| 调试工具 | 部分能力已具备 | CDP 命令调试器 + Trace/Span 关联（commandId/traceId） |

### 阶段 4：Stagehand 核心移植

| 模块 | 当前状态 | 说明 / 待完成 |
|------|----------|---------------|
| Understudy/DriverAdapter | ✅ 已实现（`utils/control/driverAdapter.ts`） | 需要对齐“扩展执行端 driver”以实现真正端到端 |
| 最小 Handler/API | ✅ 已实现：`/control/act`、`/control/act2`、`/control/extract`、`/control/observe`、`/control/wait` | 仍是最小版，缺 Stagehand 完整 handler 体系/错误分类 |
| 编排（run） | ✅ 已实现：`/control/run` + `utils/control/orchestrator.ts` | 当前为顺序编排 + 模板变量；后续补并行/重试/回滚 |
| Snapshot/序列化 | ✅ 已实现：`/control/snapshot` + snapshot 模块（HybridSnapshot、XPath 工具） | 需要与 LLM 的“可控上下文”策略结合（token 控制） |
| Frame/Session 管理 | ✅ 已实现：sessionRegistry + `/control/sessions` + `/control/events`（Target.* 处理） | 事件流依赖扩展侧上报，需补齐执行端实现 |
| 任务锁/缓存 | ✅ 已实现：`utils/control/taskExecution.ts` | 需要在更高层“任务/步骤”编排中统一使用 |

### 阶段 5：LLM 集成

| 模块 | 当前状态 | 待完成 |
|------|----------|--------|
| LLMProvider | ✅ 已有 OpenAI-Compat（`utils/llm/openaiCompat`） | 增加多 Provider/鉴权/限流/成本统计 |
| Planner | ✅ 已实现：`/control/plan`（输出严格 JSON actions） | Prompt 泛化（从“测试页固定 selector”升级为真实页面） |
| 执行串联 | ⏳ | 将 planner actions 自动映射到 `/control/act2` + wait/observe/snapshot 的闭环 |
| Prompt 工程 | ⏳ | 引入“可控上下文”与工具描述压缩（解决 token 过量） |

### 阶段 6：产品化

- ✅ **审计与产物**：`auditStore`（jsonl + 截图）、`/control/replay/:taskId`、`/control/export/:taskId`
- ✅ **策略与风控**：`policy.ts`（风险分级/二次确认）+ act2 侧强制执行
- ✅ **回调安全**：`/control/callback` Bearer callbackToken 校验
- ⏳ **端到端测试**：扩展执行端落地后补齐
- ⏳ **错误处理完善**：扩展侧重试/恢复、服务端错误码规范化、可观测性闭环
- ⏳ **文档与部署**：企业分发/权限策略/运行手册

---

## 关键验证结论

| 验证项 | 结论 |
|--------|------|
| chrome.debugger 能否替代直连 CDP？ | ✅ **可以**，91% 方法覆盖 |
| 能否操作跨域 iframe？ | ✅ **可以**，通过 sessionId 路由 |
| nodeId 会失效吗？ | ✅ **已解决**，使用 keepAttached 模式 |

**当前状态**：PoC + 最小闭环验证进行中（~30%）
- ✅ **服务端控制面**：SSE(`/control/stream`) + enqueue/run + callback 校验已具备
- ✅ **可观测性基础**：events 接收/查询 + sessions registry + keepAttached 相关验证页
- ✅ **Stagehand 最小能力集**：act/extract/observe/snapshot/highlight 已落地最小实现
- ✅ **LLM 规划**：`/control/plan` 已接 OpenAI-Compat（需与 act2/执行闭环更紧密串联）
- ⏳ **执行端扩展**：CDP Driver（debugger 执行 + onEvent 上报 + externally_connectable）未在此仓库完成
- ⏳ **提示词优化**：待调研 MetaGPT 等工具编排方案

**风险提示**：
- 当前代码均为验证代码，生产化需要大量重构
- Extension UI/UX 设计未开始
- Stagehand 代码量较大，移植复杂度待评估
- LLM 调用成本和延迟需要实际测试验证

**待调研技术方向**：
- MetaGPT 工具调用优化模式 → 解决提示词/工具描述过量问题

