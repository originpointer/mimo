# Stagehand DOM 序列化 - 验证结果

## 验证概述

| 测试项 | 状态 | 说明 |
|--------|------|------|
| basic | ✅ Pass | 基础快照获取 |
| xpath | ✅ Pass | XPath 映射正确 |
| content | ✅ Pass | 树内容完整 |
| count | ✅ Pass | 元素计数正确 |

**验证日期**: 2026-01-08

---

## 测试环境

- **测试页面**: `http://localhost:3000/test-stagehand.html`
- **tabId**: 829139186
- **sessionId**: null (主 session)

---

## 完整测试结果

### 统计信息

```json
{
  "elementCount": 33,
  "urlCount": 1,
  "frameCount": 1,
  "treeLength": 563
}
```

### combinedTree 输出

```
[0-16] RootWebArea: Stagehand Test Page
  [0-17] scrollable, html
    [0-23] body
      [0-24] div
        [0-25] heading: Stagehand Fixed Layout Test
        [0-26] div
          [0-7] StaticText: 建议点击坐标：按钮中心
          [0-27] code
            [0-8] StaticText: (160, 142)
          [0-9] StaticText: ，输入框中心
          [0-28] code
            [0-10] StaticText: (210, 209)
      [0-29] button: Click Me
      [0-5] textbox: Type here
      [0-13] StaticText: clickStatus: not_clicked
      [0-14] StaticText: typeStatus: empty
      [0-15] StaticText: keyStatus: 0
```

### combinedXpathMap 输出

```json
{
  "0-16": "/",
  "0-36": "/html[1]",
  "0-17": "/html[1]",
  "0-18": "/html[1]/head[1]",
  "0-19": "/html[1]/head[1]/meta[1]",
  "0-20": "/html[1]/head[1]/meta[2]",
  "0-21": "/html[1]/head[1]/title[1]",
  "0-37": "/html[1]/head[1]/title[1]/text()[1]",
  "0-22": "/html[1]/head[1]/style[1]",
  "0-38": "/html[1]/head[1]/style[1]/text()[1]",
  "0-23": "/html[1]/body[1]",
  "0-24": "/html[1]/body[1]/div[1]",
  "0-25": "/html[1]/body[1]/div[1]/h1[1]",
  "0-6": "/html[1]/body[1]/div[1]/h1[1]/text()[1]",
  "0-26": "/html[1]/body[1]/div[1]/div[1]",
  "0-7": "/html[1]/body[1]/div[1]/div[1]/text()[1]",
  "0-27": "/html[1]/body[1]/div[1]/div[1]/code[1]",
  "0-8": "/html[1]/body[1]/div[1]/div[1]/code[1]/text()[1]",
  "0-9": "/html[1]/body[1]/div[1]/div[1]/text()[2]",
  "0-28": "/html[1]/body[1]/div[1]/div[1]/code[2]",
  "0-10": "/html[1]/body[1]/div[1]/div[1]/code[2]/text()[1]",
  "0-29": "/html[1]/body[1]/button[1]",
  "0-11": "/html[1]/body[1]/button[1]/text()[1]",
  "0-5": "/html[1]/body[1]/input[1]",
  "0-39": "/html[1]/body[1]/input[1]//",
  "0-32": "/html[1]/body[1]/div[2]",
  "0-13": "/html[1]/body[1]/div[2]/text()[1]",
  "0-33": "/html[1]/body[1]/div[3]",
  "0-14": "/html[1]/body[1]/div[3]/text()[1]",
  "0-34": "/html[1]/body[1]/div[4]",
  "0-15": "/html[1]/body[1]/div[4]/text()[1]",
  "0-35": "/html[1]/body[1]/script[1]",
  "0-40": "/html[1]/body[1]/script[1]/text()[1]"
}
```

### combinedUrlMap 输出

```json
{
  "0-16": "http://localhost:3000/test-stagehand.html"
}
```

---

## 关键元素验证

### 按钮元素

| 属性 | 值 |
|------|-----|
| elementId | `0-29` |
| role | `button` |
| name | `Click Me` |
| xpath | `/html[1]/body[1]/button[1]` |

### 输入框元素

| 属性 | 值 |
|------|-----|
| elementId | `0-5` |
| role | `textbox` |
| name | `Type here` |
| xpath | `/html[1]/body[1]/input[1]` |

### 页面根元素

| 属性 | 值 |
|------|-----|
| elementId | `0-16` |
| role | `RootWebArea` |
| name | `Stagehand Test Page` |
| xpath | `/` |
| url | `http://localhost:3000/test-stagehand.html` |

---

## 测试用例详情

### 1. basic - 基础快照测试

**验证内容**：
- 快照 API 返回成功 (`ok: true`)
- `combinedTree` 非空
- `combinedXpathMap` 包含元素
- `stats` 数据正确

**结果**: ✅ Pass

### 2. xpath - XPath 映射测试

**验证内容**：
- 所有 elementId 都有对应的 XPath
- XPath 格式正确（以 `/` 开头）
- 关键元素的 XPath 正确

**验证的元素**：

| elementId | 期望 XPath | 实际 XPath | 结果 |
|-----------|-----------|-----------|------|
| `0-29` | `/html[1]/body[1]/button[1]` | `/html[1]/body[1]/button[1]` | ✅ |
| `0-5` | `/html[1]/body[1]/input[1]` | `/html[1]/body[1]/input[1]` | ✅ |
| `0-25` | `/html[1]/body[1]/div[1]/h1[1]` | `/html[1]/body[1]/div[1]/h1[1]` | ✅ |

**结果**: ✅ Pass

### 3. content - 内容验证测试

**验证内容**：
- `combinedTree` 包含关键文本
- 角色信息正确
- 层级结构正确

**检查项**：

| 检查项 | 期望 | 结果 |
|--------|------|------|
| 包含 "RootWebArea" | ✅ | ✅ |
| 包含 "button: Click Me" | ✅ | ✅ |
| 包含 "textbox: Type here" | ✅ | ✅ |
| 包含 "heading" | ✅ | ✅ |

**结果**: ✅ Pass

### 4. count - 元素计数测试

**验证内容**：
- 元素数量在合理范围内
- URL 映射至少包含一个条目

**检查项**：

| 指标 | 实际值 | 期望范围 | 结果 |
|------|--------|---------|------|
| elementCount | 33 | > 10 | ✅ |
| urlCount | 1 | ≥ 1 | ✅ |
| frameCount | 1 | ≥ 1 | ✅ |
| treeLength | 563 | > 100 | ✅ |

**结果**: ✅ Pass

---

## 原始测试数据

<details>
<summary>完整 JSON 响应</summary>

```json
{
  "tabId": 829139186,
  "sse": { "ok": true, "info": { "message": "SSE connected" } },
  "results": {
    "basic": {
      "pass": true,
      "snap": {
        "ok": true,
        "result": {
          "tabId": 829139186,
          "sessionId": null,
          "combinedTree": "[0-16] RootWebArea: Stagehand Test Page\n [0-17] scrollable, html\n [0-23] body\n [0-24] div\n [0-25] heading: Stagehand Fixed Layout Test\n [0-26] div\n [0-7] StaticText: 建议点击坐标：按钮中心\n [0-27] code\n [0-8] StaticText: (160, 142)\n [0-9] StaticText: ，输入框中心\n [0-28] code\n [0-10] StaticText: (210, 209)\n [0-29] button: Click Me\n [0-5] textbox: Type here\n [0-13] StaticText: clickStatus: not_clicked\n [0-14] StaticText: typeStatus: empty\n [0-15] StaticText: keyStatus: 0",
          "combinedXpathMap": {
            "0-16": "/",
            "0-36": "/html[1]",
            "0-17": "/html[1]",
            "0-18": "/html[1]/head[1]",
            "0-19": "/html[1]/head[1]/meta[1]",
            "0-20": "/html[1]/head[1]/meta[2]",
            "0-21": "/html[1]/head[1]/title[1]",
            "0-37": "/html[1]/head[1]/title[1]/text()[1]",
            "0-22": "/html[1]/head[1]/style[1]",
            "0-38": "/html[1]/head[1]/style[1]/text()[1]",
            "0-23": "/html[1]/body[1]",
            "0-24": "/html[1]/body[1]/div[1]",
            "0-25": "/html[1]/body[1]/div[1]/h1[1]",
            "0-6": "/html[1]/body[1]/div[1]/h1[1]/text()[1]",
            "0-26": "/html[1]/body[1]/div[1]/div[1]",
            "0-7": "/html[1]/body[1]/div[1]/div[1]/text()[1]",
            "0-27": "/html[1]/body[1]/div[1]/div[1]/code[1]",
            "0-8": "/html[1]/body[1]/div[1]/div[1]/code[1]/text()[1]",
            "0-9": "/html[1]/body[1]/div[1]/div[1]/text()[2]",
            "0-28": "/html[1]/body[1]/div[1]/div[1]/code[2]",
            "0-10": "/html[1]/body[1]/div[1]/div[1]/code[2]/text()[1]",
            "0-29": "/html[1]/body[1]/button[1]",
            "0-11": "/html[1]/body[1]/button[1]/text()[1]",
            "0-5": "/html[1]/body[1]/input[1]",
            "0-39": "/html[1]/body[1]/input[1]//",
            "0-32": "/html[1]/body[1]/div[2]",
            "0-13": "/html[1]/body[1]/div[2]/text()[1]",
            "0-33": "/html[1]/body[1]/div[3]",
            "0-14": "/html[1]/body[1]/div[3]/text()[1]",
            "0-34": "/html[1]/body[1]/div[4]",
            "0-15": "/html[1]/body[1]/div[4]/text()[1]",
            "0-35": "/html[1]/body[1]/script[1]",
            "0-40": "/html[1]/body[1]/script[1]/text()[1]"
          },
          "combinedUrlMap": {
            "0-16": "http://localhost:3000/test-stagehand.html"
          },
          "stats": {
            "elementCount": 33,
            "urlCount": 1,
            "frameCount": 1,
            "treeLength": 563
          }
        }
      }
    },
    "xpath": { "pass": true, "snap": { "..." : "..." } },
    "content": { "pass": true, "snap": { "..." : "..." } },
    "count": { "pass": true, "snap": { "..." : "..." } }
  }
}
```

</details>

---

## 后续改进

### 待实现功能

1. **focusSelector 支持**：限制快照范围到特定选择器
2. **OOPIF 完整支持**：跨进程 iframe 的完整处理
3. **增量更新**：仅返回变化的部分
4. **ActCache**：动作缓存机制

### 已知限制

1. `0-39` 的 XPath 为 `/html[1]/body[1]/input[1]//`，可能需要进一步清理
2. 多 frame 场景未做完整测试
3. Shadow DOM 嵌套深度限制
