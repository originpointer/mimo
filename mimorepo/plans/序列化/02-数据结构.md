# Stagehand DOM 序列化 - 数据结构

## 1. CDP 类型定义

### 1.1 DomNode

DOM 节点类型，对应 CDP `DOM.Node`。

**文件位置**: `.refer/server/utils/control/driverAdapter.ts`

```typescript
export interface DomNode {
  nodeId: number              // 节点 ID（会话内唯一）
  backendNodeId: number       // 后端节点 ID（稳定，跨会话）
  nodeType: number            // 节点类型（1=Element, 3=Text, 8=Comment）
  nodeName: string            // 节点名称（如 "HTML", "DIV"）
  localName?: string          // 本地名称
  nodeValue?: string          // 文本节点的值
  childNodeCount?: number     // 子节点数量
  children?: DomNode[]        // 子节点数组
  attributes?: string[]       // 属性数组 [name1, value1, name2, value2, ...]
  shadowRoots?: DomNode[]     // Shadow DOM 根节点
  contentDocument?: DomNode   // iframe 的内容文档
  frameId?: string            // Frame ID
  isScrollable?: boolean      // 是否可滚动
}
```

### 1.2 AXNode

可访问性节点类型，对应 CDP `Accessibility.AXNode`。

```typescript
export interface AXNode {
  nodeId: string              // AX 节点 ID
  ignored: boolean            // 是否被忽略
  role?: { type: string; value: string }         // 角色
  chromeRole?: { type: string; value: string }   // Chrome 角色
  name?: { type: string; value: string }         // 名称
  description?: { type: string; value: string }  // 描述
  value?: { type: string; value: string }        // 值
  properties?: Array<{                           // 属性列表
    name: string
    value: { type: string; value: unknown }
  }>
  parentId?: string           // 父节点 ID
  childIds?: string[]         // 子节点 ID 列表
  backendDOMNodeId?: number   // 关联的 DOM 节点 backendNodeId
}
```

## 2. Snapshot 类型定义

### 2.1 HybridSnapshot

快照结果类型。

**文件位置**: `.refer/server/utils/control/snapshot/capture.ts`

```typescript
export interface HybridSnapshot {
  /** 合并后的文本大纲（供 LLM 使用） */
  combinedTree: string
  
  /** elementId -> XPath 映射 */
  combinedXpathMap: Record<string, string>
  
  /** elementId -> URL 映射 */
  combinedUrlMap: Record<string, string>
  
  /** 每个 frame 的详细数据（可选） */
  perFrame?: Array<{
    frameId: string
    outline: string
    xpathMap: Record<string, string>
    urlMap: Record<string, string>
  }>
}
```

### 2.2 SnapshotOptions

快照选项。

```typescript
export interface SnapshotOptions {
  /** 是否穿透 shadow DOM */
  pierceShadow?: boolean
  
  /** 聚焦选择器（可选） */
  focusSelector?: string
  
  /** 是否启用实验性功能 */
  experimental?: boolean
}
```

### 2.3 FrameContext

Frame 上下文。

```typescript
export interface FrameContext {
  /** 根 frame ID */
  rootId: string
  
  /** frameId -> parentFrameId 映射 */
  parentByFrame: Map<string, string | null>
  
  /** 所有 frame ID 列表 */
  frames: string[]
}
```

## 3. DOM 处理类型

### 3.1 DomMaps

DOM 映射结果。

**文件位置**: `.refer/server/utils/control/snapshot/domTree.ts`

```typescript
export interface DomMaps {
  /** encodedId -> 标签名 */
  tagNameMap: Record<string, string>
  
  /** encodedId -> 相对 XPath */
  xpathMap: Record<string, string>
  
  /** encodedId -> 是否可滚动 */
  scrollableMap: Record<string, boolean>
}
```

### 3.2 SessionDomIndex

Session DOM 索引，用于缓存一个 CDP session 的完整 DOM 树信息。

```typescript
export interface SessionDomIndex {
  /** 根节点的 backendNodeId */
  rootBackend: number
  
  /** backendNodeId -> 绝对 XPath */
  absByBe: Map<number, string>
  
  /** backendNodeId -> 标签名 */
  tagByBe: Map<number, string>
  
  /** backendNodeId -> 是否可滚动 */
  scrollByBe: Map<number, boolean>
  
  /** backendNodeId -> 所属文档根的 backendNodeId */
  docRootOf: Map<number, number>
  
  /** iframe 的 backendNodeId -> 其 contentDocument 根的 backendNodeId */
  contentDocRootByIframe: Map<number, number>
}
```

## 4. A11y 处理类型

### 4.1 A11yOptions

可访问性树选项。

**文件位置**: `.refer/server/utils/control/snapshot/a11yTree.ts`

```typescript
export interface A11yOptions {
  /** 聚焦选择器（可选） */
  focusSelector?: string
  
  /** 标签名映射 */
  tagNameMap: Record<string, string>
  
  /** 可滚动映射 */
  scrollableMap: Record<string, boolean>
  
  /** 是否启用实验性功能 */
  experimental?: boolean
  
  /** 编码函数 */
  encode: (backendNodeId: number) => string
}
```

### 4.2 AccessibilityTreeResult

可访问性树结果。

```typescript
export interface AccessibilityTreeResult {
  /** 文本大纲 */
  outline: string
  
  /** URL 映射 */
  urlMap: Record<string, string>
  
  /** 是否应用了范围限制 */
  scopeApplied: boolean
}
```

### 4.3 A11yNodeInternal

内部使用的 A11y 节点结构。

```typescript
export interface A11yNodeInternal {
  role: string
  name?: string
  description?: string
  value?: string
  nodeId: string
  backendDOMNodeId?: number
  parentId?: string
  childIds?: string[]
  encodedId?: string
  children?: A11yNodeInternal[]
}
```

## 5. API 类型

### 5.1 SnapshotBody

API 请求体。

```typescript
type SnapshotBody = {
  extensionId: string
  tabId: number
  replyUrl?: string
  sessionId?: string
  fullSnapshot?: boolean
  pierceShadow?: boolean
  focusSelector?: string
  experimental?: boolean
}
```

### 5.2 SnapshotResponse

API 响应体。

```typescript
type SnapshotResponse = {
  ok: true
  result: {
    tabId: number
    sessionId: string | null
    combinedTree: string
    combinedXpathMap: Record<string, string>
    combinedUrlMap: Record<string, string>
    perFrame: Array<{
      frameId: string
      outline: string
      xpathMap: Record<string, string>
      urlMap: Record<string, string>
    }>
    stats: {
      elementCount: number
      urlCount: number
      frameCount: number
      treeLength: number
    }
  }
} | {
  ok: false
  error: { message: string }
}
```

## 6. 数据流示意

```
┌─────────────────┐
│  CDP Response   │
│  DOM.getDocument│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    DomNode      │  ← DOM 节点树
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ SessionDomIndex │  ← 索引（backendNodeId -> xpath/tag）
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    DomMaps      │  ← 映射（encodedId -> xpath/tag）
└────────┬────────┘
         │
         │    ┌─────────────────┐
         │    │  CDP Response   │
         │    │  AX.getFullTree │
         │    └────────┬────────┘
         │             │
         │             ▼
         │    ┌─────────────────┐
         │    │    AXNode[]     │  ← AX 节点列表
         │    └────────┬────────┘
         │             │
         │             ▼
         │    ┌─────────────────┐
         │    │A11yNodeInternal │  ← 装饰后的节点
         │    └────────┬────────┘
         │             │
         ▼             ▼
┌─────────────────────────────┐
│      HybridSnapshot         │
│ ┌─────────────────────────┐ │
│ │ combinedTree (string)   │ │  ← 文本大纲
│ ├─────────────────────────┤ │
│ │ combinedXpathMap        │ │  ← ID → XPath
│ ├─────────────────────────┤ │
│ │ combinedUrlMap          │ │  ← ID → URL
│ └─────────────────────────┘ │
└─────────────────────────────┘
```

## 7. EncodedId 格式说明

### 格式

```
{frameOrdinal}-{backendNodeId}
```

### 示例

| encodedId | 含义 |
|-----------|------|
| `0-16` | 主 frame (ordinal=0) 中 backendNodeId=16 的节点 |
| `0-29` | 主 frame 中 backendNodeId=29 的节点 |
| `1-45` | 第二个 frame (ordinal=1) 中 backendNodeId=45 的节点 |

### 生成逻辑

```typescript
// 在 capture.ts 中
const frameOrdinals = new Map<string, number>()
context.frames.forEach((fid, idx) => frameOrdinals.set(fid, idx))

// 生成 encodedId
const ordinal = frameOrdinals.get(frameId) ?? 0
const encode = (be: number) => `${ordinal}-${be}`
```

### 使用场景

1. **LLM 返回**: LLM 从 combinedTree 中看到 `[0-29] button: Click Me`，返回 `elementId: "0-29"`
2. **XPath 查找**: 服务端通过 `combinedXpathMap["0-29"]` 获取 `/html[1]/body[1]/button[1]`
3. **元素操作**: 使用 XPath 定位元素执行点击/输入等操作
