# 能力对齐：图像与 DOM 落地原则在“简历正文根XPath”场景的应用

本文将 `mimorepo/apps/plasmo-app/docs/大模型页面理解-图像与DOM-落地原则.md` 的决策原则，映射到本任务：**定位“只包含简历正文”的根容器 XPath**。

> 核心约束：你要输出可回放的 `XPath` ⇒ **DOM 必须参与**。但“用户真实看到的正文是否被遮挡/弹窗覆盖/跨 iframe 合成” ⇒ **图像需要参与核验或优先**。

---

## 1. 为什么本任务必须是“DOM 主导 + 图像核验/融合”

- **DOM 的不可替代性**：
  - 你最终要输出 `XPath`（可复现、可回放、可点击/可滚动到的定位）。
  - 需要证据链：哪些字段锚点、哪些节点统计支撑了“这是正文根容器”。
- **图像的不可替代性**：
  - 简历页常见 **浮层/登录弹窗/引导下载 App**，会遮挡正文。
  - 渠道站点常有 **sticky header、侧边栏推荐**，DOM 上“存在”并不代表“用户看到的是正文”。
  - 跨域 iframe 合成呈现（尤其在部分站点组件化实现中）仅从 DOM 摘要可能低估遮挡与可见性风险。

---

## 2. 采集策略：把落地原则的 Pipeline A/B/C 映射到本任务

### Pipeline A：DOM 为主，图像仅核验（性价比最高）

适用：你更关注“抽到可用 XPath”，允许偶尔漏掉遮挡（但会有自校验/回退）。

- **Step A1（DOM 摘要）**：端侧采集 anchors + candidate summaries（详见 `03`/`06`）。
- **Step A2（服务端评分）**：输出 root xpath + 置信度 + 证据链。
- **Step A3（触发核验）**：当存在遮挡/弹窗风险、或候选分差小，端侧采集 viewport 截图。
- **Step A4（核验结果）**：
  - 截图显示正文被弹窗遮挡 ⇒ 走回退：关闭弹窗/滚动/等待/二次采集。
  - 截图与 DOM 结论一致 ⇒ 输出通过。

### Pipeline B：图像为主，DOM 做精定位（DOM 不可靠时）

适用：某些页面 DOM 文本不稳定/混淆严重，或正文在 iframe 内且 DOM 信号弱。

- **Step B1（先截图）**：快速判断“是否有遮挡/是否已加载出简历正文/正文区域大概位置”。
- **Step B2（回到 DOM）**：仅在“截图确认有正文且无遮挡”的前提下，从 DOM anchors/candidates 中输出根 xpath。

> 本任务最终一定回到 DOM，因为输出必须是 `XPath`。

### Pipeline C：并行融合（默认推荐，最稳但成本更高）

适用：跨站泛化、线上稳定性要求高。

- 端侧并行采集：
  - **DOM 摘要**：anchors/candidates/stats/xpath
  - **viewport 截图**：用于遮挡/弹窗/视觉语义核验
- 服务端融合：
  - 先用 DOM 打分选 TopK
  - 再用图像核验决定是否需要回退/重采
  - 不确定时启用 LLM 在 TopK 内裁决（仍以 DOM 输出 xpath）

---

## 3. 何时必须截图（强触发条件）

满足任一条件，建议采集 viewport 截图（或直接走 Pipeline C）：

- **遮挡/弹窗高发**：检测到 modal/overlay/sticky 登录条（DOM 可检测到，但图像更可靠）。
- **跨 iframe 合成风险**：正文疑似在 iframe 内或页面结构复杂（图像可直接看到合成后的最终呈现）。
- **候选不稳定**：Top2 分差小 / coverage 落在灰区（例如 `[0.55, 0.75)`）。
- **用户态语义**：需要确保“只要正文”，而非混入推荐区（图像可帮助识别推荐卡片是否占主区域）。

---

## 4. 输出格式（证据链 + 可回放）

建议服务端最终输出结构（示意）：

- `rootXpath`: string
- `confidence`: 0~1
- `evidence`:
  - `anchorsUsed`: 命中的字段类型计数与关键片段
  - `candidateStats`: coverage/linkDensity/interactiveDensity/textLen
  - `imageChecks?`: 是否发现遮挡/弹窗/正文可见
- `nextAction?`: 需要关闭弹窗/滚动/等待/二次采集时给出指令

---

## 5. 与后续章节的关系

- `02`：说明 StagehandXPath 协议能做什么、不能做什么，以及需要补采集哪些 DOM 摘要信号。
- `03`：给出 anchors→candidates→score 的核心算法细节与阈值。
- `06`：把上述 Pipeline 变成服务端可编排的状态机 + 端侧回传协议。

