# OpenCode 用户输入处理流程

## 概述

本文档详细说明 OpenCode 如何从接收用户输入开始，经过一系列处理步骤，最终生成 AI 响应的完整流程。

## 流程概览

```
用户输入 → HTTP 请求 → 会话创建 → 消息构建 → 提示词组装 → LLM 调用 → 响应流式处理 → 工具执行 → 循环继续
```

## 1. HTTP 请求入口

### 1.1 端点定义

**位置**: `packages/opencode/src/server/server.ts`

#### 同步消息端点

```typescript
.post("/session/:sessionID/message",
  validator("param", z.object({
    sessionID: z.string()
  })),
  validator("json", SessionPrompt.PromptInput.omit({ sessionID: true })),
  async (c) => {
    const sessionID = c.req.valid("param").sessionID
    const body = c.req.valid("json")
    return stream(c, async (stream) => {
      const msg = await SessionPrompt.prompt({ ...body, sessionID })
      stream.write(JSON.stringify(msg))
    })
  }
)
```

#### 异步消息端点

```typescript
.post("/session/:sessionID/prompt_async",
  validator("param", z.object({
    sessionID: z.string()
  })),
  validator("json", SessionPrompt.PromptInput.omit({ sessionID: true })),
  async (c) => {
    c.status(204)
    return stream(c, async () => {
      const sessionID = c.req.valid("param").sessionID
      const body = c.req.valid("json")
      SessionPrompt.prompt({ ...body, sessionID })
    })
  }
)
```

#### 命令端点

```typescript
.post("/session/:sessionID/command",
  validator("json", SessionPrompt.CommandInput.omit({ sessionID: true })),
  async (c) => {
    const sessionID = c.req.valid("param").sessionID
    const body = c.req.valid("json")
    return stream(c, async (stream) => {
      const msg = await SessionPrompt.command({ ...body, sessionID })
      stream.write(JSON.stringify(msg))
    })
  }
)
```

### 1.2 请求数据结构

**位置**: `packages/opencode/src/session/prompt.ts`

```typescript
export const PromptInput = z.object({
  sessionID: Identifier.schema("session"),  // 会话 ID
  messageID: Identifier.schema("message").optional(),  // 父消息 ID（用于分支）
  model: z.object({
    providerID: z.string(),   // 提供商 ID (如 "anthropic")
    modelID: z.string(),      // 模型 ID (如 "claude-sonnet-4")
  }).optional(),
  agent: z.string().optional(),           // Agent 名称
  noReply: z.boolean().optional(),        // 是否需要 AI 响应
  tools: z.record(z.string(), z.boolean()).optional(),  // 工具权限（已弃用）
  system: z.string().optional(),          // 自定义系统提示词
  variant: z.string().optional(),         // 模型变体
  parts: z.array(z.discriminatedUnion("type", [
    MessageV2.TextPart,     // 文本内容
    MessageV2.FilePart,     // 文件附件
    MessageV2.AgentPart,    // 切换 Agent
    MessageV2.SubtaskPart,  // 子任务
  ])),
})
```

## 2. 会话创建与管理

### 2.1 Session.create()

**位置**: `packages/opencode/src/session/index.ts`

```typescript
export const create = fn(
  z.object({
    parentID: Identifier.schema("session").optional(),  // 父会话（分支）
    title: z.string().optional(),
    permission: Info.shape.permission,
  }).optional(),
  async (input) => {
    return createNext({
      parentID: input?.parentID,
      directory: Instance.directory,
      title: input?.title,
      permission: input?.permission,
    })
  }
)
```

### 2.2 会话数据结构

```typescript
export const Info = z.object({
  id: Identifier.schema("session"),        // 会话唯一 ID
  slug: z.string(),                        // URL 友好的标识符
  projectID: z.string(),                   // 项目 ID
  directory: z.string(),                   // 工作目录
  parentID: Identifier.schema("session").optional(),  // 父会话
  summary: z.object({                      // 会话摘要
    additions: z.number(),
    deletions: z.number(),
    files: z.number(),
    diffs: Snapshot.FileDiff.array().optional(),
  }).optional(),
  share: z.object({
    url: z.string(),
  }).optional(),
  title: z.string(),                       // 会话标题
  version: z.string(),                     // OpenCode 版本
  time: z.object({
    created: z.number(),
    updated: z.number(),
    compacting: z.number().optional(),     // 压缩时间
    archived: z.number().optional(),
  }),
  permission: PermissionNext.Ruleset.optional(),  // 权限规则
  revert: z.object({                       // 回滚状态
    messageID: z.string(),
    partID: z.string().optional(),
    snapshot: z.string().optional(),
    diff: z.string().optional(),
  }).optional(),
})
```

## 3. 消息创建

### 3.1 createUserMessage()

**位置**: `packages/opencode/src/session/prompt.ts`

```typescript
async function createUserMessage(input: PromptInput) {
  const session = await Session.get(input.sessionID)

  // 生成消息 ID
  const messageID = Identifier.ascending("message")

  // 处理输入 parts
  const parts = await Promise.all(
    input.parts.map(async (part) => {
      if (part.type === "text") {
        return {
          ...part,
          id: Identifier.ascending("part"),
          messageID,
          sessionID: input.sessionID,
        } as MessageV2.TextPart
      }
      // ... 处理其他类型
    })
  )

  // 获取 Agent 和模型配置
  const agent = input.agent || await Agent.defaultAgent()
  const model = input.model || await Provider.defaultModel()

  // 创建用户消息
  const userMessage: MessageV2.User = {
    id: messageID,
    sessionID: input.sessionID,
    role: "user",
    time: { created: Date.now() },
    agent,
    model: {
      providerID: model.providerID,
      modelID: model.modelID,
    },
    system: input.system,
    tools: input.tools,
    variant: input.variant,
  }

  // 保存到存储
  await Session.updateMessage(userMessage)
  for (const part of parts) {
    await Session.updatePart(part)
  }

  return { info: userMessage, parts }
}
```

### 3.2 消息类型

#### User Message

```typescript
export const User = Base.extend({
  role: z.literal("user"),
  time: z.object({
    created: z.number(),
  }),
  summary: z.object({
    title: z.string().optional(),
    body: z.string().optional(),
    diffs: Snapshot.FileDiff.array(),
  }).optional(),
  agent: z.string(),           // 使用的 Agent
  model: z.object({            // 使用的模型
    providerID: z.string(),
    modelID: z.string(),
  }),
  system: z.string().optional(),      // 自定义系统提示词
  tools: z.record(z.string(), z.boolean()).optional(),
  variant: z.string().optional(),
})
```

#### Assistant Message

```typescript
export const Assistant = Base.extend({
  role: z.literal("assistant"),
  time: z.object({
    created: z.number(),
    completed: z.number().optional(),
  }),
  error: z.discriminatedUnion("name", [
    AuthError.Schema,
    OutputLengthError.Schema,
    AbortedError.Schema,
    APIError.Schema,
  ]).optional(),
  parentID: z.string(),         // 父消息（用户消息）ID
  modelID: z.string(),
  providerID: z.string(),
  mode: z.string(),
  agent: z.string(),
  path: z.object({
    cwd: z.string(),            // 工作目录
    root: z.string(),           // 项目根目录
  }),
  summary: z.boolean().optional(),
  cost: z.number(),             // 本次响应成本
  tokens: z.object({            // token 使用统计
    input: z.number(),
    output: z.number(),
    reasoning: z.number(),
    cache: z.object({
      read: z.number(),
      write: z.number(),
    }),
  }),
  finish: z.string().optional(),  // 完成原因
})
```

## 4. 会话循环

### 4.1 SessionPrompt.loop()

**位置**: `packages/opencode/src/session/prompt.ts`

```typescript
export const loop = fn(Identifier.schema("session"), async (sessionID) => {
  const abort = start(sessionID)
  if (!abort) {
    // 会话正忙，加入等待队列
    return new Promise<MessageV2.WithParts>((resolve, reject) => {
      const callbacks = state()[sessionID].callbacks
      callbacks.push({ resolve, reject })
    })
  }

  using _ = defer(() => cancel(sessionID))
  let step = 0

  while (true) {
    SessionStatus.set(sessionID, { type: "busy" })

    // 获取消息历史
    let msgs = await MessageV2.filterCompacted(
      MessageV2.stream(sessionID)
    )

    // 查找最后的用户消息和助手消息
    let lastUser: MessageV2.User | undefined
    let lastAssistant: MessageV2.Assistant | undefined

    for (let i = msgs.length - 1; i >= 0; i--) {
      if (!lastUser && msgs[i].info.role === "user") {
        lastUser = msgs[i].info as MessageV2.User
      }
      if (!lastAssistant && msgs[i].info.role === "assistant") {
        lastAssistant = msgs[i].info as MessageV2.Assistant
      }
      if (lastUser && lastAssistant) break
    }

    if (!lastUser) {
      throw new Error("No user message found")
    }

    // 检查是否已完成
    if (lastAssistant?.finish &&
        lastUser.id < lastAssistant.id) {
      break
    }

    // 创建助手消息
    const assistantMessage = await createAssistantMessage({
      sessionID,
      parentID: lastUser.id,
      model: lastUser.model,
      agent: lastUser.agent,
    })

    // 构建上下文
    const context = await buildContext({
      messages: msgs,
      userMessage: lastUser,
    })

    // 执行 LLM 调用
    const processor = SessionProcessor.create({
      assistantMessage,
      sessionID,
      model: await Provider.getModel(
        lastUser.model.providerID,
        lastUser.model.modelID
      ),
      abort,
    })

    const result = await processor.process(context)

    step++
    if (result === "stop") break
    if (result === "compact") {
      // 触发上下文压缩
      await SessionCompaction.create(...)
      continue
    }
  }

  return lastAssistant
})
```

## 5. 上下文构建

### 5.1 SystemPrompt 构建

**位置**: `packages/opencode/src/session/system.ts`

```typescript
export async function build() {
  const parts: string[] = []

  // 1. Header (提供商标识)
  parts.push(...header(providerID))

  // 2. Provider 特定指令
  const model = await Provider.getModel(providerID, modelID)
  parts.push(...provider(model))

  // 3. 核心指令
  parts.push(instructions())

  // 4. 环境信息
  parts.push(...(await environment()))

  // 5. 自定义配置
  parts.push(...(await custom()))

  return parts
}
```

#### Header 示例

```typescript
// anthropic_spoof.txt
You are Claude, made by Anthropic.
```

#### Provider 指令示例

```typescript
// anthropic.txt
## Capabilities
- You can use tools to perform actions
- You have access to a virtualized shell
...

## Core Rules
- Use Chinese characters for Chinese content
- Run tests before considering code complete
...
```

#### 环境信息

```typescript
// environment()
[
  `Here is some useful information about the environment:`,
  `<env>`,
  `  Working directory: ${Instance.directory}`,
  `  Is directory a git repo: ${project.vcs === "git" ? "yes" : "no"}`,
  `  Platform: ${process.platform}`,
  `  Today's date: ${new Date().toDateString()}`,
  `</env>`,
]
```

#### 自定义配置

```typescript
// custom()
// 读取以下文件（按优先级）:
// 1. ~/.claude/CLAUDE.md
// 2. <project>/CLAUDE.md
// 3. ~/.opencode/config.json 中的 instructions
```

### 5.2 消息转换

**位置**: `packages/opencode/src/session/message-v2.ts`

```typescript
export function toModelMessage(input: WithParts[]): ModelMessage[] {
  const result: UIMessage[] = []

  for (const msg of input) {
    if (msg.info.role === "user") {
      const userMessage: UIMessage = {
        id: msg.info.id,
        role: "user",
        parts: [],
      }

      for (const part of msg.parts) {
        if (part.type === "text" && !part.ignored) {
          userMessage.parts.push({
            type: "text",
            text: part.text,
          })
        }
        if (part.type === "file" && part.mime !== "text/plain") {
          userMessage.parts.push({
            type: "file",
            url: part.url,
            mediaType: part.mime,
            filename: part.filename,
          })
        }
      }

      result.push(userMessage)
    }

    if (msg.info.role === "assistant") {
      const assistantMessage: UIMessage = {
        id: msg.info.id,
        role: "assistant",
        parts: [],
      }

      for (const part of msg.parts) {
        if (part.type === "text") {
          assistantMessage.parts.push({
            type: "text",
            text: part.text,
            providerMetadata: part.metadata,
          })
        }
        if (part.type === "tool") {
          if (part.state.status === "completed") {
            assistantMessage.parts.push({
              type: `tool-${part.tool}`,
              state: "output-available",
              toolCallId: part.callID,
              input: part.state.input,
              output: part.state.output,
            })
          }
        }
      }

      result.push(assistantMessage)
    }
  }

  return convertToModelMessages(result)
}
```

## 6. LLM 调用

### 6.1 LLM.stream()

**位置**: `packages/opencode/src/session/llm.ts`

```typescript
export async function* stream(input: StreamInput) {
  const { model, messages, tools, abort } = input

  // 获取语言模型
  const language = await Provider.getLanguage(model)

  // 注册工具
  const toolDefs = await ToolRegistry.register(tools)

  // 调用 AI SDK
  const stream = await generateText({
    model: language,
    messages: [...systemMessages, ...messages],
    tools: toolDefs,
    temperature: input.temperature,
    topP: input.topP,
    maxTokens: input.maxTokens,
    abortSignal: abort,
    experimental_continue: true,  // 支持继续生成
  })

  yield* stream.fullStream
}
```

## 7. 响应处理

**位置**: `packages/opencode/src/session/processor.ts`

详见《代码生成流程》文档。

## 8. 工具执行

详见《工具系统》相关文档。

## 关键数据流

```
HTTP Request
    ↓
SessionPrompt.prompt()
    ↓
createUserMessage() → 保存用户消息到 Storage
    ↓
SessionPrompt.loop() → 进入处理循环
    ↓
buildContext()
    ├─ SystemPrompt.header()
    ├─ SystemPrompt.provider()
    ├─ SystemPrompt.instructions()
    ├─ SystemPrompt.environment()
    └─ SystemPrompt.custom()
    ↓
MessageV2.toModelMessage() → 转换为 AI SDK 格式
    ↓
LLM.stream() → 调用 LLM
    ↓
SessionProcessor.process() → 处理流式响应
    ↓
工具执行 → 返回结果
    ↓
继续循环或完成
```
