# OpenCode 整体架构

## 概述

OpenCode 是一个开源的 AI 编码助手，通过理解用户输入、制定计划和生成代码来完成复杂的编程任务。它的核心设计理念是模块化、可扩展和安全性优先。

## 核心架构

### 1. 整体分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                             │
│  (CLI、TUI、VSCode Extension、Web UI、Desktop App)            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                         服务器层                              │
│  (Hono Server - HTTP/WebSocket/API Endpoints)               │
│  - /session/* : 会话管理                                     │
│  - /message/* : 消息处理                                     │
│  - /config/*  : 配置管理                                     │
│  - /tool/*    : 工具调用                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        核心处理层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Session    │  │    Agent     │  │   Message    │      │
│  │  会话管理     │  │  Agent 系统  │  │  消息处理     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Prompt     │  │  Processor   │  │   LLM Stream │      │
│  │  提示词工程   │  │  流处理器     │  │  LLM 流式调用│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        工具执行层                             │
│  (Tool Registry - Bash, Read, Grep, Glob, Edit, etc.)      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        基础设施层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Provider    │  │  Permission  │  │   Storage    │      │
│  │  LLM 提供商   │  │  权限系统     │  │  存储系统     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Snapshot    │  │    VCS       │  │    LSP       │      │
│  │  文件快照     │  │  版本控制     │  │  语言服务器   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### 2. 核心目录结构

```
packages/opencode/src/
├── agent/          # Agent 系统实现
│   ├── agent.ts    # Agent 核心类和配置
│   └── prompt/     # 各类 Agent 的提示词模板
├── session/        # 会话管理
│   ├── index.ts    # 会话 CRUD 操作
│   ├── message-v2.ts   # 消息数据结构
│   ├── processor.ts    # 消息流处理器
│   ├── prompt.ts   # 提示词构建
│   ├── system.ts   # 系统提示词
│   └── llm.ts      # LLM 调用封装
├── server/         # HTTP 服务器
│   └── server.ts   # Hono 路由定义
├── tool/           # 工具注册表
│   ├── registry.ts # 工具注册表
│   ├── read.ts     # 文件读取工具
│   ├── grep.ts     # 搜索工具
│   ├── glob.ts     # 文件匹配工具
│   └── bash.ts     # 命令执行工具
├── provider/       # LLM 提供商
│   ├── provider.ts # 提供商抽象
│   └── models/     # 模型定义
├── permission/     # 权限系统
├── storage/        # 存储抽象层
├── snapshot/       # 文件系统快照
├── project/        # 项目管理
├── vcs/            # 版本控制集成
└── lsp/            # LSP 集成
```

## 核心流程

### 1. 用户输入到代码生成的完整流程

```
用户输入
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 服务器接收请求                         │
│    POST /session/:sessionID/message      │
│    或 POST /session/:sessionID/prompt    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 创建用户消息                          │
│    - 解析输入 parts (文本、文件、Agent)   │
│    - 生成 Message ID                     │
│    - 存储到 Storage                       │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 启动会话循环 (SessionPrompt.loop)     │
│    - 创建 AbortController                │
│    - 进入消息处理循环                     │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 构建系统提示词 (SystemPrompt)         │
│    - header: 提供商标识                  │
│    - provider: 提供商特定指令            │
│    - instructions: Codex 核心指令        │
│    - environment: 环境信息               │
│    - custom: 自定义配置 (AGENTS.md等)    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 5. 获取 Agent 配置                       │
│    - 解析用户选择的 Agent                │
│    - 应用 Agent 特定的权限规则           │
│    - 应用 Agent 特定的提示词             │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 6. 构建消息列表                          │
│    - 过滤已压缩的消息                    │
│    - 转换为 AI SDK 消息格式              │
│    - 添加系统提示词                      │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 7. 流式调用 LLM (LLM.stream)            │
│    - 使用 Vercel AI SDK                  │
│    - 注册可用工具                        │
│    - 开始流式响应                        │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 8. 处理流式响应 (SessionProcessor)       │
│    - reasoning-start/delta/end: 推理    │
│    - text-start/delta/end: 文本输出      │
│    - tool-call: 工具调用                 │
│    - tool-result: 工具结果               │
│    - finish-step: 步骤完成               │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 9. 工具执行                              │
│    - 检查权限 (PermissionNext)           │
│    - 执行工具操作                        │
│    - 返回结果给 LLM                      │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 10. 持续循环                             │
│     - 直到达到 finish 状态               │
│     - 或达到最大步数限制                 │
│     - 或需要压缩上下文                   │
└─────────────────────────────────────────┘
    │
    ▼
完成响应
```

### 2. 计划模式流程

```
用户触发计划模式
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. 使用 plan Agent                       │
│    - 只读权限                            │
│    - 可写入计划文件                      │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 第一阶段：初始理解                    │
│    - 理解用户请求                        │
│    - 启动 Explore Agent 探索代码库       │
│    - 使用 AskUserQuestion 澄清需求       │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 第二阶段：规划                        │
│    - 启动 Plan Agent                     │
│    - 制定实施计划                        │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 第三阶段：综合                        │
│    - 收集所有 Agent 响应                 │
│    - 识别关键文件                        │
│    - 询问用户权衡选择                    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 5. 第四阶段：最终计划                    │
│    - 更新计划文件                        │
│    - 包含推荐方法和关键文件              │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 6. 调用 ExitPlanMode                     │
│    - 退出计划模式                        │
│    - 等待用户批准执行                    │
└─────────────────────────────────────────┘
```

### 3. Agent 调用流程

```
Agent 工具调用
    │
    ▼
┌─────────────────────────────────────────┐
│ 1. Task Tool                            │
│    - 创建子会话                          │
│    - 使用指定的 Agent                    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 2. 子会话初始化                          │
│    - 继承父会话的项目上下文              │
│    - 应用 Agent 特定配置                 │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 3. 子 Agent 执行                        │
│    - 使用独立的权限规则                  │
│    - 使用独立的提示词                    │
│    - 返回结果给父会话                    │
└─────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────┐
│ 4. 结果整合                              │
│    - 将子 Agent 输出添加到消息历史        │
│    - 父会话继续执行                      │
└─────────────────────────────────────────┘
```

## 关键设计模式

### 1. 消息流处理 (Processor Pattern)

`SessionProcessor.create()` 创建一个流处理器，通过事件驱动的方式处理 LLM 返回的各种事件类型。

### 2. 提示词组合 (Composition Pattern)

系统提示词由多个层次组成：
- Header: 提供商标识
- Provider: 提供商特定指令
- Instructions: 核心行为准则
- Environment: 运行环境信息
- Custom: 用户自定义规则
- Agent: Agent 特定指令

### 3. 权限系统 (Permission System)

基于规则的权限控制系统，支持：
- 全局默认规则
- Agent 特定规则
- 用户自定义规则
- 运行时权限询问

### 4. 快照机制 (Snapshot)

文件系统快照用于：
- 跟踪代码变更
- 生成补丁
- 计算差异
- 支持回滚

## 技术栈

- **运行时**: Bun + TypeScript ESM
- **Web 框架**: Hono
- **AI SDK**: Vercel AI SDK
- **数据验证**: Zod
- **工具库**: Ripgrep (搜索)、Git (版本控制)
- **存储**: 文件系统 + KV 存储

## 扩展性

### 添加新 Agent

在 `src/agent/agent.ts` 的 `state` 函数中添加新的 Agent 配置。

### 添加新工具

在 `src/tool/` 目录下创建新工具类，实现 `Tool.Info` 接口，并在 `ToolRegistry` 中注册。

### 添加新提供商

在 `src/provider/` 目录下实现新的 Provider 类，集成到 `Provider` 命名空间中。
