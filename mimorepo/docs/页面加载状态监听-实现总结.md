# 页面加载状态监听 - 实现总结

## 已完成的工作

### 1. 文档编写 ✅

创建了详细的文档 `docs/页面加载状态监听方案.md`，包含：

- **MV3 状态信息清单**：
  - 浏览器 API 状态信息（Document、Window、Performance、Network）
  - Chrome Extension API 状态信息（webNavigation、tabs、scripting）
  - DOM Observer 状态信息（MutationObserver、IntersectionObserver、ResizeObserver、PerformanceObserver）
  - 自定义状态指标（关键元素、异步资源、框架特定状态）

- **SPA 页面分析**（苏格拉底式提问）：
  - 初始加载阶段（10 个问题）
  - 动态内容加载（3 个问题）
  - 状态管理（1 个问题）

- **非 SPA 页面分析**（苏格拉底式提问）：
  - 传统页面加载流程（6 个问题）
  - 资源加载检测（2 个问题）
  - 特殊场景（2 个问题）

- **综合判断策略**：
  - 状态优先级定义
  - 状态机设计
  - 实现建议和算法伪代码

### 2. 代码实现 ✅

#### 类型定义 (`src/types/page-state.ts`)
- `PageLoadState` 枚举：定义 8 种页面状态
- `PageStateInfo` 接口：页面状态信息结构
- `ObserverConfig` 接口：Observer 配置选项
- `DEFAULT_CONFIG`：默认配置值

#### 核心检测器 (`src/utils/page-state-detector.ts`)
- `PageStateDetector` 类：
  - 组合使用 4 种 Observer
  - 状态机实现
  - 防抖/节流机制
  - 超时检测
  - 错误处理

#### SPA 检测器 (`src/utils/spa-detector.ts`)
- `SPADetector` 类：
  - 框架检测（React、Vue、Angular）
  - 路由模式检测
  - SPA 结构特征检测
  - 路由变化监听（History API 拦截）

#### iframe 检测器 (`src/utils/iframe-detector.ts`)
- `IFrameDetector` 类：
  - iframe 检测
  - 同源/跨域判断
  - 加载状态监听
  - 可见性检查

#### Content Script (`src/content.ts`)
- 初始化 `PageStateDetector`
- 状态变化监听
- 与 background 通信
- 页面可见性处理

#### Background Script (`src/background/index.ts`)
- `PageStateManager` 类：
  - webNavigation 事件监听
  - tabs 事件监听
  - 状态管理（多 tab、多 frame）
  - 状态同步到 server（批量、队列、重试）

### 3. 配置更新 ✅

- 更新 `package.json` manifest 配置：
  - 添加 `webNavigation` 权限
  - 添加 `tabs` 权限
  - 保留 `host_permissions`

### 4. 文档完善 ✅

- 创建 `src/README.md`：模块使用说明
- 创建 `docs/页面加载状态监听-实现总结.md`：本文档

## 文件结构

```
apps/plasmo-app/
├── src/
│   ├── types/
│   │   └── page-state.ts          # 类型定义
│   ├── utils/
│   │   ├── page-state-detector.ts # 核心检测器
│   │   ├── spa-detector.ts        # SPA 检测器
│   │   └── iframe-detector.ts     # iframe 检测器
│   ├── content.ts                 # Content Script
│   ├── background/
│   │   └── index.ts               # Background Script
│   └── README.md                  # 使用说明
├── docs/
│   ├── 页面加载状态监听方案.md    # 详细方案文档
│   └── 页面加载状态监听-实现总结.md # 本文档
└── package.json                   # 已更新 manifest 配置
```

## 核心特性

### 1. 多维度状态检测

- **Document 状态**：`readyState`、`visibilityState`
- **DOM 稳定性**：MutationObserver 检测 DOM 变化
- **网络活动**：PerformanceObserver 检测资源加载
- **元素可见性**：IntersectionObserver 检测关键元素
- **布局变化**：ResizeObserver 检测尺寸变化

### 2. SPA 支持

- 自动检测 SPA（框架、路由模式、结构特征）
- 路由变化监听（History API 拦截）
- 内容稳定期检测（SPA 特有状态）

### 3. 非 SPA 支持

- 完整加载流程追踪
- iframe 检测和处理
- 传统导航检测

### 4. 性能优化

- 防抖机制（避免频繁更新）
- 稳定期阈值（减少误判）
- Observer 优化（只监听必要区域）
- 批量状态同步（减少网络请求）

### 5. 错误处理

- 超时检测（防止永远不进入 READY）
- 异常捕获（所有 Observer 初始化都有 try-catch）
- 降级策略（部分 API 不可用时的处理）
- 重试机制（网络请求失败重试）

## 状态流转

```
UNKNOWN
  ↓ (检测到导航)
NAVIGATING
  ↓ (DOM 开始解析)
DOM_LOADING
  ↓ (DOM 解析完成)
DOM_READY
  ↓ (资源加载中)
RESOURCE_LOADING
  ↓ (SPA: 内容稳定中)
CONTENT_STABILIZING (仅 SPA)
  ↓ (所有条件满足)
READY
```

## 使用方式

### 1. 开发模式

```bash
cd apps/plasmo-app
pnpm dev
```

### 2. 配置 Server URL

在 `.env` 文件中设置：

```
PLASMO_PUBLIC_SERVER_URL=http://localhost:3000
```

### 3. Server API 实现

需要实现 `POST /api/page-states` 端点接收状态更新。

## 测试建议

1. **SPA 页面**：
   - React Router 应用
   - Vue Router 应用
   - Angular Router 应用

2. **非 SPA 页面**：
   - 传统多页面应用
   - 包含 iframe 的页面
   - 异步加载内容的页面

3. **边界情况**：
   - 页面加载超时
   - 网络错误
   - 资源加载失败
   - 从缓存恢复的页面

## 下一步工作

1. **Server 端实现**：
   - 实现 `/api/page-states` 端点
   - 状态存储和查询
   - 状态变化通知

2. **测试**：
   - 单元测试
   - 集成测试
   - 端到端测试

3. **优化**：
   - 性能监控
   - 错误日志
   - 状态可视化

4. **文档**：
   - API 文档
   - 部署文档
   - 故障排查指南

## 注意事项

1. **权限**：确保 manifest 中已添加 `webNavigation` 和 `tabs` 权限
2. **Server URL**：需要配置正确的 server URL
3. **性能**：Observer 会持续运行，注意资源消耗
4. **兼容性**：部分 API 可能在某些浏览器中不可用，已有降级处理

## 参考文档

- [Chrome Extension MV3 文档](https://developer.chrome.com/docs/extensions/mv3/)
- [Plasmo 框架文档](https://docs.plasmo.com/)
- [MutationObserver API](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver)
- [PerformanceObserver API](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceObserver)
