# Mimo 渐进式功能嵌入计划

## 文档概述

本文档提供了 Mimo 浏览器自动化库在 `apps` 项目中渐进式功能嵌入的详细计划。计划按照优先级和依赖关系组织，确保每个阶段都能独立验证和测试。

**创建日期**: 2026-01-22
**版本**: v1.0.0

---

## 目录

- [项目现状分析](#项目现状分析)
- [集成策略](#集成策略)
- [阶段规划](#阶段规划)
- [应用场景矩阵](#应用场景矩阵)
- [测试策略](#测试策略)
- [风险评估](#风险评估)
- [里程碑检查](#里程碑检查)

---

## 项目现状分析

### 已有组件

| 应用 | 状态 | 核心功能 |
|------|------|----------|
| **next-app** | ✅ 基础完成 | React 前端、Chat UI、Socket.IO 中继 |
| **nitro-app** | ✅ 基础完成 | Nitro 后端、Socket.IO 服务、MCP 工具 |
| **plasmo-app** | ✅ 基础完成 | Chrome 扩展、浏览器控制、内容脚本 |
| **stagehand-app** | 🧪 实验阶段 | Stagehand 对比测试 |

### 已有包

| 包 | 状态 | 核心功能 |
|----|------|----------|
| **@mimo/types** | ✅ 完成 | 共享类型定义 |
| **@mimo/core** | ✅ 完成 | Mimo 主类、API 入口 |
| **@mimo/bus** | ✅ 完成 | Socket.IO 通信层 |
| **@mimo/agent** | ✅ 完成 | AI Agent 多步骤任务 |
| **@mimo/context** | ✅ 完成 | RemotePage、Locator、Context |
| **@mimo/llm** | ✅ 完成 | LLM Provider 抽象 |

### 待完善功能

1. **next-app** 缺少 Mimo 核心功能集成
2. **nitro-app** MCP 工具未完全对接 Mimo 命令
3. **plasmo-app** 扩展功能需要增强
4. 缺少统一的工作流编排系统
5. 缺少完整的错误处理和重试机制
6. 缺少用户权限和安全控制

---

## 集成策略

### 渐进式集成原则

1. **独立性**: 每个阶段可独立完成和验证
2. **向后兼容**: 新功能不破坏现有功能
3. **可测试性**: 每个阶段有明确的验收标准
4. **文档同步**: 功能与文档同步更新
5. **风险控制**: 高风险功能优先验证

### 集成层次

```
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (apps)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ next-app   │  │ nitro-app   │  │   plasmo-app        │ │
│  │  UI/Chat   │  │  Backend    │  │   Extension         │ │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘ │
└─────────┼────────────────┼────────────────────┼─────────────┘
          │                │                    │
┌─────────┼────────────────┼────────────────────┼─────────────┐
│         ▼                ▼                    ▼             │
│                   核心层 (packages)                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                    @mimo/core                           │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────────┐ │ │
│  │  │   act    │ │ extract  │ │ observe  │ │   agent    │ │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └────────────┘ │ │
│  └─────────────────────────────────────────────────────────┘ │
│           │                    │                    │        │
│  ┌────────▼──────────┐  ┌─────▼──────┐  ┌────────▼────────┐ │
│  │  @mimo/bus        │  │@mimo/llm   │  │ @mimo/context   │ │
│  │  Socket.IO 通信   │  │ LLM 抽象   │  │ 页面/元素操作   │ │
│  └───────────────────┘  └────────────┘  └─────────────────┘ │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                   @mimo/types                            │ │
│  │              共享类型定义                                │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段规划

### 阶段 0: 基础设施准备 (Week 1)

**目标**: 确保开发环境和基础设施就绪

#### 任务清单

| ID | 任务 | 优先级 | 依赖 |
|----|------|--------|------|
| 0.1 | 统一 package.json 脚本命名 | P0 | - |
| 0.2 | 配置开发环境变量管理 | P0 | - |
| 0.3 | 设置 ESLint/Prettier 统一配置 | P1 | - |
| 0.4 | 配置 Vitest 单元测试框架 | P0 | - |
| 0.5 | 建立 CI/CD 基础流水线 | P1 | 0.1, 0.4 |

#### 验收标准

- [ ] 所有包可独立构建和测试
- [ ] 开发环境一键启动 (`pnpm dev`)
- [ ] 代码风格检查通过
- [ ] 单元测试覆盖率报告生成

#### 涉及文件

- `mimorepo/package.json`
- `mimorepo/turbo.json`
- `mimorepo/.eslintrc.js`
- `mimorepo/vitest.config.ts`

---

### 阶段 1: 基础浏览器控制 (Week 2-3)

**目标**: 实现最基础的浏览器导航和操作功能

#### 1.1 RemotePage 基础功能集成

**优先级**: P0 (核心功能)

**功能点**:
- `goto(url)` - 页面导航
- `click(selector)` - 元素点击
- `fill(selector, value)` - 表单填充
- `screenshot()` - 页面截图
- `evaluate(fn)` - JavaScript 执行

**集成位置**:
- `nitro-app/server/routes/api/page.ts` (新增)
- `plasmo-app/content/page.ts` (增强)

**API 设计**:

```typescript
// nitro-app/server/routes/api/page.ts
export default eventHandler(async (event) => {
  const { action, selector, value } = await readBody(event);

  const mimo = getMimoInstance();
  const page = mimo.page;

  switch (action) {
    case 'goto':
      await page.goto(value);
      break;
    case 'click':
      await page.click(selector);
      break;
    case 'fill':
      await page.fill(selector, value);
      break;
    case 'screenshot':
      return await page.screenshot();
    case 'evaluate':
      return await page.evaluate(value);
  }

  return { success: true };
});
```

**验收标准**:
- [ ] 支持 5 种基础操作
- [ ] 操作超时时间可配置
- [ ] 错误信息准确返回

#### 1.2 元素定位器 (Locator) 功能

**优先级**: P1

**功能点**:
- CSS 选择器定位
- XPath 深度定位
- 元素状态检查 (isVisible, isHidden)
- 属性和文本获取

**集成位置**:
- `nitro-app/server/routes/api/locator.ts` (新增)
- `plasmo-app/content/locator.ts` (新增)

**API 设计**:

```typescript
// nitro-app/server/routes/api/locator.ts
export default eventHandler(async (event) => {
  const { type, selector, action, value } = await readBody(event);

  const mimo = getMimoInstance();
  const locator = type === 'xpath'
    ? mimo.page.deepLocator(selector)
    : mimo.page.locator(selector);

  switch (action) {
    case 'click':
      await locator.click();
      break;
    case 'fill':
      await locator.fill(value);
      break;
    case 'innerText':
      return { text: await locator.innerText() };
    case 'getAttribute':
      return { value: await locator.getAttribute(value) };
    case 'isVisible':
      return { visible: await locator.isVisible() };
  }

  return { success: true };
});
```

**验收标准**:
- [ ] CSS 和 XPath 选择器正常工作
- [ ] 元素不存在时返回明确错误
- [ ] 支持等待元素出现

#### 1.3 标签页管理

**优先级**: P1

**功能点**:
- 获取当前标签页
- 获取所有标签页列表
- 切换标签页
- 关闭标签页

**集成位置**:
- `nitro-app/server/routes/api/tabs.ts` (新增)

**验收标准**:
- [ ] 支持多标签页操作
- [ ] 标签页切换后操作目标正确
- [ ] 关闭标签页后自动切换到其他标签页

---

### 阶段 2: AI 功能集成 (Week 4-5)

**目标**: 集成 Mimo 的核心 AI 功能

#### 2.1 act() - 自然语言操作

**优先级**: P0 (核心功能)

**功能点**:
- 自然语言指令解析
- 操作执行和结果返回
- 变量替换支持
- 操作历史记录

**集成位置**:
- `nitro-app/server/routes/api/act.ts` (新增)
- `next-app/app/chat/actions.tsx` (增强)

**API 设计**:

```typescript
// nitro-app/server/routes/api/act.ts
export default eventHandler(async (event) => {
  const { input, options } = await readBody(event);

  const mimo = getMimoInstance();
  const result = await mimo.act(input, options);

  return {
    success: result.success,
    message: result.message,
    actions: result.actions,
    actionDescription: result.actionDescription,
  };
});
```

**Next.js 集成**:

```typescript
// next-app/app/chat/actions.tsx
'use client';

import { useChat } from '@ai-sdk/react';

export function ChatActions() {
  const { append } = useChat();

  const handleAct = async (instruction: string) => {
    const response = await fetch('/api/mimo/act', {
      method: 'POST',
      body: JSON.stringify({ input: instruction }),
    });

    const result = await response.json();
    append({ role: 'assistant', content: result.message });
  };

  return <button onClick={() => handleAct('点击登录按钮')}>执行</button>;
}
```

**验收标准**:
- [ ] 支持中英文指令
- [ ] 操作成功率 > 90%
- [ ] 历史记录完整保存
- [ ] 错误处理和重试机制生效

#### 2.2 extract() - 数据提取

**优先级**: P0 (核心功能)

**功能点**:
- 简单值提取
- Zod Schema 结构化提取
- 选择器限定区域提取
- 提取结果验证

**集成位置**:
- `nitro-app/server/routes/api/extract.ts` (新增)
- `next-app/app/tools/extract.tsx` (新增)

**API 设计**:

```typescript
// nitro-app/server/routes/api/extract.ts
export default eventHandler(async (event) => {
  const { instruction, schema, options } = await readBody(event);

  const mimo = getMimoInstance();

  // 如果提供了 schema，进行解析
  let zodSchema;
  if (schema) {
    const { z } = await import('zod');
    zodSchema = eval(`z.${schema}`);
  }

  const result = await mimo.extract(instruction, zodSchema, options);

  return {
    success: result.success,
    extraction: result.extraction,
    message: result.message,
  };
});
```

**验收标准**:
- [ ] 简单提取准确率 > 95%
- [ ] 结构化提取符合 Schema 定义
- [ ] 选择器限定正确生效

#### 2.3 observe() - 页面观察

**优先级**: P1

**功能点**:
- 获取页面可操作元素
- 元素描述生成
- 选择器建议

**集成位置**:
- `nitro-app/server/routes/api/observe.ts` (新增)
- `next-app/app/tools/observe.tsx` (新增)

**验收标准**:
- [ ] 可操作元素识别准确
- [ ] 元素描述清晰易懂
- [ ] 选择器可用率 > 95%

---

### 阶段 3: Agent 智能体 (Week 6-7)

**目标**: 实现多步骤自动化任务执行

#### 3.1 Agent 基础功能

**优先级**: P0 (核心功能)

**功能点**:
- Agent 创建和配置
- 任务执行
- 步骤记录
- Token 使用统计

**集成位置**:
- `nitro-app/server/routes/api/agent/execute.ts` (新增)
- `next-app/app/agent/execute.tsx` (新增)

**API 设计**:

```typescript
// nitro-app/server/routes/api/agent/execute.ts
export default eventHandler(async (event) => {
  const { instruction, config } = await readBody(event);

  const mimo = getMimoInstance();
  const agent = mimo.agent(config);

  const result = await agent.execute({ instruction });

  return {
    success: result.success,
    completed: result.completed,
    message: result.message,
    actions: result.actions,
    usage: result.usage,
  };
});
```

**验收标准**:
- [ ] Agent 可执行 10 步以上任务
- [ ] 任务完成率 > 80%
- [ ] 步骤记录完整
- [ ] Token 统计准确

#### 3.2 流式执行

**优先级**: P1

**功能点**:
- 实时进度推送
- 步骤状态更新
- 错误实时反馈

**集成位置**:
- `nitro-app/server/routes/api/agent/stream.ts` (新增)
- `next-app/app/agent/stream.tsx` (新增)

**API 设计**:

```typescript
// nitro-app/server/routes/api/agent/stream.ts
export default eventHandler(async (event) => {
  const { instruction, config } = await readBody(event);

  const mimo = getMimoInstance();
  const agent = mimo.agent(config);

  const stream = new ReadableStream({
    async start(controller) {
      for await (const event of await agent.streamExecute({ instruction })) {
        controller.enqueue(`data: ${JSON.stringify(event)}\n\n`);
      }
      controller.close();
    },
  });

  return new Response(stream, {
    headers: { 'Content-Type': 'text/event-stream' },
  });
});
```

**Next.js 集成**:

```typescript
// next-app/app/agent/stream.tsx
'use client';

import { useEffect, useState } from 'react';

export function AgentStream() {
  const [events, setEvents] = useState([]);

  const startAgent = async (instruction: string) => {
    const response = await fetch('/api/mimo/agent/stream', {
      method: 'POST',
      body: JSON.stringify({ instruction }),
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const text = decoder.decode(value);
      const lines = text.split('\n');

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const event = JSON.parse(line.slice(6));
          setEvents(prev => [...prev, event]);
        }
      }
    }
  };

  return (
    <div>
      {events.map((e, i) => (
        <div key={i}>{JSON.stringify(e)}</div>
      ))}
    </div>
  );
}
```

**验收标准**:
- [ ] 事件流稳定推送
- [ ] 前端实时更新
- [ ] 错误处理正确

#### 3.3 自定义系统提示词

**优先级**: P2

**功能点**:
- 用户自定义 Agent 行为
- 预设模板库
- 提示词版本管理

**集成位置**:
- `nitro-app/server/lib/prompts.ts` (新增)
- `next-app/app/agent/prompts.tsx` (新增)

**验收标准**:
- [ ] 自定义提示词生效
- [ ] 预设模板可用
- [ ] 提示词可持久化

---

### 阶段 4: 扩展功能增强 (Week 8-9)

**目标**: 增强浏览器扩展能力

#### 4.1 增强的页面操作

**优先级**: P1

**功能点**:
- 文件上传处理
- 拖拽操作
- 右键菜单
- 键盘快捷键

**集成位置**:
- `plasmo-app/content/advanced.ts` (新增)

**验收标准**:
- [ ] 文件上传正常工作
- [ ] 拖拽操作准确执行
- [ ] 右键菜单可触发

#### 4.2 深度元素定位

**优先级**: P1

**功能点**:
- 智能 XPath 生成
- 语义化选择器
- 动态元素处理

**集成位置**:
- `plasmo-app/content/xpath.ts` (新增)

**验收标准**:
- [ ] XPath 生成准确
- [ ] 动态元素可定位
- [ ] 选择器稳定性好

#### 4.3 调试工具集成

**优先级**: P2

**功能点**:
- DevTools 面板
- 操作录制回放
- 性能监控

**集成位置**:
- `plasmo-app/devtools/` (新增)

**验收标准**:
- [ ] DevTools 面板正常显示
- [ ] 操作可录制和回放
- [ ] 性能指标准确

---

### 阶段 5: MCP 工具集成 (Week 10-11)

**目标**: 完善 MCP (Model Context Protocol) 工具生态

#### 5.1 现有工具完善

**优先级**: P1

**功能点**:
- read 工具增强
- list/glob/grep 工具优化
- 工具结果缓存

**集成位置**:
- `nitro-app/server/lib/tools/` (增强)

**验收标准**:
- [ ] 工具响应时间 < 500ms
- [ ] 缓存命中率 > 50%
- [ ] 工具错误处理完善

#### 5.2 新增 Mimo 工具

**优先级**: P0

**功能点**:
- `mimo_act` - 执行浏览器操作
- `mimo_extract` - 提取页面数据
- `mimo_observe` - 观察页面状态
- `mimo_navigate` - 页面导航

**集成位置**:
- `nitro-app/server/lib/tools/mimo.ts` (新增)

**工具定义**:

```typescript
// nitro-app/server/lib/tools/mimo.ts
import { Tool } from '@modelcontextprotocol/sdk/types.js';

export const mimoActTool: Tool = {
  name: 'mimo_act',
  description: '使用自然语言指令执行浏览器操作',
  inputSchema: {
    type: 'object',
    properties: {
      instruction: {
        type: 'string',
        description: '操作指令，例如：点击登录按钮',
      },
    },
    required: ['instruction'],
  },
};

export const mimoExtractTool: Tool = {
  name: 'mimo_extract',
  description: '从页面提取结构化数据',
  inputSchema: {
    type: 'object',
    properties: {
      instruction: {
        type: 'string',
        description: '提取指令，例如：获取商品价格',
      },
      schema: {
        type: 'string',
        description: 'Zod Schema 定义（可选）',
      },
    },
    required: ['instruction'],
  },
};

export const mimoObserveTool: Tool = {
  name: 'mimo_observe',
  description: '观察页面可操作元素',
  inputSchema: {
    type: 'object',
    properties: {
      context: {
        type: 'string',
        description: '观察上下文（可选）',
      },
    },
  },
};

export const mimoNavigateTool: Tool = {
  name: 'mimo_navigate',
  description: '导航到指定 URL',
  inputSchema: {
    type: 'object',
    properties: {
      url: {
        type: 'string',
        description: '目标 URL',
      },
    },
    required: ['url'],
  },
};
```

**工具处理器**:

```typescript
// nitro-app/server/lib/tools/mimo-handler.ts
import { getMimoInstance } from '../mimo';

export async function handleMimoAct(args: { instruction: string }) {
  const mimo = getMimoInstance();
  const result = await mimo.act(args.instruction);

  return {
    content: [{
      type: 'text',
      text: JSON.stringify(result, null, 2),
    }],
  };
}

export async function handleMimoExtract(args: { instruction: string; schema?: string }) {
  const mimo = getMimoInstance();
  const result = await mimo.extract(args.instruction);

  return {
    content: [{
      type: 'text',
      text: JSON.stringify(result.extraction, null, 2),
    }],
  };
}

export async function handleMimoObserve(args: { context?: string }) {
  const mimo = getMimoInstance();
  const actions = await mimo.observe(args.context);

  return {
    content: [{
      type: 'text',
      text: JSON.stringify(actions, null, 2),
    }],
  };
}

export async function handleMimoNavigate(args: { url: string }) {
  const mimo = getMimoInstance();
  await mimo.page.goto(args.url);

  return {
    content: [{
      type: 'text',
      text: `已导航到 ${args.url}`,
    }],
  };
}
```

**验收标准**:
- [ ] 所有工具可通过 MCP 调用
- [ ] 工具参数验证正确
- [ ] 工具结果格式规范

#### 5.3 工具链编排

**优先级**: P2

**功能点**:
- 工具依赖管理
- 并行执行优化
- 结果聚合

**集成位置**:
- `nitro-app/server/lib/workflow/` (新增)

**验收标准**:
- [ ] 支持工具依赖配置
- [ ] 并行执行提升效率
- [ ] 结果聚合正确

---

### 阶段 6: UI/UX 完善 (Week 12-13)

**目标**: 完善用户界面和交互体验

#### 6.1 Chat 界面增强

**优先级**: P1

**功能点**:
- 消息分类显示
- 操作可视化
- 快捷操作面板

**集成位置**:
- `next-app/app/chat/` (增强)

**验收标准**:
- [ ] UI 响应式设计
- [ ] 操作结果可视化
- [ ] 快捷操作易用

#### 6.2 工具管理界面

**优先级**: P1

**功能点**:
- 工具列表展示
- 工具配置面板
- 使用统计

**集成位置**:
- `next-app/app/tools/` (增强)

**验收标准**:
- [ ] 工具状态实时更新
- [ ] 配置修改实时生效
- [ ] 统计数据准确

#### 6.3 Agent 任务管理

**优先级**: P1

**功能点**:
- 任务创建和配置
- 执行进度跟踪
- 任务历史记录

**集成位置**:
- `next-app/app/agent/` (增强)

**验收标准**:
- [ ] 任务配置界面直观
- [ ] 进度更新流畅
- [ ] 历史记录可查询

---

### 阶段 7: 高级功能 (Week 14-15)

**目标**: 实现高级自动化功能

#### 7.1 工作流编排

**优先级**: P2

**功能点**:
- 可视化流程编辑
- 条件分支
- 循环执行
- 错误处理

**集成位置**:
- `next-app/app/workflow/` (新增)
- `nitro-app/server/lib/workflow/` (新增)

**验收标准**:
- [ ] 可视化编辑器可用
- [ ] 工作流可保存和加载
- [ ] 执行结果可追溯

#### 7.2 批量操作

**优先级**: P2

**功能点**:
- 多 URL 批量处理
- 数据批量提取
- 结果汇总

**集成位置**:
- `nitro-app/server/lib/batch/` (新增)

**验收标准**:
- [ ] 批量任务可并发
- [ ] 失败任务可重试
- [ ] 结果可导出

#### 7.3 定时任务

**优先级**: P2

**功能点**:
- Cron 表达式支持
- 任务调度
- 执行通知

**集成位置**:
- `nitro-app/server/lib/scheduler/` (新增)

**验收标准**:
- [ ] Cron 表达式正确解析
- [ ] 任务准时执行
- [ ] 通知正常发送

---

### 阶段 8: 安全和权限 (Week 16)

**目标**: 实现安全控制机制

#### 8.1 用户认证

**优先级**: P0

**功能点**:
- 用户注册登录
- Token 管理
- 会话保持

**集成位置**:
- `nitro-app/server/lib/auth/` (新增)
- `next-app/app/auth/` (新增)

**验收标准**:
- [ ] 认证流程安全
- [ ] Token 自动刷新
- [ ] 会话超时处理

#### 8.2 权限控制

**优先级**: P1

**功能点**:
- 角色定义
- 操作权限
- 资源访问控制

**集成位置**:
- `nitro-app/server/lib/permissions/` (新增)

**验收标准**:
- [ ] 角色权限正确
- [ ] 操作鉴权准确
- [ ] 越权访问被拦截

#### 8.3 操作审计

**优先级**: P2

**功能点**:
- 操作日志记录
- 敏感操作告警
- 审计报告

**集成位置**:
- `nitro-app/server/lib/audit/` (新增)

**验收标准**:
- [ ] 所有操作可追溯
- [ ] 敏感操作有告警
- [ ] 报告可导出

---

## 应用场景矩阵

### 场景 1: 网页自动化测试

**涉及阶段**: 1, 2, 3

**实现优先级**: P1

**核心功能**:
- 页面导航和操作
- 表单自动填充
- 结果验证

**示例代码**:

```typescript
// 测试登录流程
const mimo = new Mimo({ socket: { url: 'ws://localhost:3000' } });
await mimo.init();

await mimo.page.goto('https://example.com/login');
await mimo.page.fill('#username', 'test@example.com');
await mimo.page.fill('#password', 'password123');
await mimo.page.click('#login-button');

// 验证登录成功
const isLoggedIn = await mimo.page.evaluate(() => {
  return document.querySelector('.user-avatar') !== null;
});

console.log('登录测试:', isLoggedIn ? '通过' : '失败');
```

---

### 场景 2: 电商价格监控

**涉及阶段**: 1, 2

**实现优先级**: P1

**核心功能**:
- 商品数据提取
- 价格比对
- 变化通知

**示例代码**:

```typescript
// 监控商品价格
async function monitorPrice(productUrl: string) {
  const mimo = new Mimo({ socket: { url: 'ws://localhost:3000' } });
  await mimo.init();

  await mimo.page.goto(productUrl);

  const priceResult = await mimo.extract('获取商品当前价格');
  const price = parseFloat(priceResult.extraction.replace(/[¥$,]/g, ''));

  if (price < 1000) {
    console.log('价格低于 1000，发送通知！');
    await sendNotification({ message: `商品价格: ¥${price}` });
  }

  await mimo.close();
}
```

---

### 场景 3: 智能客服助手

**涉及阶段**: 2, 3

**实现优先级**: P2

**核心功能**:
- 用户意图识别
- 自动操作执行
- 结果反馈

**示例代码**:

```typescript
// 智能客服 Agent
const agent = mimo.agent({
  model: 'openai/gpt-4o-mini',
  systemPrompt: `你是一个电商客服助手，可以帮助用户：
1. 搜索商品
2. 查看商品详情
3. 添加购物车
4. 查询订单状态`,
});

const result = await agent.execute({
  instruction: '用户想购买 iPhone 15，帮助他完成下单流程',
});
```

---

### 场景 4: 数据采集和分析

**涉及阶段**: 1, 2, 7

**实现优先级**: P1

**核心功能**:
- 批量页面访问
- 数据提取
- 结果汇总

**示例代码**:

```typescript
// 批量采集商品数据
const urls = [
  'https://example.com/product/1',
  'https://example.com/product/2',
  'https://example.com/product/3',
];

const products = [];

for (const url of urls) {
  await mimo.page.goto(url);

  const product = await mimo.extract(
    '获取商品名称、价格、评分',
    z.object({
      name: z.string(),
      price: z.string(),
      rating: z.string(),
    })
  );

  products.push(product.extraction);
}

console.log('采集结果:', products);
```

---

### 场景 5: RPA (机器人流程自动化)

**涉及阶段**: 3, 7

**实现优先级**: P2

**核心功能**:
- 跨系统操作
- 工作流编排
- 定时执行

**示例代码**:

```typescript
// 自动化报表生成工作流
const workflow = {
  steps: [
    {
      action: 'goto',
      url: 'https://admin.example.com/login',
    },
    {
      action: 'act',
      instruction: '登录后台管理系统',
    },
    {
      action: 'goto',
      url: 'https://admin.example.com/reports/daily',
    },
    {
      action: 'act',
      instruction: '设置日期范围并生成报表',
    },
    {
      action: 'act',
      instruction: '下载报表文件',
    },
  ],
};

// 执行工作流
for (const step of workflow.steps) {
  if (step.action === 'goto') {
    await mimo.page.goto(step.url);
  } else if (step.action === 'act') {
    await mimo.act(step.instruction);
  }
}
```

---

## 测试策略

### 单元测试

**覆盖范围**:
- 所有公共 API
- 工具函数
- 类型验证

**测试框架**: Vitest

**示例**:

```typescript
// packages/@mimo/core/src/__tests__/mimo.test.ts
import { describe, it, expect, vi } from 'vitest';
import { Mimo } from '../index';

describe('Mimo', () => {
  it('should create instance', () => {
    const mimo = new Mimo({ socket: { url: 'ws://localhost:3000' } });
    expect(mimo).toBeDefined();
  });

  it('should init successfully', async () => {
    const mimo = new Mimo({ socket: { url: 'ws://localhost:3000' } });
    vi.mocked(mimo.getBus().connect).mockResolvedValue();

    await mimo.init();
    expect(mimo.getBus().connect).toHaveBeenCalled();
  });
});
```

### 集成测试

**覆盖范围**:
- API 端点
- 组件交互
- 数据流

**测试框架**: Playwright

**示例**:

```typescript
// apps/next-app/tests/integration/chat.spec.ts
import { test, expect } from '@playwright/test';

test('chat interface sends act command', async ({ page }) => {
  await page.goto('/chat');

  await page.fill('[data-testid="chat-input"]', '点击登录按钮');
  await page.click('[data-testid="send-button"]');

  await expect(page.locator('[data-testid="response"]')).toContainText('成功');
});
```

### E2E 测试

**覆盖范围**:
- 完整用户流程
- 跨应用交互

**测试框架**: Plasmo Test

**示例**:

```typescript
// apps/plasmo-app/tests/e2e/full-flow.spec.ts
import { test } from '@plasmo/test';

test('complete login flow', async ({ extension }) => {
  const page = await extension.getPage();

  await page.goto('https://example.com/login');
  await page.fill('#username', 'test@example.com');
  await page.fill('#password', 'password123');
  await page.click('#login-button');

  await expect(page.locator('.user-avatar')).toBeVisible();
});
```

### 测试覆盖率目标

| 类型 | 最低覆盖率 | 推荐覆盖率 |
|------|-----------|-----------|
| 核心包 | 80% | 90% |
| API 路由 | 70% | 85% |
| UI 组件 | 60% | 75% |

---

## 风险评估

### 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| LLM API 不稳定 | 中 | 高 | 多提供商支持、重试机制 |
| 浏览器扩展权限限制 | 中 | 中 | 权限检查、降级方案 |
| Socket.IO 连接中断 | 高 | 中 | 心跳检测、自动重连 |
| 性能瓶颈 | 中 | 中 | 请求优化、缓存策略 |

### 业务风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 用户需求变更 | 高 | 中 | 模块化设计、快速迭代 |
| 安全漏洞 | 低 | 高 | 代码审查、渗透测试 |
| 成本超支 | 中 | 中 | 成本监控、预算控制 |

### 操作风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 人员变动 | 中 | 中 | 知识文档化、结对编程 |
| 时间延期 | 中 | 中 | 里程碑管理、缓冲时间 |

---

## 里程碑检查

### Milestone 1: 基础功能可用 (Week 3)

**检查项**:
- [ ] RemotePage 5 种基础操作可用
- [ ] 元素定位器正常工作
- [ ] 标签页管理功能完成

**交付物**:
- 基础 API 文档
- 功能演示视频

---

### Milestone 2: AI 功能上线 (Week 5)

**检查项**:
- [ ] act/extract/observe 功能可用
- [ ] Chat 界面集成完成
- [ ] API 响应时间 < 3s

**交付物**:
- AI 功能文档
- 用户使用指南

---

### Milestone 3: Agent 功能可用 (Week 7)

**检查项**:
- [ ] Agent 可执行 10 步任务
- [ ] 流式执行正常工作
- [ ] 任务完成率 > 80%

**交付物**:
- Agent 配置指南
- 最佳实践文档

---

### Milestone 4: MCP 工具完成 (Week 11)

**检查项**:
- [ ] 4 个 Mimo MCP 工具可用
- [ ] 工具链编排功能完成
- [ ] 工具文档齐全

**交付物**:
- MCP 工具文档
- 工具开发指南

---

### Milestone 5: UI/UX 完善 (Week 13)

**检查项**:
- [ ] 所有界面响应式设计
- [ ] 用户操作流畅
- [ ] 错误提示友好

**交付物**:
- UI 设计规范
- 组件库文档

---

### Milestone 6: 项目完成 (Week 16)

**检查项**:
- [ ] 所有功能测试通过
- [ ] 文档完整
- [ ] 安全审计通过

**交付物**:
- 完整项目文档
- 部署指南
- 运维手册

---

## 附录

### A. 相关文档

- [00-快速开始](../00-快速开始.md)
- [01-核心概念](../01-核心概念.md)
- [02-API参考](../02-API参考.md)
- [03-使用示例](../03-使用示例.md)

### B. 代码规范

遵循项目现有的 ESLint 和 Prettier 配置。

### C. 提交规范

使用 Conventional Commits 规范：

```
feat: 新功能
fix: 修复 bug
docs: 文档更新
style: 代码格式调整
refactor: 重构
test: 测试相关
chore: 构建/工具相关
```

### D. 版本管理

采用语义化版本 (Semver)：
- MAJOR: 不兼容的 API 变更
- MINOR: 向后兼容的功能新增
- PATCH: 向后兼容的 bug 修复

---

**文档维护**: 本计划应根据实际进展每两周更新一次。
