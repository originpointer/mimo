# Mimo 核心概念

## 架构概述

Mimo 是一个浏览器自动化库，采用三层架构设计：

```
┌─────────────────────────────────────────────────────────────────┐
│                        Nitro Server                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                      Mimo Core                            │  │
│  │  ┌─────────┐  ┌──────────┐  ┌─────────┐  ┌──────────┐   │  │
│  │  │  Mimo   │──│ MimoBus  │──│  Agent  │──│   LLM    │   │  │
│  │  └─────────┘  └──────────┘  └─────────┘  └──────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                            │
                           Socket.IO
                            │
┌─────────────────────────────────────────────────────────────────┐
│                        Next App                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   Socket.IO Server                         │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                            │
                           Chrome Events
                            │
┌─────────────────────────────────────────────────────────────────┐
│                       Plasmo Extension                          │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Content Script / Background                   │  │
│  │  ┌──────────┐  ┌───────────┐  ┌──────────────────────┐   │  │
│  │  │ Browser  │──│  Page     │──│  Element Locators    │   │  │
│  │  │ Control  │  │  Actions  │  │  (CSS/XPath)         │   │  │
│  │  └──────────┘  └───────────┘  └──────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. Mimo

主类，提供浏览器自动化的统一入口。

**职责：**
- 初始化和管理整个 Mimo 系统
- 提供高层 API（act、extract、observe）
- 管理生命周期（init、close）
- 记录历史和指标

**使用示例：**
```typescript
const mimo = new Mimo({ socket: { url: 'ws://localhost:3000' } });
await mimo.init();
await mimo.act('点击登录按钮');
await mimo.close();
```

### 2. MimoBus

通信核心，负责与前端扩展进行双向通信。

**职责：**
- 建立 WebSocket 连接
- 发送命令到前端
- 接收前端事件
- 处理流式响应

**命令格式：**
```typescript
interface MimoCommand<T = any> {
  type: string;           // 命令类型
  payload: T;             // 命令数据
  options?: {
    timeout?: number;     // 超时时间
    tabId?: string;       // 标签页 ID
  };
  timestamp: number;      // 时间戳
}
```

**响应格式：**
```typescript
interface MimoResponse<T = any> {
  success: boolean;       // 是否成功
  data?: T;              // 响应数据
  error?: {
    code: string;        // 错误码
    message: string;     // 错误信息
  };
  timestamp: number;
}
```

**使用示例：**
```typescript
const bus = new MimoBus({ url: 'ws://localhost:3000' });
await bus.connect();

// 发送命令
const response = await bus.send({
  type: 'page.goto',
  payload: { url: 'https://example.com' },
  timestamp: Date.now(),
});

// 流式接收
for await (const event of await bus.sendWithStream(command)) {
  console.log(event);
}
```

### 3. RemotePage

远程页面代理，提供浏览器操作 API。

**职责：**
- 页面导航
- 元素操作
- 截图
- 执行脚本

**核心方法：**
```typescript
class RemotePage {
  // 导航
  goto(url: string, options?: NavigateOptions): Promise<void>

  // 点击
  click(selector: string, options?: ClickOptions): Promise<void>

  // 填充
  fill(selector: string, value: string): Promise<void>

  // 截图
  screenshot(options?: ScreenshotOptions): Promise<Buffer>

  // 选择器
  locator(selector: string): RemoteLocator
  deepLocator(xpath: string): RemoteDeepLocator
}
```

**使用示例：**
```typescript
const page = mimo.page;

await page.goto('https://example.com');
await page.click('#button');
await page.fill('#input', 'hello');

const screenshot = await page.screenshot({ type: 'png' });
```

### 4. RemoteLocator & RemoteDeepLocator

元素定位器，提供精确的元素定位和操作。

**RemoteLocator - CSS 选择器：**
```typescript
const locator = page.locator('.submit-button');
await locator.click();
const text = await locator.innerText();
const isVisible = await locator.isVisible();
```

**RemoteDeepLocator - XPath 定位：**
```typescript
const locator = page.deepLocator('//div[@class="product"]//span[@class="price"]');
const text = await locator.innerText();
const html = await locator.innerHTML();
```

### 5. MimoContext

浏览器上下文管理。

**职责：**
- 管理标签页
- 获取浏览器信息
- 上下文切换

**使用示例：**
```typescript
const context = mimo.context;

// 获取当前标签页
const activeTab = await context.activeTab();

// 获取所有标签页
const tabs = await context.tabs();

// 切换标签页
await context.switchToTab('tab-id');

// 关闭标签页
await context.closeTab('tab-id');
```

### 6. MimoAgent

智能代理，执行多步骤自动化任务。

**职责：**
- 观察页面状态
- 规划操作步骤
- 执行动作序列
- 处理错误和重试

**工作流程：**
```
1. 接收任务指令
       ↓
2. 观察当前页面状态
       ↓
3. 使用 LLM 决策下一步操作
       ↓
4. 执行操作
       ↓
5. 检查任务是否完成
       ↓
6. 如果未完成，返回步骤 2
       ↓
7. 返回最终结果
```

**使用示例：**
```typescript
const agent = mimo.agent({
  model: 'openai/gpt-4o-mini',
  maxSteps: 25,
});

const result = await agent.execute({
  instruction: '在亚马逊搜索商品并加入购物车',
});
```

### 7. LLMProvider

大语言模型提供商管理。

**职责：**
- 管理多个 LLM 客户端
- 统一接口调用
- 模型切换

**支持提供商：**
- OpenAI
- Anthropic
- Google Gemini
- Ollama (本地模型)
- 自定义端点

**使用示例：**
```typescript
const llmProvider = new LLMProvider();

// 获取客户端
const client = llmProvider.getClient('openai/gpt-4o-mini');

// 聊天补全
const response = await client.chatCompletion([
  { role: 'system', content: 'You are a helpful assistant.' },
  { role: 'user', content: 'Hello!' }
]);
```

## 设计模式

### 远程代理模式 (Remote Proxy)

Mimo 使用远程代理模式，将浏览器操作封装为远程对象。

```typescript
// 服务端代码
const page = mimo.page;  // RemoteProxy 实例
await page.click('#button');

// 实际执行在扩展中
// RemoteProxy 通过 MimoBus 发送命令
// 扩展接收命令并执行实际操作
```

**优点：**
- 透明的远程调用
- 统一的 API
- 易于测试和维护

### 命令模式 (Command Pattern)

所有操作封装为命令对象。

```typescript
interface MimoCommand {
  type: string;      // 操作类型
  payload: any;      // 操作数据
  options?: any;     // 选项
  timestamp: number; // 时间戳
}
```

**优点：**
- 可序列化
- 支持流式传输
- 易于日志记录

### 事件驱动 (Event-Driven)

基于 EventEmitter 的事件系统。

```typescript
mimo.on('connected', () => console.log('已连接'));
mimo.on('command.result', (data) => console.log('结果:', data));
mimo.on('error', (error) => console.error('错误:', error));
```

**支持事件：**
- `connected` - 连接建立
- `disconnected` - 连接断开
- `command.sent` - 命令已发送
- `command.result` - 命令结果
- `screenshot` - 收到截图
- `tab.changed` - 标签页变更
- `tab.closed` - 标签页关闭
- `error` - 错误发生

## 数据流

### 1. 操作执行流程

```
用户代码
  │
  ▼
Mimo.act('点击按钮')
  │
  ▼
MimoBus.send({ type: 'page.act', payload: {...} })
  │
  ▼ Socket.IO
  │
  ▼
Next App (Socket.IO Server)
  │
  ▼ Chrome Events
  │
  ▼
Plasmo Extension (Content Script)
  │
  ▼
Browser API (document.querySelector, element.click, ...)
  │
  ▼
返回结果
  │
  ▼
MimoResponse { success: true, data: {...} }
  │
  ▼
用户收到结果
```

### 2. Agent 执行流程

```
Agent.execute({ instruction: '购买商品' })
  │
  ▼
循环 (最多 maxSteps 次):
  │
  ├─► observe() - 观察页面状态
  │     │
  │     ▼
  │   获取页面文本、可操作元素列表
  │
  ├─► LLM.decide() - 决策下一步操作
  │     │
  │     ▼
  │   分析当前状态 → 选择最佳操作 → 判断任务是否完成
  │
  ├─► act() - 执行操作
  │     │
  │     ▼
  │   发送命令到前端 → 执行操作 → 返回结果
  │
  └─► 检查任务是否完成
        │
        ├─ 是 → 返回结果
        │
        └─ 否 → 继续循环
```

## 类型系统

### 核心类型

```typescript
// 操作
interface Action {
  selector?: string;
  description: string;
  method?: string;
  arguments?: string[];
}

// 操作结果
interface ActResult {
  success: boolean;
  message: string;
  actionDescription: string;
  actions: Action[];
}

// 提取结果
interface ExtractResult<T> {
  extraction: T;
  success: boolean;
  message?: string;
}

// 历史记录
interface HistoryEntry {
  method: 'act' | 'extract' | 'observe' | 'navigate' | 'agent';
  parameters: unknown;
  result: unknown;
  timestamp: string;
  commandId?: string;
  tabId?: string;
}

// 使用指标
interface MimoMetrics {
  actPromptTokens: number;
  actCompletionTokens: number;
  actInferenceTimeMs: number;
  extractPromptTokens: number;
  extractCompletionTokens: number;
  extractInferenceTimeMs: number;
  observePromptTokens: number;
  observeCompletionTokens: number;
  observeInferenceTimeMs: number;
  agentPromptTokens: number;
  agentCompletionTokens: number;
  agentInferenceTimeMs: number;
  totalPromptTokens: number;
  totalCompletionTokens: number;
  totalInferenceTimeMs: number;
}
```

### 错误类型

```typescript
// 基础错误
class MimoError extends Error {
  code?: string;
}

// 初始化错误
class MimoInitError extends MimoError {
  code = 'MIMO_INIT_ERROR';
}

// 超时错误
class MimoTimeoutError extends MimoError {
  code = 'MIMO_TIMEOUT';
  timeout: number;
}

// 未连接错误
class MimoNotConnectedError extends MimoError {
  code = 'MIMO_NOT_CONNECTED';
}

// 命令错误
class MimoCommandError extends MimoError {
  code = 'MIMO_COMMAND_ERROR';
  commandId: string;
  command: any;
}
```

## 下一步

- 查看 [API 参考](./02-API参考.md) 了解完整 API
- 浏览 [使用示例](./03-使用示例.md) 学习实际用法
