# @mimo/agent-cache 使用指南

快速开始使用 Mimo Agent 缓存优化层。

## 安装

```bash
pnpm add @mimo/agent-cache
```

## 基础用法

### 1. 创建 CacheManager

```typescript
import { CacheManager } from '@mimo/agent-cache';

// 使用默认配置
const cache = CacheManager.create();

// 自定义配置
const cache = CacheManager.create({
    namespace: 'my-app',
    defaultTTL: 3600000, // 1小时
});
```

### 2. Token 追踪

```typescript
// 追踪 Token 使用
const record = await cache.tokenTracker.track('claude-3-5-sonnet', {
    promptTokens: 1000,
    completionTokens: 500,
    totalTokens: 1500,
    cachedReadTokens: 100, // Anthropic 缓存读取
});

console.log(`成本: $${record.costs.totalCost.toFixed(6)}`);
// 成本: $0.009000

// 获取统计
const stats = await cache.getStats();
console.log(stats);
// {
//     tokenTracking: { totalCost: 0.009, totalTokens: 1500, recordCount: 1 },
//     agentCache: { hitCount: 0, missCount: 0, replayCount: 0, entryCount: 0 }
// }
```

### 3. Agent 缓存

```typescript
// 构建缓存键
const key = cache.agentCache.buildKey('登录 GitHub', {
    instruction: '在 GitHub 上登录',
    model: 'claude-3-5-sonnet',
    tools: ['browser_click', 'browser_fill'],
});
// 注意：buildKey 返回的是“逻辑 key”（不包含 namespace 前缀），可直接用于 save/get/replay。

// 保存执行结果
await cache.agentCache.save(key, execution, {
    ttl: 86400000,  // 24小时
    prune: true,     // 自动剪枝大体积数据
});

// 获取缓存
const cached = await cache.agentCache.get(key);
if (cached) {
    console.log('缓存命中！');
}
```

## 使用场景

### 场景 1: LLM 调用成本追踪

```typescript
import { LLMClient } from '@mimo/llm';
import { CacheManager } from '@mimo/agent-cache';

const cache = CacheManager.create();
const client = new LLMClient('claude-3-5-sonnet');

async function chat(message: string) {
    const response = await client.complete({
        messages: [{ role: 'user', content: message }],
    });

    // 自动追踪成本
    const record = await cache.tokenTracker.track(
        client.model,
        response.usage
    );

    return response;
}
```

### 场景 2: Agent 执行缓存

```typescript
async function executeAgent(instruction: string) {
    const key = cache.agentCache.buildKey(instruction, {
        instruction,
        model: 'claude-3-5-sonnet',
        tools: ['browser_click', 'browser_fill'],
    });

    // 尝试从缓存获取
    const cached = await cache.agentCache.get(key);
    if (cached) {
        console.log('使用缓存结果');
        return cached.result;
    }

    // 执行 Agent
    const result = await runAgent(instruction);

    // 保存到缓存
    await cache.agentCache.save(key, {
        version: 1,
        key,
        instruction,
        startUrl: window.location.href,
        options: { instruction, model: 'claude-3-5-sonnet', tools: [] },
        configSignature: 'abc123',
        steps: result.steps,
        result,
        timestamp: Date.now(),
    });

    return result;
}
```

### 场景 3: 使用插件

```typescript
import { CacheManager, createLoggingPlugin } from '@mimo/agent-cache';

const cache = CacheManager.create({}, {
    plugins: [createLoggingPlugin({ logLevel: 'debug' })],
});

// 所有操作都会被自动记录
await cache.tokenTracker.track('claude-3-5-sonnet', usage);
// [Cache] Token tracked: claude-3-5-sonnet - $0.009000
```

### 场景 4: 文件系统持久化

```typescript
import { CacheManager } from '@mimo/agent-cache';
import { FileSystemStore } from '@mimo/agent-cache/storage';

const cache = CacheManager.create(
    { namespace: 'my-app' },
    {
        tokenStore: new FileSystemStore({
            rootDir: './cache',
            subdir: 'token',
        }),
        agentStore: new FileSystemStore({
            rootDir: './cache',
            subdir: 'agent',
        }),
    }
);

// 缓存会持久化到磁盘
```

## 下一步

- [Token 追踪详细说明](./01-Token追踪.md)
- [Agent 缓存详细说明](./02-Agent缓存.md)
- [存储后端配置](./03-存储后端.md)
- [Hook 与插件开发](./04-Hook与插件.md)
- [API 参考](./05-API参考.md)
